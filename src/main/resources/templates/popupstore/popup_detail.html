<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${popup.title} + ' - íŒì—… ìƒì„¸ - ë”ì¿ ì¿ '">íŒì—… ìƒì„¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/home.css}">

    <!-- ğŸ”¹ ë„¤ì´ë²„ ì§€ë„ SDK (geocoder í¬í•¨) -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        // ì¸ì¦ ì‹¤íŒ¨ì‹œ ì•Œë¦¼ (Authentication Failed (200) ë””ë²„ê¹…ìš©)
        window.navermap_authFailure = () =>
            alert('ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨: NCP ì½˜ì†” URL/Key í™•ì¸ (NCP Web ì„œë¹„ìŠ¤ URL í—ˆìš©ëª©ë¡ ì ê²€)');
    </script>

    <style>
        .page {
            max-width: 960px;
            margin: 0 auto;
            padding: 16px;
        }

        .back-link {
            font-size: 12px;
            color: #6b7280;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 10px;
        }

        .popup-detail-card {
            border-radius: 18px;
            background: #ffffff;
            box-shadow: 0 4px 16px rgba(15,23,42,0.06);
            padding: 16px 18px 20px;
        }

        .popup-banner {
            width: 100%;
            height: 220px;
            border-radius: 16px;
            background: #e5e7eb;
            object-fit: cover;
            margin-bottom: 14px;
        }

        .popup-detail-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .popup-detail-location,
        .popup-detail-date {
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 4px;
        }

        .popup-detail-subtitle {
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 6px;
        }

        .popup-detail-text {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
        }

        .popup-detail-map {
            width: 100%;
            height: 240px;
            background: #d1d5db;
            border-radius: 12px;
            margin-top: 8px;
            overflow: hidden;
        }
    </style>
</head>

<body>
<div class="page">

    <!-- ë’¤ë¡œê°€ê¸° -->
    <a th:href="@{/popupstore/list.do(page=1,pageLimit=20,sort='createAt')}" class="back-link">
        â† íŒì—…ìŠ¤í† ì–´ ëª©ë¡
    </a>

    <article class="popup-detail-card">

        <!-- ë°°ë„ˆ ì´ë¯¸ì§€ -->
        <img class="popup-banner"
             th:src="${popup.bannerImageUrl != null} ? ${popup.bannerImageUrl} : @{/images/default-popup.jpg}"
             alt="íŒì—… ë°°ë„ˆ ì´ë¯¸ì§€">

        <!-- ì œëª© -->
        <h1 class="popup-detail-title" th:text="${popup.title}">íŒì—… ì œëª©</h1>

        <!-- ì¥ì†Œ -->
        <div class="popup-detail-location"
             th:text="${popup.placeName != null ? popup.placeName : popup.regionName}">
            ì¥ì†Œëª…
        </div>

        <!-- ì£¼ì†Œ -->
        <div class="popup-detail-location" th:text="${popup.address}">
            ì£¼ì†Œ
        </div>

        <!-- ê¸°ê°„ -->
        <div class="popup-detail-date"
             th:text="|${popup.startDate} ~ ${popup.endDate}|">
        </div>

        <!-- ì„¤ëª… -->
        <h2 class="popup-detail-subtitle">íŒì—… ì†Œê°œ</h2>
        <p class="popup-detail-text" th:text="${popup.description}">
            ì„¤ëª… í…ìŠ¤íŠ¸
        </p>

        <!-- ìœ„ì¹˜ + ì§€ë„ -->
        <h2 class="popup-detail-subtitle">ìœ„ì¹˜</h2>
        <p class="popup-detail-text" th:text="${popup.address}"></p>

        <!-- ğŸ”¹ ì—¬ê¸° ì•ˆì— ë„¤ì´ë²„ ì§€ë„ ë Œë”ë§ -->
        <div id="popupMap" class="popup-detail-map"></div>

    </article>

</div>

<!-- ğŸ”¹ íŒì—… ì£¼ì†Œ 1ê°œë§Œ ë„¤ì´ë²„ ì§€ë„ì— í‘œì‹œ -->
<script th:inline="javascript">
    window.addEventListener('load', function () {
        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ íŒì—… ì£¼ì†Œ / ì¥ì†Œëª… ê°€ì ¸ì˜¤ê¸°
        const address   = /*[[${popup.address}]]*/ '';
        const placeName = /*[[${popup.placeName != null ? popup.placeName : popup.title}]]*/ '';

        if (!address) {
            console.warn('popup.address ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        // geocoder ë¡œ ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜
        naver.maps.Service.geocode(
            { query: address },
            function (status, response) {
                if (status !== naver.maps.Service.Status.OK ||
                    !response.v2 ||
                    !response.v2.addresses ||
                    response.v2.addresses.length === 0) {

                    console.warn('ë„¤ì´ë²„ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨', status, response);
                    return;
                }

                const addr = response.v2.addresses[0];
                const lat  = parseFloat(addr.y);
                const lng  = parseFloat(addr.x);

                const map = new naver.maps.Map('popupMap', {
                    center: new naver.maps.LatLng(lat, lng),
                    zoom: 16,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: naver.maps.Position.TOP_RIGHT
                    }
                });

                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(lat, lng),
                    map: map,
                    title: placeName || address
                });

                const info = new naver.maps.InfoWindow({
                    content: `
                        <div style="padding:8px 10px;font-size:12px;">
                            <div style="font-weight:600;">${placeName || 'íŒì—… ìœ„ì¹˜'}</div>
                            <div style="color:#4b5563;margin-top:2px;">${address}</div>
                        </div>
                    `
                });

                info.open(map, marker);
            }
        );
    });
</script>

</body>
</html>
