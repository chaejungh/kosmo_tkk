<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/tkk_fragment/layout}">

<head>
    <th:block layout:fragment="head"></th:block>
</head>

<body>
<div layout:fragment="content"
     th:with="
        today=${T(java.time.LocalDate).now()},
        s=${popup.startDate},
        e=${popup.endDate},
        stateKey=${(s != null and today.isBefore(s)) ? 'UPCOMING' : ((e != null and today.isAfter(e)) ? 'ENDED' : 'ONGOING')},
        stateLabel=${stateKey == 'UPCOMING' ? '예정' : (stateKey == 'ENDED' ? '종료' : '진행중')},
        query=${(popup.placeName != null ? popup.placeName : '') + ' ' + (popup.address != null ? popup.address : '')}
     ">

    <a class="popup-back" th:href="@{/popupstore/list.do}">← 돌아가기</a>

    <section class="popup-detail">

        <!-- 상단 메인 이미지 -->
        <div class="popup-hero"
             th:style="${popup.bannerImageUrl != null}
                ? |background-image:url('${popup.bannerImageUrl}');|
                : ''">
        </div>

        <div class="popup-head">
            <div class="popup-head-left">

                <!-- ✅ status 필드 없이 날짜로 계산 -->
                <span class="popup-status-pill"
                      th:classappend="${stateKey} == 'ONGOING' ? ' ongoing' : (${stateKey} == 'UPCOMING' ? ' upcoming' : ' ended')">
                    <span class="popup-dot"></span>
                    <span th:text="${stateLabel}">진행중</span>
                </span>

                <h1 class="popup-title" th:text="${popup.title}">팝업 제목</h1>

                <p class="popup-desc"
                   th:text="${popup.description != null ? popup.description : '소개글이 준비중입니다.'}">
                    소개글이 들어옵니다.
                </p>
            </div>

            <div class="popup-head-right">
                <button class="popup-icon-btn" type="button" id="shareBtn" title="공유">⤴</button>
            </div>
        </div>

        <div class="popup-grid-2">

            <!-- LEFT -->
            <div class="popup-left">

                <div class="popup-info-grid">
                    <div class="popup-info-card">
                        <div class="label">운영 기간</div>
                        <div class="value"
                             th:text="|${popup.startDate != null ? #temporals.format(popup.startDate,'yyyy.MM.dd') : '미정'} - ${popup.endDate != null ? #temporals.format(popup.endDate,'yyyy.MM.dd') : '미정'}|">
                            2025.01.01 - 2025.02.01
                        </div>
                    </div>

                    <div class="popup-info-card">
                        <div class="label">장소명</div>
                        <div class="value" th:text="${popup.placeName != null ? popup.placeName : '-'}">장소명</div>
                    </div>

                    <div class="popup-info-card">
                        <div class="label">주소</div>
                        <div class="value" th:text="${popup.address != null ? popup.address : '-'}">서울 어딘가</div>
                    </div>

                    <div class="popup-info-card">
                        <div class="label">지역</div>
                        <div class="value" th:text="${popup.regionName != null ? popup.regionName : '-'}">지역</div>
                    </div>
                </div>

                <!-- CTA -->
                <div class="popup-cta-row">
                    <!-- ✅ urlEncode 없이 안전하게: 검색 쿼리 그대로 -->
                    <a class="popup-cta pink"
                       target="_blank" rel="noopener"
                       th:href="|https://map.naver.com/v5/search/${query}|">
                        길찾기
                    </a>

                    <a class="popup-cta dark"
                       th:href="@{/popupstore/list.do}">
                        목록으로
                    </a>
                </div>

                <!-- 굿즈 목록 -->
                <div class="card popup-box" style="margin-top:16px;">
                    <div class="popup-box-title">굿즈 목록</div>

                    <div th:if="${goodsList == null or #lists.isEmpty(goodsList)}"
                         style="color:#6b7280; font-weight:800; padding:8px 0;">
                        등록된 굿즈가 아직 없어요.
                    </div>

                    <ul class="popup-bullets" th:if="${goodsList != null and !#lists.isEmpty(goodsList)}">
                        <li th:each="g : ${goodsList}">
                            <span th:text="${g.name}">굿즈명</span>
                            <span th:if="${g.price != null}" th:text="| · ${g.price}원|"></span>
                        </li>
                    </ul>
                </div>

            </div>

            <!-- RIGHT -->
            <aside class="popup-right">

                <div class="card popup-notice">
                    <div class="popup-notice-head">⚠ 방문 전 확인사항</div>
                    <ul class="popup-bullets">
                        <li>현장 대기 시간이 길 수 있어요. 평일 방문 추천!</li>
                        <li>일부 현장 상품은 조기 품절될 수 있어요.</li>
                        <li>촬영 가능/불가 규정은 현장 안내를 확인해 주세요.</li>
                    </ul>
                </div>

                <div class="card popup-map">
                    <div class="popup-map-ico">📍</div>
                    <div class="popup-map-title">지도 미리보기</div>

                    <div class="popup-map-box"
                         id="popupMapPreview"
                         th:attr="data-lat=${popup.latitude},data-lng=${popup.longitude}">
                    </div>

                    <a class="popup-map-link"
                       target="_blank" rel="noopener"
                       th:href="|https://map.naver.com/v5/search/${query}|">
                        네이버 지도에서 보기
                    </a>
                </div>

            </aside>

        </div>

    </section>

</div>

<th:block layout:fragment="script">
    <script>
        document.getElementById('shareBtn')?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(location.href);
                alert('링크가 복사됐어요!');
            } catch (e) {
                prompt('링크 복사:', location.href);
            }
        });
    </script>
</th:block>

</body>
</html>