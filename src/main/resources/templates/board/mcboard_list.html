<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">
<head></head>
<body>

<div layout:fragment="content">
    <main>

        <section class="card board-header-card">
            <div class="segmented-control">
                <button class="seg-btn active"
                        type="button"
                        th:onclick="|location.href='@{/mcboard/list.do}'|">내 새끼 자랑</button>
                <button class="seg-btn"
                        type="button"
                        th:onclick="|location.href='@{/cosplayboard/list.do}'|">
                    코스프레
                </button>
                <button class="seg-btn"
                        type="button"
                        th:onclick="|location.href='@{/freeboard/list.do}'|">자유게시판</button>
            </div>

            <div class="board-search-row">
                <form method="post" th:action="@{/mcboard/list.do}">
                    <div class="board-search-box">
                        <input class="col-7 form-control"
                               name="search"
                               type="text"
                               placeholder="통합 검색 (제목, 닉네임)"
                               th:value="${search}"
                                >
                        <button class="col-1 btn btn-outline-primary d-flex align-items-center justify-content-center" type="submit">
                            <span class="board-search-icon me-1">🔍</span>
                        </button>
                    </div>
                </form>

                <!-- ▶▶ 아이콘 기능 추가된 부분 ◀◀ -->
                <div class="search-actions">
                    <button id="viewListBtn" class="icon-btn active">☰</button>
                    <button id="viewPhotoBtn" class="icon-btn">▢</button>
                    <button id="sortBtn" class="icon-btn">⇅</button>

                    <!-- 🔥 정렬 메뉴를 search-actions 안으로 이동 -->
                    <div id="sortMenu" class="sort-menu hidden">
                        <div class="sort-option"
                             data-sort="latest"
                             th:classappend="${sortType} == 'latest'? 'active': ''">
                            최신순</div>
                        <div class="sort-option"
                             data-sort="popular"
                             th:classappend="${sortType} == 'popular'? 'active': ''"
                        >인기순</div>
                    </div>
                </div>




                <!-- PC에서는 오른쪽 끝에 -->
                <div class="desktop-write-btn">

                    <!-- ✅ 로그인 상태: 내 memberId 로 글쓰기 페이지 -->
                    <button class="btn-primary btn-sm"
                            th:if="${memberId != null}"
                            th:onclick="|location.href='@{/board/{memberId}/write(memberId=${memberId})}'|">
                        + 글쓰기
                    </button>

                    <!-- ✅ 비로그인 상태: 권한 없음 안내 페이지로 이동 -->
                    <button class="btn-primary btn-sm"
                            th:if="${memberId == null}"
                            th:onclick="|location.href='@{/board/not-allowed}'|">
                        + 글쓰기
                    </button>
                </div>
            </div>
        </section>

        <!-- 🔥 인기글 TOP5 -->
        <section class="card hot-posts-card"
                 th:if="${not #lists.isEmpty(hotCurrentBoard) or not #lists.isEmpty(hotAllBoard)}">

            <div class="hot-posts-grid">

                <!-- 왼쪽: 현재 게시판 인기글 -->
                <div class="hot-posts-col">
                    <div class="hot-posts-col-header">
                        <div class="hot-posts-title">이 게시판 인기글</div>
                        <div class="hot-posts-subtabs">
                            <span class="hot-subtab active">오늘 BEST</span>
                        </div>
                    </div>

                    <ul class="hot-posts-list">
                        <li class="hot-post-item"
                            th:each="post : ${hotCurrentBoard}">
                                <span class="hot-post-label d-inline d-md-none"
                                      th:text="${#strings.length(post.category.name) > 4
                                            ? #strings.substring(post.category.name, 0, 4) + '...'
                                            : post.category.name}">
                                </span>
                                <span class="hot-post-label d-none d-md-inline"
                                        th:text="${post.category.name}">

                                </span>


                            <a class="hot-post-link"
                                th:href="${memberId} == null ? @{/board/not-allowed} :
                                        @{/mcboard/{memberId}/article/{postId}/detail.do(
                                        memberId=${memberId},
                                        postId=${post.id})}">
                                <span class="hot-post-title d-inline d-md-none"
                                      th:text="${#strings.length(post.title) > 10
                                                ? #strings.substring(post.title, 0, 10) + '...'
                                                : post.title}">
                                </span>
                                <span class="hot-post-title d-none d-md-inline"
                                            th:text="${post.title}">
                                </span>
                                <span class="hot-post-comments"
                                      th:text="'['  +2+ ']'">[0]</span>
                            </a>
                        </li>

                        <li class="hot-post-empty"
                            th:if="${#lists.isEmpty(hotCurrentBoard)}">
                            이 게시판의 인기글이 없습니다.
                        </li>
                    </ul>
                </div>

                <!-- 오른쪽: 전체 게시판 인기글 -->
                <div class="hot-posts-col">
                    <div class="hot-posts-col-header">
                        <div class="hot-posts-title">전체 게시판 인기글</div>
                        <div class="hot-posts-subtabs">
                            <span class="hot-subtab active">오늘 BEST</span>
                        </div>
                    </div>

                    <ul class="hot-posts-list">
                        <li class="hot-post-item"
                            th:each="post : ${hotAllBoard}">
                            <span class="hot-post-label d-inline d-md-none"
                                  th:text="${#strings.length(post.category.name) > 4
                                            ? #strings.substring(post.category.name, 0, 4) + '...'
                                            : post.category.name}">
                                </span>
                            <span class="hot-post-label  d-none d-md-inline"
                                  th:text="${post.category.name}">

                                </span>

                            <a class="hot-post-link"
                               th:href="${memberId} == null ? @{/board/not-allowed} :
                                        @{/mcboard/{memberId}/article/{postId}/detail.do(
                                        memberId=${memberId},
                                        postId=${post.id})}">
                                <span class="hot-post-title d-inline d-md-none"
                                      th:text="${#strings.length(post.title) > 10
                                                ? #strings.substring(post.title, 0, 10) + '...'
                                                : post.title}">
                                </span>
                                <span class="hot-post-title d-none d-md-inline"
                                      th:text="${post.title}">
                                </span>
                                <span class="hot-post-comments"
                                      th:text="'[' + 2 + ']'">[0]</span>
                            </a>
                        </li>

                        <li class="hot-post-empty"
                            th:if="${#lists.isEmpty(hotAllBoard)}">
                            전체 게시판 인기글이 없습니다.
                        </li>
                    </ul>
                </div>

            </div>
        </section>
        <!-- 게시글 리스트 (원본 그대로) -->
        <!-- 절대 수정 안 했음 -->
<!--        <ul>-->
<!--            <li>현재페이지<b th:text="${posts.number}"></b></li>-->
<!--            <li>전체페이지<b th:text="${posts.totalPages}"></b></li>-->
<!--            <li>1?<b th:text="${posts.isFirst()}"></b></li>-->
<!--            <li>마지막?<b th:text="${posts.isLast()}"></b></li>-->
<!--            <li>한페이지에 출력되는 로우<b th:text="${posts.size}"></b></li>-->
<!--            <li>정렬<b th:text="${posts.sort}"></b></li>-->
<!--        </ul>-->
        <!-- ===== 게시글 리스트 카드 ===== -->
        <section class="card">

            <!-- 게시글 리스트 -->
            <ul id="postList" class="post-list" th:if="${not #lists.isEmpty(posts)}">
                <li class="post-card"
                    th:each="post : ${posts.content}"
                    th:attr="data-post-id=${post.id}">
                    <!-- 썸네일 -->
                    <div class="post-thumb-box">
                        <span th:if="${post.thumbnailUrl == null}">IMAGE</span>
                        <img th:if="${post.thumbnailUrl != null}"
                             th:src="@{${post.thumbnailUrl}}"
                             alt="썸네일"
                             style="width:100%; height:100%; object-fit:cover;">
                    </div>

                    <div class="post-main">
                        <div>
                            <!-- 제목 -->
                            <h3 class="post-title"
                                th:text="${post.title}">
                                오늘 영업당한 내 최애 포카 자랑합니다 🥹
                            </h3>

                            <!-- 내용 요약 (content 앞부분 자르기) -->
                            <p class="post-excerpt"
                               th:text="${#strings.abbreviate(post.content, 40)}">
                                오늘 영업당한 내 최애 포카 자랑 글이에요...
                            </p>

                            <!-- 태그는 나중에 DTO로 합쳐도 되고, 일단은 임시 -->
                            <p class="post-tag">
                                <!-- 예시: 나중에 post.tagSummary 같은 필드 만들면 그걸 쓰면 됨 -->
                                <span th:text="${post.category.name}">#카테고리</span>
                            </p>

                            <!-- 닉네임 · 작성일 -->
                            <p class="post-meta-top">
                                <span th:text="${post.member.nickname}">닉네임</span>
                                ·
                                <span th:text="${#temporals.format(post.createdAt,'yyyy.MM.dd')}">
                            3분 전
                        </span>
                            </p>
                        </div>

                        <div class="post-meta-bottom">
                            <!-- ❤️좋아요 · 💬댓글수 · 👀조회수 -->
                            <div class="post-stats">
                                ❤️<span th:text="${post.likeCount}">108</span>
                                ·💬
                                <span th:text="${post.commentCount}">0</span>
                                · 👀<span th:text="${post.viewCount}">1,024</span>
                            </div>
                            <!-- 카테고리명 -->
                            <div th:text="${post.category.name}">
                                내 새끼 자랑
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

            <!-- 글이 하나도 없을 때 -->
            <p th:if="${#lists.isEmpty(posts)}" style="text-align:center; margin-top:40px;">
                등록된 게시글이 없습니다.
            </p>
        </section>
        <nav class="d-flex justify-content-end align-items-center gap-2 mt-3">
            <select class="form-select form-select-sm w-auto"
                    onchange="location.href='?page=0&size=' + this.value;">
                <option disabled selected>보기</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="40">40</option>
            </select>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=5)}">5</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=10)}">10</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=20)}">20</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=40)}">40</a>
        </nav>
        <div th:with="
        page=${posts.number},
        last=${posts.totalPages},
        sort=${posts.sort},
        size=${param.size}"
             class="my-4 d-flex justify-content-center">
            <nav
                    th:with="  start=${ page - 2 < 0 ? 0 : page - 2 },
                                end=${ page + 3 > last ? last : page + 3 }"
            >
                <ul class="pagination">
                    <li class="page-item"
                        th:classappend="${page}==0 ? 'disabled' : '' ">
                        <a th:href="@{'?'(page=0,size=${size})}" class="page-link">start</a>
                    </li>
                    <li  th:each="i : ${#numbers.sequence(start+1,end)}"
                         th:classappend="( (${i}-1)==${page}?'active' )"
                         class="page-item">
                        <a th:href="@{'?'(page=(${i}-1), size=${size})}" class="page-link" th:text="${i}" > </a>
                    </li>
                    <li class="page-item"
                        th:classappend="${page}==(${last}-1) ? 'disabled' : '' ">
                        <a th:href="@{'?'(page=${last}-1,size=${size})}" class="page-link">last</a>
                    </li>
                </ul>
            </nav>
        </div>
    </main>
</div>
<!-- 모바일 전용 플로팅 버튼 -->
<button class="floating-write-btn"
        th:if="${memberId != null}"
        th:onclick="|location.href='@{/board/{memberId}/write(memberId=${memberId})}'|">＋
</button>
<!-- ✅ 비로그인 상태: 권한 없음 안내 페이지로 이동 -->
<button class="floating-write-btn"
        th:if="${memberId == null}"
        th:onclick="|location.href='@{/board/not-allowed}'|">＋
</button>

<script th:inline="javascript" layout:fragment="script">


    const postList = document.getElementById("postList");
    const viewListBtn = document.getElementById("viewListBtn");
    const viewPhotoBtn = document.getElementById("viewPhotoBtn");

    // 타임리프에서 memberId 값을 JS 변수로 주입
    const memberId = /*[[${memberId}]]*/ 0;

    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', () => {
            const postId = card.dataset.postId;
            // 원하는 URL 패턴에 맞게 수정해서 사용
            // 예) /mcboard/{memberId}/{postId}/detail.do
            // th:if="${memberId == null}"
            //     th:onclick="|location.href='@{/board/not-allowed}'|"
            if (memberId == null){//비회원이면 조회불가
                const url = `/board/not-allowed`;
                window.location.href = url;
                return;
            }
            const url = `/mcboard/${memberId}/article/${postId}/detail.do`;
            window.location.href = url;
        });
    });
    /* 리스트 보기 */
    viewListBtn.onclick = () => {
        postList.classList.remove("photo-view");
        viewListBtn.classList.add("active");
        viewPhotoBtn.classList.remove("active");
    };

    /* 사진 보기 */
    viewPhotoBtn.onclick = () => {
        postList.classList.add("photo-view");
        viewPhotoBtn.classList.add("active");
        viewListBtn.classList.remove("active");
    };

    /* ===== 정렬 메뉴 기능 ===== */
    const sortBtn = document.getElementById("sortBtn");      // 아이콘 버튼
    const sortMenu = document.getElementById("sortMenu");    // 메뉴 박스
    const sortOptions = document.querySelectorAll(".sort-option");

    // 정렬 버튼 클릭 → 메뉴 열기/닫기
    sortBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sortMenu.classList.toggle("hidden");
    });

    // 정렬 옵션 클릭 → 메뉴 닫기 + 적용
    sortOptions.forEach(option => {
        option.addEventListener("click", () => {
            sortOptions.forEach(o => o.classList.remove("active"));
            option.classList.add("active");

            sortMenu.classList.add("hidden");

            console.log("정렬:", option.dataset.sort);
        });
    });

    // 화면 클릭하면 닫힘
    document.addEventListener("click", () => {
        sortMenu.classList.add("hidden");
    });

    document.addEventListener('DOMContentLoaded', () => {
        bindSortChange();
    });

    function bindSortChange() { // 페이지 정렬 (최신순, 인기순)
        const sortOptions = document.querySelectorAll('#sortMenu .sort-option');

        sortOptions.forEach(option => {
            option.addEventListener('click', () => {
                const sortType = option.dataset.sort; // "latest" or "popular"
                const url = new URL(window.location.href);

                // ✅ Spring Pageable이 이해하는 sort 파라미터로 변환
                if (sortType === 'latest') {
                    // createdAt 기준 최신순
                    url.searchParams.set('sort', 'createdAt,desc');
                } else if (sortType === 'popular') {
                    // likeCount 기준 인기순
                    url.searchParams.set('sort', 'likeCount,desc');
                }

                // 페이지는 0부터 시작
                url.searchParams.set('page', 0);

                window.location.href = url.toString();
            });
        });
    }

</script>
</body>
</html>