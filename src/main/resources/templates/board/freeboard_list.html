<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">
<head></head>
<body>

<div layout:fragment="content">
    <main>

        <section class="card board-header-card">
            <div class="segmented-control">
                <button class="seg-btn"
                        type="button"
                        th:onclick="|location.href='@{/mcboard/list.do}'|">ë‚´ ìƒˆë¼ ìë‘</button>
                <button class="seg-btn"
                        type="button"
                        th:onclick="|location.href='@{/cosplayboard/list.do}'|">
                    ì½”ìŠ¤í”„ë ˆ
                </button>
                <button class="seg-btn active"
                        type="button"
                        th:onclick="|location.href='@{/freeboard/list.do}'|">ììœ ê²Œì‹œíŒ</button>
            </div>

                <!-- â–¶â–¶ ì•„ì´ì½˜ ê¸°ëŠ¥ ì¶”ê°€ëœ ë¶€ë¶„ â—€â—€ -->
                <div class="board-search-row">
                    <form method="post" th:action="@{/freeboard/list.do}">
                        <div class="board-search-box">
                            <input class="col-7 form-control"
                                   name="search"
                                   type="text"
                                   placeholder="í†µí•© ê²€ìƒ‰ (ì œëª©, ë‹‰ë„¤ì„)"
                                   th:value="${search}"
                            >
                            <button class="col-1 btn btn-outline-primary d-flex align-items-center justify-content-center" type="submit">
                                <span class="board-search-icon me-1">ğŸ”</span>
                            </button>
                        </div>
                    </form>

                    <!-- â–¶â–¶ ì•„ì´ì½˜ ê¸°ëŠ¥ ì¶”ê°€ëœ ë¶€ë¶„ â—€â—€ -->
                    <div class="search-actions">
                        <button id="viewListBtn" class="icon-btn active">â˜°</button>
                        <button id="viewPhotoBtn" class="icon-btn">â–¢</button>
                        <button id="sortBtn" class="icon-btn">â‡…</button>

                        <!-- ğŸ”¥ ì •ë ¬ ë©”ë‰´ë¥¼ search-actions ì•ˆìœ¼ë¡œ ì´ë™ -->
                        <div id="sortMenu" class="sort-menu hidden">
                            <div class="sort-option"
                                 data-sort="latest"
                                 th:classappend="${sortType} == 'latest'? 'active': ''">
                                ìµœì‹ ìˆœ</div>
                            <div class="sort-option"
                                 data-sort="popular"
                                 th:classappend="${sortType} == 'popular'? 'active': ''"
                            >ì¸ê¸°ìˆœ</div>
                        </div>
                    </div>
                    <!-- PCì—ì„œëŠ” ì˜¤ë¥¸ìª½ ëì— -->
                    <div class="desktop-write-btn">

                        <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ: ë‚´ memberId ë¡œ ê¸€ì“°ê¸° í˜ì´ì§€ -->
                        <button class="btn-primary btn-sm"
                                th:if="${memberId != null}"
                                th:onclick="|location.href='@{/board/{memberId}/write(memberId=${memberId})}'|">
                            + ê¸€ì“°ê¸°
                        </button>

                        <!-- âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ê¶Œí•œ ì—†ìŒ ì•ˆë‚´ í˜ì´ì§€ë¡œ ì´ë™ -->
                        <button class="btn-primary btn-sm"
                                th:if="${memberId == null}"
                                th:onclick="|location.href='@{/board/not-allowed}'|">
                            + ê¸€ì“°ê¸°
                        </button>
                    </div>
                </div>
        </section>

        <!-- ğŸ”¥ ì¸ê¸°ê¸€ TOP5 -->
        <section class="card hot-posts-card"
                 th:if="${not #lists.isEmpty(hotCurrentBoard) or not #lists.isEmpty(hotAllBoard)}">

            <div class="hot-posts-grid">

                <!-- ì™¼ìª½: í˜„ì¬ ê²Œì‹œíŒ ì¸ê¸°ê¸€ -->
                <div class="hot-posts-col">
                    <div class="hot-posts-col-header">
                        <div class="hot-posts-title">ì´ ê²Œì‹œíŒ ì¸ê¸°ê¸€</div>
                        <div class="hot-posts-subtabs">
                            <span class="hot-subtab active">ì˜¤ëŠ˜ BEST</span>
                        </div>
                    </div>

                    <ul class="hot-posts-list">
                        <li class="hot-post-item"
                            th:each="post : ${hotCurrentBoard}">
                                <span class="hot-post-label d-inline d-md-none"
                                      th:text="${#strings.length(post.category.name) > 4
                                            ? #strings.substring(post.category.name, 0, 4) + '...'
                                            : post.category.name}">
                                </span>
                            <span class="hot-post-label d-none d-md-inline"
                                  th:text="${post.category.name}">

                                </span>


                            <a class="hot-post-link"
                               th:href="${memberId} == null ? @{/board/not-allowed} :
                                        @{/freeboard/{memberId}/article/{postId}/detail.do(
                                        memberId=${memberId},
                                        postId=${post.id})}">
                                <span class="hot-post-title d-inline d-md-none"
                                      th:text="${#strings.length(post.title) > 10
                                                ? #strings.substring(post.title, 0, 10) + '...'
                                                : post.title}">
                                </span>
                                <span class="hot-post-title d-none d-md-inline"
                                      th:text="${post.title}">
                                </span>
                                <span class="hot-post-comments"
                                      th:text="'['  +2+ ']'">[0]</span>
                            </a>
                        </li>

                        <li class="hot-post-empty"
                            th:if="${#lists.isEmpty(hotCurrentBoard)}">
                            ì´ ê²Œì‹œíŒì˜ ì¸ê¸°ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                        </li>
                    </ul>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì „ì²´ ê²Œì‹œíŒ ì¸ê¸°ê¸€ -->
                <div class="hot-posts-col">
                    <div class="hot-posts-col-header">
                        <div class="hot-posts-title">ì „ì²´ ê²Œì‹œíŒ ì¸ê¸°ê¸€</div>
                        <div class="hot-posts-subtabs">
                            <span class="hot-subtab active">ì˜¤ëŠ˜ BEST</span>
                        </div>
                    </div>

                    <ul class="hot-posts-list">
                        <li class="hot-post-item"
                            th:each="post : ${hotAllBoard}">
                            <span class="hot-post-label d-inline d-md-none"
                                  th:text="${#strings.length(post.category.name) > 4
                                            ? #strings.substring(post.category.name, 0, 4) + '...'
                                            : post.category.name}">
                                </span>
                            <span class="hot-post-label  d-none d-md-inline"
                                  th:text="${post.category.name}">

                                </span>

                            <a class="hot-post-link"
                               th:href="${memberId} == null ? @{/board/not-allowed} :
                                        @{/mcboard/{memberId}/article/{postId}/detail.do(
                                        memberId=${memberId},
                                        postId=${post.id})}">
                                <span class="hot-post-title d-inline d-md-none"
                                      th:text="${#strings.length(post.title) > 10
                                                ? #strings.substring(post.title, 0, 10) + '...'
                                                : post.title}">
                                </span>
                                <span class="hot-post-title d-none d-md-inline"
                                      th:text="${post.title}">
                                </span>
                                <span class="hot-post-comments"
                                      th:text="'[' + 2 + ']'">[0]</span>
                            </a>
                        </li>

                        <li class="hot-post-empty"
                            th:if="${#lists.isEmpty(hotAllBoard)}">
                            ì „ì²´ ê²Œì‹œíŒ ì¸ê¸°ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                        </li>
                    </ul>
                </div>

            </div>
        </section>

        <!-- ===== ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ===== -->
        <section class="card">

            <!-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ -->
            <ul class="post-list" th:if="${not #lists.isEmpty(posts)}">
                <li class="post-card"
                    th:each="post : ${posts}"
                    th:attr="data-post-id=${post.id}">
                    <!-- ì¸ë„¤ì¼ -->
                    <div class="post-thumb-box">
                        <span th:if="${post.thumbnailUrl == null}">IMAGE</span>
                        <img th:if="${post.thumbnailUrl != null}"
                             th:src="@{${post.thumbnailUrl}}"
                             alt="ì¸ë„¤ì¼"
                             style="width:100%; height:100%; object-fit:cover;">
                    </div>

                    <div class="post-main">
                        <div>
                            <!-- ì œëª© -->
                            <h3 class="post-title"
                                th:text="${post.title}">
                                ì˜¤ëŠ˜ ì˜ì—…ë‹¹í•œ ë‚´ ìµœì•  í¬ì¹´ ìë‘í•©ë‹ˆë‹¤ ğŸ¥¹
                            </h3>

                            <!-- ë‚´ìš© ìš”ì•½ (content ì•ë¶€ë¶„ ìë¥´ê¸°) -->
                            <p class="post-excerpt"
                               th:text="${#strings.abbreviate(post.content, 40)}">
                                ì˜¤ëŠ˜ ì˜ì—…ë‹¹í•œ ë‚´ ìµœì•  í¬ì¹´ ìë‘ ê¸€ì´ì—ìš”...
                            </p>

                            <!-- íƒœê·¸ëŠ” ë‚˜ì¤‘ì— DTOë¡œ í•©ì³ë„ ë˜ê³ , ì¼ë‹¨ì€ ì„ì‹œ -->
                            <p class="post-tag">
                                <!-- ì˜ˆì‹œ: ë‚˜ì¤‘ì— post.tagSummary ê°™ì€ í•„ë“œ ë§Œë“¤ë©´ ê·¸ê±¸ ì“°ë©´ ë¨ -->
                                <span th:text="${post.category.name}">#ì¹´í…Œê³ ë¦¬</span>
                            </p>

                            <!-- ë‹‰ë„¤ì„ Â· ì‘ì„±ì¼ -->
                            <p class="post-meta-top">
                                <span th:text="${post.member.nickname}">ë‹‰ë„¤ì„</span>
                                Â·
                                <span th:text="${#temporals.format(post.createdAt,'yyyy.MM.dd')}">
                            3ë¶„ ì „
                        </span>
                            </p>
                        </div>

                        <div class="post-meta-bottom">
                            <!-- â¤ï¸ì¢‹ì•„ìš” Â· ğŸ’¬ëŒ“ê¸€ìˆ˜ Â· ğŸ‘€ì¡°íšŒìˆ˜ -->
                            <div class="post-stats">
                                â¤ï¸<span th:text="${post.likeCount}">108</span>
                                Â· ğŸ’¬<span th:text="${post.commentCount}">23</span>
                                Â· ğŸ‘€<span th:text="${post.viewCount}">1,024</span>
                            </div>

                            <!-- ì¹´í…Œê³ ë¦¬ëª… -->
                            <div th:text="${post.category.name}">
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

            <!-- ê¸€ì´ í•˜ë‚˜ë„ ì—†ì„ ë•Œ -->
            <p th:if="${#lists.isEmpty(posts)}" style="text-align:center; margin-top:40px;">
                ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
            </p>
        </section>
        <nav class="d-flex justify-content-end align-items-center gap-2 mt-3">
            <select class="form-select form-select-sm w-auto"
                    onchange="location.href='?page=0&size=' + this.value;">
                <option disabled selected>ë³´ê¸°</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="40">40</option>
            </select>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=5)}">5</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=10)}">10</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=20)}">20</a>
            <a class="btn btn-sm btn-outline-dark d-none"
               th:href="@{'?'(page=0, size=40)}">40</a>
        </nav>
        <div th:with="
        page=${posts.number},
        last=${posts.totalPages},
        sort=${posts.sort},
        size=${param.size}"
             class="my-4 d-flex justify-content-center">
            <nav>
                <ul class="pagination">
                    <li class="page-item"
                        th:classappend="${page}==0 ? 'disabled': ''">
                        <a th:href="@{'?'(page=0,size=${size})}" class="page-link">start</a>
                    </li>
                    <li  th:each="i : ${#numbers.sequence(1,last)}"
                         th:classappend="( (${i}-1)==${page}?'active' )"
                         class="page-item">
                        <a th:href="@{'?'(page=(${i}-1), size=${size})}" class="page-link" th:text="${i}" > </a>
                    </li>
                    <li class="page-item"
                        th:classappend="${page}==(${last}-1) ? 'disabled':''">
                        <a th:href="@{'?'(page=${last}-1,size=${size})}" class="page-link">last</a>
                    </li>
                </ul>
            </nav>
        </div>


    </main>
</div>
<!-- ëª¨ë°”ì¼ ì „ìš© í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="floating-write-btn" th:onclick="|location.href='@{/board/{memberId}/write(memberId=${memberId})}'|">ï¼‹</button>

<script th:inline="javascript" layout:fragment="script">
    const postList = document.getElementById("postList");
    const viewListBtn = document.getElementById("viewListBtn");
    const viewPhotoBtn = document.getElementById("viewPhotoBtn");

    // íƒ€ì„ë¦¬í”„ì—ì„œ memberId ê°’ì„ JS ë³€ìˆ˜ë¡œ ì£¼ì…
    const memberId = /*[[${memberId}]]*/ 0;

    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', () => {
            const postId = card.dataset.postId;
            // ì›í•˜ëŠ” URL íŒ¨í„´ì— ë§ê²Œ ìˆ˜ì •í•´ì„œ ì‚¬ìš©
            // ì˜ˆ) /mcboard/{memberId}/{postId}/detail.do
            if (memberId == null){//ë¹„íšŒì›ì´ë©´ ì¡°íšŒë¶ˆê°€
                const url = `/board/not-allowed`;
                window.location.href = url;
                return;
            }
            const url = `/freeboard/${memberId}/article/${postId}/detail.do`;
            window.location.href = url;
        });
    });
    /* ë¦¬ìŠ¤íŠ¸ ë³´ê¸° */
    viewListBtn.onclick = () => {
        postList.classList.remove("photo-view");
        viewListBtn.classList.add("active");
        viewPhotoBtn.classList.remove("active");
    };

    /* ì‚¬ì§„ ë³´ê¸° */
    viewPhotoBtn.onclick = () => {
        postList.classList.add("photo-view");
        viewPhotoBtn.classList.add("active");
        viewListBtn.classList.remove("active");
    };

    /* ===== ì •ë ¬ ë©”ë‰´ ê¸°ëŠ¥ ===== */
    const sortBtn = document.getElementById("sortBtn");      // ì•„ì´ì½˜ ë²„íŠ¼
    const sortMenu = document.getElementById("sortMenu");    // ë©”ë‰´ ë°•ìŠ¤
    const sortOptions = document.querySelectorAll(".sort-option");

    // ì •ë ¬ ë²„íŠ¼ í´ë¦­ â†’ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    sortBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sortMenu.classList.toggle("hidden");
    });

    // ì •ë ¬ ì˜µì…˜ í´ë¦­ â†’ ë©”ë‰´ ë‹«ê¸° + ì ìš©
    sortOptions.forEach(option => {
        option.addEventListener("click", () => {
            sortOptions.forEach(o => o.classList.remove("active"));
            option.classList.add("active");

            sortMenu.classList.add("hidden");

            console.log("ì •ë ¬:", option.dataset.sort);
        });
    });

    // í™”ë©´ í´ë¦­í•˜ë©´ ë‹«í˜
    document.addEventListener("click", () => {
        sortMenu.classList.add("hidden");
    });

    document.addEventListener('DOMContentLoaded', () => {
        bindSortChange();
    });

    function bindSortChange() { // í˜ì´ì§€ ì •ë ¬ (ìµœì‹ ìˆœ, ì¸ê¸°ìˆœ)
        const sortOptions = document.querySelectorAll('#sortMenu .sort-option');

        sortOptions.forEach(option => {
            option.addEventListener('click', () => {
                const sortType = option.dataset.sort; // "latest" or "popular"
                const url = new URL(window.location.href);

                // âœ… Spring Pageableì´ ì´í•´í•˜ëŠ” sort íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜
                if (sortType === 'latest') {
                    // createdAt ê¸°ì¤€ ìµœì‹ ìˆœ
                    url.searchParams.set('sort', 'createdAt,desc');
                } else if (sortType === 'popular') {
                    // likeCount ê¸°ì¤€ ì¸ê¸°ìˆœ
                    url.searchParams.set('sort', 'likeCount,desc');
                }

                // í˜ì´ì§€ëŠ” 0ë¶€í„° ì‹œì‘
                url.searchParams.set('page', 0);

                window.location.href = url.toString();
            });
        });
    }
</script>
</body>
</html>