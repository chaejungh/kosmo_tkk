<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">
<head></head>
<body>



<div class="page board-page" layout:fragment="content">
    <div class="page-inner">

<!--        &lt;!&ndash; 상단 로고 + 뒤로가기 &ndash;&gt;-->
<!--        <header class="header">-->
<!--            <div class="detail-header-bar">-->
<!--                <button type="button"-->
<!--                        class="detail-back-btn"-->
<!--                        onclick="history.back()">-->
<!--                    ←-->
<!--                </button>-->
<!--                <div class="detail-logo">더쿠쿠</div>-->
<!--            </div>-->
<!--        </header>-->
<!--        <div id="share-popup" class="share-popup">-->
<!--            <div class="share-popup-inner">-->
<!--                <span id="share-url"></span>-->
<!--                <button id="copy-url-btn">복사</button>-->
<!--            </div>-->
<!--        </div>-->
        <!-- ============ 상세 카드 ============ -->
        <section class="card post-detail-card">
            <div class="post-detail-header">
                <!-- 왼쪽 : 프로필 영역 -->
                <div class="detail-profile-left">
                    <div class="detail-profile-photo">
                        <!-- 프로필 이미지가 있으면 이미지, 없으면 '프로필' 글자 -->
                        <img th:if="${post.member.profileImageUrl} != null"
                             th:src="${post.member.profileImageUrl}"
                             alt="프로필"
                             style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <span th:if="${post.member.profileImageUrl} == null">프로필</span>
                    </div>

                    <div class="detail-profile-meta">
                        <!-- 닉네임 -->
                        <div class="detail-nickname"
                             th:text="${post.member.nickname}">
                            히롱이
                        </div>
                        <!-- 작성일 · 카테고리명 -->
                        <div class="detail-sub-meta">
                <span th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">
                    3분 전
                </span>
                            ·
                            <span th:text="${post.category.name}"></span>
                        </div>
                    </div>
                </div>

                <!-- 오른쪽 : 수정 / 삭제 (작성자일 때만 노출) -->
                <div class="detail-header-actions"
                     th:if="${memberId != null and memberId == post.memberId}">
                    <a class="detail-action-btn"
                       th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/edit.do'}">
                        수정
                    </a>
                    <a class="detail-action-btn detail-action-delete"
                       th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/delete.do'}">
                        삭제
                    </a>
                </div>
            </div>


            <!-- 대표 사진 -->
            <div class="detail-main-image">
                <!-- thumbnailUrl이 있으면 대표사진으로 사용 -->
                <img th:if="${post.thumbnailUrl} != null"
                     th:src="${post.thumbnailUrl}"
                     alt="대표 사진"
                     style="width:100%; height:100%; object-fit:cover;">
                <div th:if="${post.thumbnailUrl} == null">
                    대표 사진 영역
                </div>

                <!-- 이미지 개수는 일단 1 / 1 -->
                <div class="detail-image-count">
                    <span>1 / 1</span>
                </div>
            </div>

            <!-- 좋아요 / 댓글 / 저장 / 조회수 + 공유 -->
            <div class="detail-stats-row">
                <div class="detail-stats-left">
                    <div class="detail-stat-item">
                        <button type="button"
                        id="like-btn"
                        class="like-btn"
                        th:data-post-id="${post.id}"
                        th:data-member-id="${memberId}"
                        th:data-liked="${likeInfo.id != null}">
                            ❤️
                        </button>
                        <span id="like-count" th:text="${post.likeCount}">0</span>

                    </div>
                    <div class="detail-stat-item">
                        💬 <span th:text="${commentCount}"></span>
                    </div>
                    <div class="detail-stat-item">
                        <span type="button"
                                id="bookmark-btn"
                                class="bookmark-btn"
                                th:data-post-id="${post.id}"
                                th:data-member-id="${memberId}"
                                th:data-bookmarked="${bookmarked}">
                            📌
                        </span>
                        <span id="bookmark-label"
                              th:text="${bookmarked} ? '저장됨' : '저장'">
                            저장
                        </span>

                    </div>
                    <div class="detail-stat-item">
                        👀 <span th:text="${post.viewCount}">0</span>
                    </div>
                </div>
                <button type="button" class="detail-share-btn">📤</button>
            </div>

            <!-- 글 내용 -->
            <div class="detail-content-title"
                 th:text="${post.title}">
                오늘 영업당한 내 최애 포카 자랑합니다 🥹
            </div>

            <!-- 개행 보존: \n → <br> -->
            <div class="detail-content-body"
                 th:utext="${#strings.replace(post.content, '\n', '<br/>')}">
                오늘 영업당한 내 최애 포카 자랑 글이에요.
                실물이 훨씬 예쁘고, 사진으로는 다 안 담기는 느낌…
                같은 덕후 분들과 같이 공유하고 싶어서 올려요!
            </div>

            <!-- 태그 -->
            <div class="detail-content-tags">
                <!-- 일단 카테고리만 간단히 표시 -->
                <span th:text="'#' + ${post.category.name}">#</span>

                <!--
                만약 BoardPostTag, BoardTag까지 다 연결했으면 예:
                <span th:each="pt : ${boardPostTags}"
                      th:text="${'#' + pt.tag.name}">
                    #주술회전
                </span>
                -->
            </div>
        </section>

        <!-- ============ 댓글 입력 ============ -->
        <section class="card comment-write-card">
            <div class="comment-write-title">
                댓글 (<span th:text="${commentList.size()}">0</span>)
            </div>

            <form th:action="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/comment/write.do'}"
                  method="post">

                <div class="comment-input-row">
                    <input name="content" type="text" placeholder="댓글을 입력해 주세요 :)">
                    <button type="submit">댓글 달기</button>
                </div>
            </form>
            <!-- ============ 댓글 리스트 ============ -->
            <div class="comment-list">

                <div th:if="${#lists.isEmpty(commentList)}"
                     class="comment-empty">
                    등록된 댓글이 없습니다.
                </div>

                <div th:each="c : ${commentList}" class="comment-item">

                    <!-- 댓글 상단 (닉네임 + 날짜 + 삭제 버튼) -->
                    <div class="comment-header">
                        <span class="comment-writer" th:text="${c.member.nickname}">닉네임</span>

                        <span class="comment-date"
                              th:text="${c.createdAt}">2025-01-01</span>

                        <a th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} +
                        '/comment/' + ${c.id} + '/delete.do'}"
                           class="comment-delete-btn">
                            삭제
                        </a>
                    </div>

                    <!-- 댓글 내용 -->
                    <div class="comment-content" th:text="${c.content}">
                        댓글 내용
                    </div>

                </div>
            </div>
        </section>
        <div id="share-modal-overlay" class="share-modal-overlay">
            <div class="share-modal">
                <div class="share-modal-header">
                    <span>링크 공유</span>
                    <button type="button" id="share-modal-close" class="share-modal-close">✕</button>
                </div>
                <div class="share-modal-body">
                    <p class="share-modal-text">
                        아래 링크를 복사해서 친구에게 공유해 보세요.
                    </p>
                    <div class="share-modal-url-row">
                        <input id="share-url-input" type="text" readonly>
                        <button type="button" id="copy-url-btn" class="share-copy-btn">복사</button>
                    </div>
                    <small id="share-copy-msg" class="share-copy-msg"></small>
                </div>
            </div>
        </div>
    </div>
</div>


</body>
<script th:inline="javascript" layout:fragment="script">
    (function() {

        const likeBtn = document.getElementById("like-btn");
        const likeCountSpan = document.getElementById("like-count");

        // 좋아요 버튼이 없으면 스크립트 바로 종료 (안전)
        if (!likeBtn || !likeCountSpan) {
            return;
        }

        likeBtn.addEventListener("click", async () => {
            const postId = likeBtn.dataset.postId;
            const memberId = likeBtn.dataset.memberId;

            try {
                const res = await fetch(`/api/board-like/${postId}/toggle?memberId=${memberId}`, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                if (!res.ok) {
                    console.error("like api error", res.status);
                    return;
                }

                const data = await res.json();   // { likeCount: 숫자, liked: boolean }

                // 화면 갱신
                likeCountSpan.textContent = data.likeCount;
                likeBtn.dataset.liked = data.liked;
                likeBtn.classList.toggle("active", data.liked);

            } catch (e) {
                console.error("like toggle error", e);
            }
        });

        // 처음부터 좋아요 상태면 active 적용
        if (likeBtn.dataset.liked === "true") {
            likeBtn.classList.add("active");
        }

        // ===================== 북마크 =====================
        const bookmarkBtn = document.getElementById("bookmark-btn");
        const bookmarkLabel = document.getElementById("bookmark-label");

        if (bookmarkBtn && bookmarkLabel) {

            const updateBookmarkUI = (bookmarked) => {
                bookmarkBtn.dataset.bookmarked = bookmarked;
                bookmarkBtn.classList.toggle("active", bookmarked);
                bookmarkLabel.textContent = bookmarked ? "저장됨" : "저장";
            };

            // 최초 상태 반영 (서버에서 내려준 bookmarked 값)
            if (bookmarkBtn.dataset.bookmarked === "true") {
                updateBookmarkUI(true);
            }

            bookmarkBtn.addEventListener("click", async () => {
                const postId = bookmarkBtn.dataset.postId;
                const memberId = bookmarkBtn.dataset.memberId;

                try {
                    const res = await fetch(`/api/board-bookmark/${postId}/toggle?memberId=${memberId}`, {
                        method: "POST",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    if (!res.ok) return;

                    const data = await res.json();   // { bookmarked: true/false }
                    updateBookmarkUI(data.bookmarked);

                } catch (e) {
                    console.error("bookmark toggle error", e);
                }
            });
        }

        // ===================== 공유 모달 =====================
        const shareBtn = document.querySelector(".detail-share-btn");
        const shareOverlay = document.getElementById("share-modal-overlay");
        const shareCloseBtn = document.getElementById("share-modal-close");
        const shareUrlInput = document.getElementById("share-url-input");
        const copyUrlBtn2 = document.getElementById("copy-url-btn");
        const shareCopyMsg = document.getElementById("share-copy-msg");

        if (shareBtn && shareOverlay && shareUrlInput && copyUrlBtn2) {

            const openShareModal = () => {
                const currentUrl = window.location.href;
                shareUrlInput.value = currentUrl;
                shareCopyMsg.textContent = "";

                shareOverlay.style.display = "flex";

                // 자동 선택 (바로 Ctrl+C 하고 싶은 사람용)
                setTimeout(() => {
                    shareUrlInput.focus();
                    shareUrlInput.select();
                }, 10);
            };

            const closeShareModal = () => {
                shareOverlay.style.display = "none";
            };

            // 공유 버튼 클릭 → 모달 열기
            shareBtn.addEventListener("click", openShareModal);

            // X 버튼 클릭 → 모달 닫기
            if (shareCloseBtn) {
                shareCloseBtn.addEventListener("click", closeShareModal);
            }

            // 오버레이 바깥(검은 영역) 클릭 → 모달 닫기 (옵션)
            shareOverlay.addEventListener("click", (e) => {
                if (e.target === shareOverlay) {
                    closeShareModal();
                }
            });

            // 복사 버튼 클릭 → 클립보드 복사
            copyUrlBtn2.addEventListener("click", async () => {
                const url = shareUrlInput.value;

                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(url);
                    } else {
                        // 구형 브라우저 대응
                        shareUrlInput.focus();
                        shareUrlInput.select();
                        document.execCommand("copy");
                    }
                    shareCopyMsg.textContent = "링크가 복사되었습니다 ✅";
                } catch (err) {
                    console.error("URL 복사 실패:", err);
                    shareCopyMsg.textContent = "복사에 실패했어요. 직접 복사해 주세요.";
                }
            });
        }


    })();
</script>

</html>