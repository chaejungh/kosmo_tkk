<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/tkk_fragment/layout}">
<head>
    <!-- âœ… layout head fragmentë¡œ CSS ì£¼ì… -->
    <th:block layout:fragment="head">
        <style>
            /* =========================
               Board Detail - UI Only
               ê¸°ëŠ¥(ì¢‹ì•„ìš”/ì €ì¥/ê³µìœ /ëŒ“ê¸€)ì€ ê·¸ëŒ€ë¡œ
            ========================== */

            :root{
                --bg: #f5f6f8;
                --card: #ffffff;
                --text: #111827;
                --muted: #6b7280;
                --line: #e5e7eb;
                --shadow: 0 8px 28px rgba(0,0,0,.08);

                --pink: #ff4d79;
                --pinkSoft: #fff0f4;

                --dark: #111827;
            }

            /* ì „ì²´ ë°°ê²½/ê°€ë¡œí­ */
            .board-page{
                background: var(--bg);
                min-height: calc(100vh - 120px);
            }
            .page-inner{
                max-width: 1240px;         /* âœ… ê°€ë¡œí­ ë„“í˜ */
                margin: 0 auto;
                padding: 26px 18px 80px;
            }

            /* ê³µí†µ ì¹´ë“œ */
            .card{
                background: var(--card);
                border: 1px solid rgba(0,0,0,.06);
                border-radius: 18px;
                box-shadow: var(--shadow);
            }

            /* ===== ìƒì„¸ ì¹´ë“œ ===== */
            .post-detail-card{
                max-width: 1040px;        /* âœ… ì¹´ë“œ ìì²´ë„ ì¡°ê¸ˆ ë„“ê²Œ */
                margin: 0 auto 18px;
                padding: 18px;
            }

            .post-detail-header{
                display:flex;
                justify-content:space-between;
                align-items:center;
                gap: 12px;
            }

            .detail-profile-left{
                display:flex;
                align-items:center;
                gap: 12px;
            }

            .detail-profile-photo{
                width: 44px;
                height: 44px;
                border-radius: 999px;
                overflow:hidden;
                background:#eef0f2;
                display:flex;
                align-items:center;
                justify-content:center;
                font-size: 12px;
                color: var(--muted);
                flex: none;
            }
            .detail-profile-photo img{
                width:100%;
                height:100%;
                object-fit:cover;
                display:block;
            }

            .detail-nickname{
                font-weight: 800;
                font-size: 15px;
                color: var(--text);
            }
            .detail-sub-meta{
                margin-top: 2px;
                font-size: 12px;
                color: var(--muted);
                display:flex;
                gap: 6px;
                align-items:center;
                flex-wrap: wrap;
            }

            .detail-header-actions{
                display:flex;
                gap: 8px;
            }
            .detail-action-btn{
                display:inline-flex;
                align-items:center;
                justify-content:center;
                padding: 8px 12px;
                border: 1px solid var(--line);
                border-radius: 999px;
                background: #fff;
                color: var(--text);
                text-decoration:none;
                font-size: 13px;
                cursor:pointer;
            }
            .detail-action-btn:hover{
                background:#fafafa;
            }
            .detail-action-delete{
                border-color: #fecaca;
                color: #ef4444;
            }

            /* ===== ëŒ€í‘œ ì´ë¯¸ì§€ =====
               âœ… ì‚¬ì§„ ë„ˆë¬´ í° ë¬¸ì œ í•´ê²°: ë†’ì´ ì¤„ì„
               âœ… ë²„íŠ¼ ì•ˆ ëˆŒë¦¬ëŠ” ë¬¸ì œ í•´ê²°: z-index ì •ë¦¬ + ê²¹ì¹¨ ë°©ì§€
            */
            .detail-main-image{
                margin-top: 14px;
                border-radius: 16px;
                overflow:hidden;
                background:#f3f4f6;
                position: relative;
                z-index: 1;               /* ì´ë¯¸ì§€ ì˜ì—­ì€ 1 */
            }
            .detail-main-image img{
                width: 100%;
                height: 420px;            /* âœ… ë„ˆë¬´ í¬ê²Œ ë‚˜ì˜¤ë˜ ê±° ì¤„ì„ */
                object-fit: cover;
                display:block;
                cursor: pointer;
            }

            /* ===== ì¢‹ì•„ìš”/ëŒ“ê¸€/ì €ì¥/ì¡°íšŒ/ê³µìœ  ===== */
            .detail-stats-row{
                display:flex;
                justify-content:space-between;
                align-items:center;
                gap: 12px;
                padding: 14px 2px 0;
                position: relative;
                z-index: 2;               /* âœ… ë²„íŠ¼ ì˜ì—­ì„ ìœ„ë¡œ ì˜¬ë ¤ í´ë¦­ ë³´ì¥ */
            }
            .detail-stats-left{
                display:flex;
                gap: 14px;
                align-items:center;
                flex-wrap: wrap;
            }
            .detail-stat-item{
                display:flex;
                align-items:center;
                gap: 8px;
                font-size: 14px;
                color: var(--text);
            }

            /* âœ… ê¸°ì¡´ ë²„íŠ¼/ìŠ¤íŒ¬ ìš”ì†ŒëŠ” ê·¸ëŒ€ë¡œ ì“°ë˜, "ëˆŒë¦¬ê²Œ"ë§Œ ìŠ¤íƒ€ì¼ */
            .like-btn{
                border: 1px solid var(--line);
                background: #fff;
                border-radius: 999px;
                padding: 6px 10px;
                cursor: pointer;
                line-height: 1;
                user-select: none;
            }
            .like-btn.active{
                border-color: var(--pink);
                box-shadow: 0 0 0 2px rgba(255,77,121,.10);
            }

            .bookmark-btn{
                border: 1px solid var(--line);
                background:#fff;
                border-radius: 999px;
                padding: 6px 10px;
                cursor: pointer;
                user-select:none;
                line-height: 1;
                display:inline-flex;
                align-items:center;
                justify-content:center;
            }
            .bookmark-btn.active{
                border-color: var(--pink);
                box-shadow: 0 0 0 2px rgba(255,77,121,.10);
            }

            #bookmark-label{
                font-size: 13px;
                color: var(--muted);
            }

            .detail-share-btn{
                border: 1px solid var(--dark);
                background: var(--dark);
                color:#fff;
                border-radius: 999px;
                padding: 8px 12px;
                cursor:pointer;
                line-height: 1;
            }

            /* ===== ì œëª©/ë³¸ë¬¸/íƒœê·¸ ===== */
            .detail-content-title{
                margin-top: 18px;
                font-size: 22px;
                font-weight: 900;
                color: var(--text);
                letter-spacing: -0.2px;
            }

            .detail-content-body{
                margin-top: 10px;
                color: #222;
                line-height: 1.7;
                font-size: 15px;
            }

            .detail-content-tags{
                margin-top: 14px;
                display:flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            .detail-content-tags span{
                background: var(--pinkSoft);
                color: var(--pink);
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 13px;
                font-weight: 700;
            }

            /* ===== ëŒ“ê¸€ ===== */
            .comment-write-card{
                max-width: 1040px;
                margin: 0 auto;
                padding: 18px;
            }

            .comment-write-title{
                font-weight: 900;
                color: var(--text);
                margin-bottom: 12px;
            }

            .comment-input-row{
                display:flex;
                gap: 10px;
            }

            .comment-input-row input{
                flex: 1;
                border: 1px solid var(--line);
                border-radius: 14px;
                padding: 12px 14px;
                font-size: 14px;
                outline:none;
                background:#fff;
            }
            .comment-input-row input:focus{
                border-color: var(--pink);
                box-shadow: 0 0 0 2px rgba(255,77,121,.10);
            }

            .comment-input-row button{
                border:none;
                background: var(--dark);
                color:#fff;
                border-radius: 14px;
                padding: 0 18px;
                cursor:pointer;
                min-width: 92px;
                font-weight: 800;
            }

            .comment-list{
                margin-top: 14px;
                display:flex;
                flex-direction:column;
                gap: 10px;
            }

            .comment-empty{
                text-align:center;
                color: var(--muted);
                padding: 16px 0;
            }

            .comment-item{
                border: 1px solid rgba(0,0,0,.06);
                border-radius: 14px;
                padding: 12px 14px;
                background:#fff;
            }

            .comment-header{
                display:flex;
                justify-content:space-between;
                align-items:center;
                gap: 10px;
                font-size: 12px;
                color: var(--muted);
            }
            .comment-writer{
                font-weight: 800;
                color: var(--text);
            }
            .comment-content{
                margin-top: 8px;
                color: var(--text);
                font-size: 14px;
                line-height: 1.55;
            }
            .comment-delete-btn{
                color: #ef4444;
                text-decoration:none;
                font-size: 12px;
                font-weight: 700;
            }

            /* ===== ê³µìœ  ëª¨ë‹¬ ===== */
            .share-modal-overlay{
                display:none;              /* âœ… ê¸°ë³¸ì€ ìˆ¨ê¹€ (ë²„íŠ¼ í´ë¦­ ë§‰ì§€ ì•Šê²Œ) */
                position:fixed;
                inset:0;
                background: rgba(0,0,0,.45);
                align-items:center;
                justify-content:center;
                z-index: 9999;
            }
            .share-modal{
                width: min(520px, calc(100% - 24px));
                background:#fff;
                border-radius: 16px;
                overflow:hidden;
                box-shadow: 0 12px 32px rgba(0,0,0,.28);
            }
            .share-modal-header{
                display:flex;
                align-items:center;
                justify-content:space-between;
                padding: 14px 16px;
                border-bottom: 1px solid rgba(0,0,0,.06);
                font-weight: 900;
                color: var(--text);
            }
            .share-modal-close{
                border:none;
                background:transparent;
                cursor:pointer;
                font-size: 18px;
            }
            .share-modal-body{
                padding: 14px 16px 16px;
            }
            .share-modal-text{
                margin: 0;
                color: var(--muted);
                font-size: 13px;
            }
            .share-modal-url-row{
                display:flex;
                gap: 10px;
                margin-top: 10px;
            }
            .share-modal-url-row input{
                flex:1;
                border: 1px solid var(--line);
                border-radius: 12px;
                padding: 10px 12px;
                outline:none;
            }
            .share-copy-btn{
                border:none;
                background: var(--dark);
                color:#fff;
                border-radius: 12px;
                padding: 0 14px;
                cursor:pointer;
                font-weight: 800;
            }
            .share-copy-msg{
                display:block;
                margin-top: 8px;
                color: #16a34a;
                font-size: 12px;
                font-weight: 700;
            }

            /* ë°˜ì‘í˜• */
            @media (max-width: 768px){
                .page-inner{
                    padding: 18px 12px 60px;
                }
                .post-detail-card,
                .comment-write-card{
                    padding: 14px;
                }
                .detail-main-image img{
                    height: 280px;
                }
                .detail-content-title{
                    font-size: 18px;
                }
            }
        </style>
    </th:block>
</head>
<body>

<div class="page board-page" layout:fragment="content">
    <div class="page-inner">
        <!-- ============ ìƒì„¸ ì¹´ë“œ ============ -->
        <section class="card post-detail-card">
            <div class="post-detail-header">
                <!-- ì™¼ìª½ : í”„ë¡œí•„ ì˜ì—­ -->
                <div class="detail-profile-left">
                    <div class="detail-profile-photo">
                        <img th:if="${post.member.profileImageUrl} != null"
                             th:src="${post.member.profileImageUrl}"
                             alt="í”„ë¡œí•„"
                             style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <span th:if="${post.member.profileImageUrl} == null">í”„ë¡œí•„</span>
                    </div>

                    <div class="detail-profile-meta">
                        <div class="detail-nickname"
                             th:text="${post.member.nickname}">íˆë¡±ì´</div>

                        <div class="detail-sub-meta">
                            <span th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">3ë¶„ ì „</span>
                            Â·
                            <span th:text="${post.category.name}"></span>
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ : ìˆ˜ì • / ì‚­ì œ (ì‘ì„±ìì¼ ë•Œë§Œ ë…¸ì¶œ) -->
                <div class="detail-header-actions"
                     th:if="${memberId != null and memberId == post.memberId}">
                    <a class="detail-action-btn"
                       th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/edit.do'}">
                        ìˆ˜ì •
                    </a>
                    <a class="detail-action-btn detail-action-delete"
                       th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/delete.do'}"
                       onclick="return confirm('ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        ì‚­ì œ
                    </a>
                </div>
            </div>

            <!-- ëŒ€í‘œ ì‚¬ì§„ -->
            <div class="detail-main-image">
                <img th:if="${coverUrl} != null"
                     th:src="${coverUrl}"
                     th:onclick="'location.href=\'/board/' + ${post.id} + '/img/' + ${coverImageId} + '/detail.do\''"
                     alt="ëŒ€í‘œ ì‚¬ì§„">
                <div th:if="${coverUrl} == null">
                    ëŒ€í‘œ ì‚¬ì§„ ì˜ì—­
                </div>
            </div>

            <!-- ì¢‹ì•„ìš” / ëŒ“ê¸€ / ì €ì¥ / ì¡°íšŒìˆ˜ + ê³µìœ  -->
            <div class="detail-stats-row">
                <div class="detail-stats-left">
                    <div class="detail-stat-item">
                        <button type="button"
                                id="like-btn"
                                class="like-btn"
                                th:data-post-id="${post.id}"
                                th:data-member-id="${memberId}"
                                th:data-liked="${likeInfo.id != null}"
                                th:text="${likeInfo.id != null} ? 'â¤ï¸' : 'ğŸ¤'">ğŸ¤</button>
                        <span id="like-count" th:text="${likeInfo.getLikeCount()}">0</span>
                    </div>

                    <div class="detail-stat-item">
                        ğŸ’¬ <span th:text="${commentCount}"></span>
                    </div>

                    <div class="detail-stat-item">
                        <span type="button"
                              id="bookmark-btn"
                              class="bookmark-btn"
                              th:data-post-id="${post.id}"
                              th:data-member-id="${memberId}"
                              th:data-bookmarked="${bookmarked}">ğŸ“Œ</span>
                        <span id="bookmark-label"
                              th:text="${bookmarked} ? 'ì €ì¥ë¨' : 'ì €ì¥'">ì €ì¥</span>
                    </div>

                    <div class="detail-stat-item">
                        ğŸ‘€ <span th:text="${post.viewCount}">0</span>
                    </div>
                </div>

                <button type="button" class="detail-share-btn">ğŸ“¤</button>
            </div>

            <!-- ê¸€ ë‚´ìš© -->
            <div class="detail-content-title"
                 th:text="${post.title}">ì˜¤ëŠ˜ ì˜ì—…ë‹¹í•œ ë‚´ ìµœì•  í¬ì¹´ ìë‘í•©ë‹ˆë‹¤ ğŸ¥¹</div>

            <div class="detail-content-body"
                 th:utext="${#strings.replace(post.content, '\n', '<br/>')}">
                ë‚´ìš©
            </div>

            <!-- íƒœê·¸ -->
            <div class="detail-content-tags">
                <span th:text="'#' + ${post.category.name}">#</span>
            </div>
        </section>

        <!-- ============ ëŒ“ê¸€ ì…ë ¥ ============ -->
        <section class="card comment-write-card">
            <div class="comment-write-title">
                ëŒ“ê¸€ (<span th:text="${commentList.size()}">0</span>)
            </div>

            <form th:action="@{'/board/' + ${memberId} + '/article/' + ${post.id} + '/comment/write.do'}"
                  method="post">
                <div class="comment-input-row">
                    <input name="content" type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ ì£¼ì„¸ìš” :)">
                    <button type="submit">ë“±ë¡</button>
                </div>
            </form>

            <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
            <div class="comment-list">

                <div th:if="${#lists.isEmpty(commentList)}"
                     class="comment-empty">
                    ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div th:each="c : ${commentList}" class="comment-item">
                    <div class="comment-header">
                        <span class="comment-writer" th:text="${c.member.nickname}">ë‹‰ë„¤ì„</span>
                        <span class="comment-date" th:text="${c.createdAt}">2025-01-01</span>

                        <a th:href="@{'/board/' + ${memberId} + '/article/' + ${post.id} +
                        '/comment/' + ${c.id} + '/delete.do'}"
                           onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                           class="comment-delete-btn">
                            ì‚­ì œ
                        </a>
                    </div>

                    <div class="comment-content" th:text="${c.content}">
                        ëŒ“ê¸€ ë‚´ìš©
                    </div>
                </div>
            </div>
        </section>

        <!-- ê³µìœ  ëª¨ë‹¬ -->
        <div id="share-modal-overlay" class="share-modal-overlay">
            <div class="share-modal">
                <div class="share-modal-header">
                    <span>ë§í¬ ê³µìœ </span>
                    <button type="button" id="share-modal-close" class="share-modal-close">âœ•</button>
                </div>
                <div class="share-modal-body">
                    <p class="share-modal-text">
                        ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ ë³´ì„¸ìš”.
                    </p>
                    <div class="share-modal-url-row">
                        <input id="share-url-input" type="text" readonly>
                        <button type="button" id="copy-url-btn" class="share-copy-btn">ë³µì‚¬</button>
                    </div>
                    <small id="share-copy-msg" class="share-copy-msg"></small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ìŠ¤í¬ë¦½íŠ¸ëŠ” layoutì˜ script fragmentë¡œ ë“¤ì–´ê°€ê²Œ (ë²„íŠ¼ ì•ˆëˆŒë¦¼ ë°©ì§€) -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        (function() {

            const likeBtn = document.getElementById("like-btn");
            const likeCountSpan = document.getElementById("like-count");

            if (!likeBtn || !likeCountSpan) return;

            if (likeBtn.dataset.liked === "true") {
                likeBtn.classList.add("active");
                likeBtn.textContent = "â¤ï¸";
            } else {
                likeBtn.textContent = "ğŸ¤";
            }

            likeBtn.addEventListener("click", async () => {
                const postId = likeBtn.dataset.postId;
                const memberId = likeBtn.dataset.memberId;

                try {
                    const res = await fetch(`/api/board-like/${postId}/toggle?memberId=${memberId}`, {
                        method: "POST",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    if (!res.ok) return;

                    const data = await res.json();
                    likeCountSpan.textContent = data.likeCount;
                    likeBtn.dataset.liked = data.liked;
                    likeBtn.classList.toggle("active", data.liked);
                    likeBtn.textContent = data.liked ? "â¤ï¸" : "ğŸ¤";

                } catch (e) {
                    console.error("like toggle error", e);
                }
            });

            // ë¶ë§ˆí¬
            const bookmarkBtn = document.getElementById("bookmark-btn");
            const bookmarkLabel = document.getElementById("bookmark-label");

            if (bookmarkBtn && bookmarkLabel) {

                const updateBookmarkUI = (bookmarked) => {
                    bookmarkBtn.dataset.bookmarked = bookmarked;
                    bookmarkBtn.classList.toggle("active", bookmarked);
                    bookmarkLabel.textContent = bookmarked ? "ì €ì¥ë¨" : "ì €ì¥";
                };

                if (bookmarkBtn.dataset.bookmarked === "true") {
                    updateBookmarkUI(true);
                }

                bookmarkBtn.addEventListener("click", async () => {
                    const postId = bookmarkBtn.dataset.postId;
                    const memberId = bookmarkBtn.dataset.memberId;

                    try {
                        const res = await fetch(`/api/board-bookmark/${postId}/toggle?memberId=${memberId}`, {
                            method: "POST",
                            headers: { "X-Requested-With": "XMLHttpRequest" }
                        });

                        if (!res.ok) return;

                        const data = await res.json();
                        updateBookmarkUI(data.bookmarked);

                    } catch (e) {
                        console.error("bookmark toggle error", e);
                    }
                });
            }

            // ê³µìœ  ëª¨ë‹¬
            const shareBtn = document.querySelector(".detail-share-btn");
            const shareOverlay = document.getElementById("share-modal-overlay");
            const shareCloseBtn = document.getElementById("share-modal-close");
            const shareUrlInput = document.getElementById("share-url-input");
            const copyUrlBtn2 = document.getElementById("copy-url-btn");
            const shareCopyMsg = document.getElementById("share-copy-msg");

            if (shareBtn && shareOverlay && shareUrlInput && copyUrlBtn2) {

                const openShareModal = () => {
                    const currentUrl = window.location.href;
                    shareUrlInput.value = currentUrl;
                    shareCopyMsg.textContent = "";
                    shareOverlay.style.display = "flex";

                    setTimeout(() => {
                        shareUrlInput.focus();
                        shareUrlInput.select();
                    }, 10);
                };

                const closeShareModal = () => {
                    shareOverlay.style.display = "none";
                };

                shareBtn.addEventListener("click", openShareModal);
                if (shareCloseBtn) shareCloseBtn.addEventListener("click", closeShareModal);

                shareOverlay.addEventListener("click", (e) => {
                    if (e.target === shareOverlay) closeShareModal();
                });

                copyUrlBtn2.addEventListener("click", async () => {
                    const url = shareUrlInput.value;

                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(url);
                        } else {
                            shareUrlInput.focus();
                            shareUrlInput.select();
                            document.execCommand("copy");
                        }
                        shareCopyMsg.textContent = "ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…";
                    } catch (err) {
                        console.error("URL ë³µì‚¬ ì‹¤íŒ¨:", err);
                        shareCopyMsg.textContent = "ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.";
                    }
                });
            }

        })();
    </script>
</th:block>

</body>
</html>