<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë”ì¿ ì¿  - í™ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- í™ˆ ì „ìš© ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" th:href="@{/css/home.css}">
</head>
<body>
<div class="page">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="header">
        <div class="header-top">
            <!-- ì™¼ìª½ ë¡œê³ : ê·¸ëŒ€ë¡œ ìœ ì§€ -->
            <a th:href="@{/}" class="logo">ë”ì¿ ì¿ </a>

            <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ì¸ / íšŒì›ê°€ì… + ì• ë‹ˆ êµ¿ì¦ˆ ë§µ ë°°ì§€ -->
            <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
                <!-- ë¡œê·¸ì¸ / íšŒì›ê°€ì… (ì• ë‹ˆ êµ¿ì¦ˆ ë§µ ê¸€ì”¨ ì™¼ìª½ì—) -->
                <div style="font-size:13px; color:#4b5563;">
                    <a th:href="@{/login}" style="text-decoration:none; color:#4b5563;">ë¡œê·¸ì¸</a>
                    <span style="margin:0 4px;">|</span>
                    <a th:href="@{/join}" style="text-decoration:none; color:#4b5563;">íšŒì›ê°€ì…</a>
                </div>

                <!-- ğŸ”¥ ê¸°ì¡´ ì• ë‹ˆ êµ¿ì¦ˆ ë§µ ë°°ì§€: í´ë˜ìŠ¤/ìŠ¤íƒ€ì¼/í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ -->
                <div class="logo-badge">
                    <span>ğŸ“±</span>
                    <span>ì• ë‹ˆ êµ¿ì¦ˆ ë§µ</span>
                </div>
            </div>
        </div>

        <!-- ğŸ”¹ ì—¬ê¸°ë¶€í„°ëŠ” ì›ë˜ ìˆë˜ ê²€ìƒ‰ì˜ì—­ ê·¸ëŒ€ë¡œ -->
        <div class="search-area">
            <div class="search-box">
                <input type="text" placeholder="ì£¼ìˆ íšŒì „, í™ëŒ€, í¬ì¹´, êµ¿ì¦ˆëª… ê²€ìƒ‰">
                <button type="button">ê²€ìƒ‰</button>
            </div>
            <p class="search-meta">ìµœê·¼ ê²€ìƒ‰ì–´ Â· ì¸ê¸° ê²€ìƒ‰ì–´ ì˜ì—­ (ì¶”í›„ êµ¬í˜„)</p>
        </div>
    </header>

    <main class="content">

        <!-- ì§€ë„ ì„¹ì…˜ -->
        <section class="card map-section">
            <div class="card-header">
                <div class="card-title">
                    <span>ì§€ë„ì—ì„œ êµ¿ì¦ˆ ë§¤ì¥ ì°¾ê¸°</span>
                    <span class="pill pill-blue">BETA</span>
                </div>
                <div class="card-actions">
                    <button type="button" class="chip">ë‚´ ìœ„ì¹˜</button>
                    <button type="button" class="chip">í•„í„°</button>
                </div>
            </div>

            <div class="map-frame">
                <iframe
                        th:src="@{/goods/map}"
                        title="ë§¤ì¥ ì§€ë„"
                        loading="lazy">
                </iframe>
            </div>
        </section>

        <!-- ì‹¤ì‹œê°„ ë§¤ì¥ ê²€ìƒ‰ ë­í‚¹ -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>ì‹¤ì‹œê°„ ë§¤ì¥ ê²€ìƒ‰ ë­í‚¹</span>
                    <span class="pill pill-purple">NOW</span>
                </div>
            </div>

            <ul class="rank-list">
                <li class="rank-item">
                    <div class="rank-left">
                        <span class="rank-badge rank-1">1</span>
                        <span class="rank-name">í™ëŒ€ â—‹â—‹â—‹ íŒì—…ìŠ¤í† ì–´</span>
                    </div>
                    <span class="rank-meta">ê²€ìƒ‰ 120íšŒ</span>
                </li>
                <li class="rank-item">
                    <div class="rank-left">
                        <span class="rank-badge rank-2">2</span>
                        <span class="rank-name">ê°•ë‚¨ â—‹â—‹ìƒµ</span>
                    </div>
                    <span class="rank-meta">ê²€ìƒ‰ 95íšŒ</span>
                </li>
                <li class="rank-item">
                    <div class="rank-left">
                        <span class="rank-badge rank-3">3</span>
                        <span class="rank-name">ì½”ì—‘ìŠ¤ â—‹â—‹ ë¶€ìŠ¤</span>
                    </div>
                    <span class="rank-meta">ê²€ìƒ‰ 80íšŒ</span>
                </li>
            </ul>
        </section>

        <!-- 11ì›” íŒì—…ìŠ¤í† ì–´ -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>11ì›” íŒì—…ìŠ¤í† ì–´</span>
                    <span class="pill pill-green">EVENT</span>
                </div>
            </div>

            <div class="popup-grid">
                <article class="popup-card">
                    <div class="popup-tag">POP-UP</div>
                    <h3 class="popup-title">ì£¼ìˆ íšŒì „ íŒì—…ìŠ¤í† ì–´</h3>
                    <p class="popup-meta">í™ëŒ€ â—‹â—‹ëª° Â· 11.20 ~ 12.05</p>
                </article>
                <article class="popup-card">
                    <div class="popup-tag">POP-UP</div>
                    <h3 class="popup-title">ê·€ë©¸ì˜ ì¹¼ë‚  íŒì—…ìŠ¤í† ì–´</h3>
                    <p class="popup-meta">ì½”ì—‘ìŠ¤ Bí™€ Â· 11.25 ~ 12.10</p>
                </article>
                <article class="popup-card">
                    <div class="popup-tag">POP-UP</div>
                    <h3 class="popup-title">ì—ë°˜ê²Œë¦¬ì˜¨ íŒì—…ìŠ¤í† ì–´</h3>
                    <p class="popup-meta">ì ì‹¤ â—‹â—‹ Â· 11.28 ~ 12.15</p>
                </article>
            </div>
        </section>

    </main>

    <!-- ë¬¸ì˜ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <a th:href="@{/help}" class="fab">
        <span class="fab-icon">ğŸ’¬</span>
        <span class="fab-text">ë¬¸ì˜ Â· AI ìƒë‹´</span>
    </a>

</div>

<!-- í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
    <a th:href="@{/}" class="nav-item active">
        <span class="icon">ğŸ </span>
        <span>í™ˆ</span>
    </a>
    <a th:href="@{/board}" class="nav-item">
        <span class="icon">ğŸ“</span>
        <span>ë•ì§ˆê²Œì‹œíŒ</span>
    </a>
    <a th:href="@{/trade}" class="nav-item">
        <span class="icon">ğŸ’¸</span>
        <span>êµ¿ì¦ˆê±°ë˜</span>
    </a>
    <a th:href="@{/mypage}" class="nav-item">
        <span class="icon">ğŸ‘¤</span>
        <span>ë‚´ì •ë³´</span>
    </a>
</nav>
<style>
    /* ì§€ë„ ìœ„ ì˜¤ë²„ë ˆì´ ë²„íŠ¼ë“¤ */
    .kk-controls{
        position:absolute; right:10px; top:10px; z-index:5;
        display:flex; flex-direction:column; gap:8px;
    }
    .kk-controls button{
        border:0; padding:8px 10px; border-radius:10px; background:#fff;
        box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer; font-size:13px;
    }
</style>

<script>
    (function(){
        if(!window.naver || !document.getElementById('map')) return;

        // ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì§€ë„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©(ì—†ìœ¼ë©´ ê²½ê³ ë§Œ)
        const m = window.map || (console.warn('map ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'), null);
        if(!m) return;

        const S = naver.maps.Service;
        let startMarker, endMarker, userMarker, routeLine;
        let waypointMarkers = [], waypointMode = false;
        const infoWin = new naver.maps.InfoWindow({ anchorSize:new naver.maps.Size(8,8) });

        const $ = (sel, root=document) => root.querySelector(sel);
        const llToParam = ll => `${ll.lng()},${ll.lat()}`;

        function setStart(ll, label='ì¶œë°œ'){
            if(!startMarker) startMarker = new naver.maps.Marker({ map:m, position:ll, title:label });
            else startMarker.setPosition(ll);
        }
        function setEnd(ll, label='ë„ì°©'){
            if(!endMarker) endMarker = new naver.maps.Marker({ map:m, position:ll, title:label });
            else endMarker.setPosition(ll);
            infoWin.setContent(`<div style="padding:6px 8px;font-size:12px">${label}</div>`);
            infoWin.open(m, endMarker);
        }
        function geocode(text){
            return new Promise(res=>{
                if(!text) return res(null);
                S.geocode({ query:text }, (st, r)=>{
                    if(st!==S.Status.OK || !r?.v2?.addresses?.length) return res(null);
                    const a = r.v2.addresses[0];
                    res({ ll:new naver.maps.LatLng(+a.y, +a.x), label:a.roadAddress || a.jibunAddress || text });
                });
            });
        }
        function reverseLabel(ll){
            return new Promise(res=>{
                S.reverseGeocode({ coords:ll, orders:[S.OrderType.ROAD_ADDR,S.OrderType.ADDR].join(',') },
                    (st, r)=>{
                        if(st===S.Status.OK && r?.v2?.results?.length){
                            const x = r.v2.results[0];
                            return res(x.roadaddress?.address || x.land?.name || 'ëª©ì ì§€');
                        }
                        res('ëª©ì ì§€');
                    });
            });
        }

        // ì§€ë„ í´ë¦­: ê²½ìœ ì§€ ëª¨ë“œë©´ ê²½ìœ  ì¶”ê°€, ì•„ë‹ˆë©´ ë„ì°©ì§€ ì„¤ì •(ë¼ë²¨ ìë™)
        naver.maps.Event.addListener(m, 'click', async e => {
            if(waypointMode) return addWaypoint(e.coord);
            const label = await reverseLabel(e.coord);
            setEnd(e.coord, label);
        });

        function addWaypoint(ll){
            const idx = waypointMarkers.length + 1;
            const mk = new naver.maps.Marker({
                map:m, position: ll, title:`ê²½ìœ ì§€ ${idx}`,
                icon:{ content:`<div style="width:20px;height:20px;border-radius:50%;
                       background:#fff;border:2px solid #704538;display:flex;
                       align-items:center;justify-content:center;font:12px/1 sans-serif;">${idx}</div>` }
            });
            waypointMarkers.push(mk);
        }
        function clearWaypoints(){
            waypointMarkers.forEach(mk=>mk.setMap(null));
            waypointMarkers = [];
        }

        // === ì§€ë„ ìœ„ ì»¨íŠ¸ë¡¤ DOM ì¶”ê°€ (HTML ì•ˆ ê±´ë“œë¦¼) ===
        const box = document.createElement('div');
        box.className = 'kk-controls';
        box.innerHTML = `
    <button id="kk-my">ë‚´ ìœ„ì¹˜</button>
    <button id="kk-wp">ê²½ìœ ì§€ ëª¨ë“œ Off</button>
    <button id="kk-clear">ê²½ìœ ì§€ ì´ˆê¸°í™”</button>
    <button id="kk-route">ìë™ì°¨ ê¸¸ì°¾ê¸°</button>
    <button id="kk-save">ì´ë¯¸ì§€ ì €ì¥</button>
  `;
        m.getElement().appendChild(box);

        // í˜„ì¬ ìœ„ì¹˜
        $('#kk-my').onclick = () => {
            if(!navigator.geolocation) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            navigator.geolocation.getCurrentPosition(pos=>{
                const ll = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                if(!userMarker) userMarker = new naver.maps.Marker({ map:m, position:ll, title:'ë‚´ ìœ„ì¹˜' });
                else userMarker.setPosition(ll);
                setStart(ll, 'í˜„ì¬ ìœ„ì¹˜');
                m.setCenter(ll);
            }, ()=>alert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'), { enableHighAccuracy:true, timeout:15000 });
        };

        // ê²½ìœ ì§€ ëª¨ë“œ í† ê¸€ / ì´ˆê¸°í™”
        $('#kk-wp').onclick = function(){
            waypointMode = !waypointMode;
            this.textContent = `ê²½ìœ ì§€ ëª¨ë“œ ${waypointMode ? 'On' : 'Off'}`;
        };
        $('#kk-clear').onclick = clearWaypoints;

        // ìë™ì°¨ ê¸¸ì°¾ê¸° (ë°±ì—”ë“œ í”„ë¡ì‹œ ì‚¬ìš©)
        $('#kk-route').onclick = async () => {
            let sLL = startMarker?.getPosition() || userMarker?.getPosition() || m.getCenter();
            if(!endMarker) return alert('ë„ì°©ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”. (ê²€ìƒ‰ ë˜ëŠ” ì§€ë„ í´ë¦­)');

            const start = encodeURIComponent(llToParam(sLL));
            const goal  = encodeURIComponent(llToParam(endMarker.getPosition()));
            const wp    = waypointMarkers.length
                ? waypointMarkers.map(mk=>llToParam(mk.getPosition())).join('|')
                : '';

            const res = await fetch(`/api/directions?start=${start}&goal=${goal}` + (wp?`&waypoints=${encodeURIComponent(wp)}`:'') + `&option=traoptimal`);
            if(!res.ok) return alert('ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨');
            const data = await res.json();
            const route = data?.route?.traoptimal?.[0];
            if(!route?.path?.length) return alert('ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');

            const path = route.path.map(([x,y]) => new naver.maps.LatLng(y,x));
            routeLine?.setMap(null);
            routeLine = new naver.maps.Polyline({ map:m, path, strokeWeight:6, strokeOpacity:.9, strokeColor:'#F79287' });

            const b = new naver.maps.LatLngBounds(path[0], path[0]); path.forEach(p=>b.extend(p)); m.fitBounds(b);
        };

        // ì •ì  ì§€ë„ PNG ì €ì¥
        $('#kk-save').onclick = async () => {
            const center = llToParam(m.getCenter());
            const level  = Math.max(5, Math.min(17, m.getZoom()));
            const qp = new URLSearchParams({ center, level:String(level), w:'800', h:'500' });
            if(startMarker){ const p=startMarker.getPosition(); qp.append('markers', `type:d|size:mid|pos:${p.lng()} ${p.lat()}`); }
            if(endMarker){   const p=endMarker.getPosition();   qp.append('markers', `type:d|size:mid|color:red|pos:${p.lng()} ${p.lat()}`); }
            waypointMarkers.slice(0,5).forEach(mk=>{
                const p = mk.getPosition(); qp.append('markers', `type:d|size:small|color:green|pos:${p.lng()} ${p.lat()}`);
            });

            const res = await fetch(`/api/staticmap?${qp.toString()}`);
            if(!res.ok) return alert('ì •ì  ì§€ë„ ìƒì„± ì‹¤íŒ¨');
            const blob = await res.blob(); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'map.png'; a.click(); URL.revokeObjectURL(url);
        };
    })();
</script>

</body>
</html>