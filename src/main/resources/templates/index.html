<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë”ì¿ ì¿  - í™ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ì‚¬ìš© -->
    <link rel="stylesheet" th:href="@{/css/home.css}">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

    <style>
        /* ===== ìƒë‹¨ ë¡œê·¸ì¸/íšŒì›ê°€ì… ===== */
        .auth-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-auth {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #4b5563;
            text-decoration: none;
            line-height: 1;
        }

        .btn-auth-primary {
            border-color: #6366f1;
            background: #6366f1;
            color: #ffffff;
        }

        .btn-auth:hover {
            background: #f3f4ff;
        }

        .btn-auth-primary:hover {
            background: #4f46e5;
        }

        /* ===== ì§€ë„ ê²€ìƒ‰ì°½ (ê¸°ì¡´ ìœ ì§€, ë°˜ì‘í˜•ë§Œ ì‚´ì§) ===== */
        .map-search-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            flex: none;
            max-width: 360px;
        }

        .map-search-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            outline: none;
        }

        .map-search-input:focus {
            border-color: #6366f1;
        }

        .map-search-button {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: #ff6b81;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .map-section .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                width: 100%;
            }

            .map-search-inline {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
            }

            .map-search-input {
                width: 100%;
                font-size: 14px;
            }
        }

        /* ===== íŒì—…ìŠ¤í† ì–´ ìŠ¬ë¼ì´ë“œ í•„ìˆ˜ CSS ===== */

        /* Swiper ì „ì²´ ì˜ì—­ */
        .popupSwiper {
            width: 100% !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ìŠ¬ë¼ì´ë“œë“¤ì´ ì˜†ìœ¼ë¡œ ë‚˜ì—´ë˜ë„ë¡ ë°˜ë“œì‹œ flex */
        .popupSwiper .swiper-wrapper {
            display: flex !important;
            width: 100% !important;
        }

        /* ê° ìŠ¬ë¼ì´ë“œê°€ 1ê°œì”© ì „ì²´ ë„ˆë¹„ */
        .popupSwiper .swiper-slide {
            width: 100% !important;
            flex-shrink: 0 !important;
        }

        /* ===== ì¹´ë“œ ì˜ì—­ ===== */
        .popup-card {
            width: 100% !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            background: #fff !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06) !important;
        }

        /* ===== ì´ë¯¸ì§€ ë” í¬ê²Œ ===== */
        .popup-img {
            width: 100% !important;
            height: 190px !important; /* â˜… í‚¤ í¬ì¸íŠ¸ */
            background: linear-gradient(135deg,#a5b4fc,#f9a8d4);
            border-radius: 14px !important;
        }

        /* ===== ê¸€ì”¨ ì˜ì—­ ë” ì¤„ì„ ===== */
        .popup-info {
            padding: 6px 10px !important; /* â˜… ì•„ë˜ìª½ ì—¬ë°± ì¤„ì„ */
            margin: 0 !important;
        }

        /* ì œëª© */
        .popup-title {
            font-size: 15px !important;
            font-weight: 700 !important;
            margin-bottom: 4px !important;
        }

        /* ì¥ì†Œ & ë‚ ì§œ */
        .popup-place,
        .popup-date {
            font-size: 12px !important;
            margin-bottom: 2px !important;
        }

        .popup-sub {
            font-size: 11px !important;
        }

        /* ===== ì´ë²¤íŠ¸ & ì¶œì„ì²´í¬ ì˜ì—­ ===== */
        .event-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .event-tabs {
            display: inline-flex;
            align-items: center;
            background: #f3f4ff;
            padding: 3px;
            border-radius: 999px;
        }

        .event-tab {
            border: none;
            background: transparent;
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 999px;
            cursor: pointer;
            color: #6b7280;
        }

        .event-tab.active {
            background: #ffffff;
            color: #4f46e5;
            box-shadow: 0 1px 4px rgba(79, 70, 229, 0.25);
        }

        .event-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .event-card {
            border-radius: 16px;
            background: #ffffff;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #eef2ff;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.02);
        }

        .event-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .event-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .event-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f3e8ff;
            color: #7c3aed;
            margin-right: 6px;
        }

        .event-right {
            font-size: 12px;
            background: #111827;
            color: #ffffff;
            padding: 8px 10px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .event-right span.icon-dot {
            width: 4px;
            height: 4px;
            border-radius: 999px;
            background: #22c55e;
        }

        @media (max-width: 480px) {

            /* ì´ë¯¸ì§€ ë†’ì´ ë” ì¤„ì´ê¸° */
            .popup-img {
                height: 150px !important;
            }

            /* í…ìŠ¤íŠ¸ ì˜ì—­ ì—¬ë°± ìµœì†Œ */
            .popup-info {
                padding: 6px 10px 8px 10px !important;
            }

            .popup-title {
                font-size: 14px !important;
                margin-bottom: 3px !important;
                line-height: 1.2 !important;
            }

            .popup-place,
            .popup-date,
            .popup-sub {
                font-size: 11px !important;
                margin-bottom: 2px !important;
                line-height: 1.2 !important;
            }
        }

        /* ====== ğŸ”¥ ê²€ìƒ‰ ê²°ê³¼ ë°”í…€ì‹œíŠ¸ (ì¤‘ì•™ ì¹´ë“œ í­ìœ¼ë¡œ ì¶•ì†Œ) ====== */
        .map-search-bottom{
            position:fixed;
            left:50%;
            bottom:0;
            transform:translate(-50%,100%);
            width:calc(100% - 32px);   /* ì¢Œìš° 16px ì—¬ë°± */
            max-width:960px;           /* ì¤‘ì•™ ì¹´ë“œ í­ê³¼ ë¹„ìŠ·í•˜ê²Œ */
            z-index:1200;
            background:#ffffff;
            box-shadow:0 -8px 30px rgba(15,23,42,0.25);
            transition:transform .25s ease-out;
            border-radius:16px 16px 0 0;
        }
        .map-search-bottom.show{
            transform:translate(-50%,0);
        }
        .map-search-sheet-inner{
            width:100%;
            margin:0 auto;
            padding:10px 18px 14px;
        }
        .map-search-sheet-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            font-size:13px;
            padding-bottom:6px;
            margin-bottom:4px;
            border-bottom:1px solid #e5e7eb;
        }
        .map-search-sheet-title{
            font-weight:600;
            color:#111827;
        }
        .map-search-close{
            border:none;
            background:transparent;
            font-size:18px;
            line-height:1;
            cursor:pointer;
            color:#6b7280;
        }
        .map-search-sheet-content{
            max-height:220px;       /* íŒì—…ìŠ¤í† ì–´ ì¹´ë“œ ë†’ì´ ì •ë„ */
            overflow-y:auto;
            padding-right:4px;
        }
        .map-search-list{
            list-style:none;
            margin:0;
            padding:0;
        }
        .map-search-item{
            padding:6px 0;
            border-radius:8px;
            cursor:pointer;
        }
        .map-search-item:hover{
            background:#f9fafb;
        }
        .map-search-line1{
            display:flex;
            align-items:center;
            gap:6px;
            font-size:13px;
        }
        .map-search-name{
            border:none;
            background:none;
            padding:0;
            margin:0;
            font-size:13px;
            font-weight:600;
            color:#111827;
            text-align:left;
        }
        .map-search-badge{
            font-size:11px;
            padding:2px 6px;
            border-radius:999px;
            border:1px solid #e5e7eb;
            background:#f9fafb;
            color:#4b5563;
        }
        .map-search-meta{
            font-size:12px;
            color:#6b7280;
            margin-top:2px;
        }
        .map-search-empty{
            font-size:13px;
            color:#6b7280;
            padding:4px 0 8px;
        }

        .map-search-detail{
            margin-left:auto;
            border:none;
            background:#111827;
            color:#fff;
            font-size:11px;
            padding:4px 8px;
            border-radius:999px;
            cursor:pointer;
            white-space:nowrap;
        }

        @media (max-width:768px){
            .map-search-bottom{
                width:100%;
                max-width:100%;
                left:0;
                transform:translateY(100%);
            }
            .map-search-bottom.show{
                transform:translateY(0);
            }
            .map-search-sheet-inner{
                max-width:100%;
            }
            .map-search-sheet-content{
                max-height:60vh; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì¡°ê¸ˆ ë” í¬ê²Œ í—ˆìš© */
            }
        }
    </style>
</head>

<body>
<div class="page">

    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-top">
            <!-- ë¡œê³ : í´ë¦­ ì‹œ í™ˆ -->
            <a th:href="@{/}" class="logo" style="margin-right: 10px;">ë”ì¿ ì¿ </a>
            <a th:href="@{/trade/list.do}" class="logo">êµ¿ì¦ˆê±°ë˜</a>



            <!-- ì˜¤ë¥¸ìª½ ë¡œê·¸ì¸/ë‹‰ë„¤ì„ ì˜ì—­ -->
            <div class="auth-actions">

                <!-- âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì¸ / íšŒì›ê°€ì… ë²„íŠ¼ -->
                <div th:if="${nickname == null}">
                    <a th:href="@{/auth/login}" class="btn-auth">ë¡œê·¸ì¸</a>
                    <a th:href="@{/auth/join}" class="btn-auth btn-auth-primary">íšŒì›ê°€ì…</a>
                </div>

                <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ: ë‹‰ë„¤ì„ + ë¡œê·¸ì•„ì›ƒ -->
                <div class="logged-in-box" th:if="${nickname != null}">
                <span class="welcome-text"
                      th:text="|${nickname} ë‹˜|">ë‹‰ë„¤ì„ ë‹˜</span>
                    <a th:href="@{/auth/logout}" class="btn-auth">ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>
        </div>
    </header>

    <main class="content">

        <!-- ===== ì§€ë„ ì„¹ì…˜ ===== -->
        <section class="card map-section">
            <div class="card-header" style="display:flex; align-items:center; gap:16px;">
                <div class="card-title" style="display:flex; align-items:center; gap:8px;">
                    <span>ì§€ë„ì—ì„œ êµ¿ì¦ˆ ë§¤ì¥ ì°¾ê¸°</span>
                    <span class="pill pill-blue">BETA</span>
                </div>
            </div>

            <div class="map-frame" style="height: 450px;">
                <!-- ì§€ë„ iframe: ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ì! -->
                <iframe th:src="@{/goods/map}" title="ë§¤ì¥ ì§€ë„" loading="lazy"
                        style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </section>

        <!-- ===== 11ì›” íŒì—…ìŠ¤í† ì–´ ===== -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>11ì›” íŒì—…ìŠ¤í† ì–´</span>
                    <span class="pill pill-purple">POP-UP</span>
                </div>

                <a href="/popupstore/list.do?page=1&pageLimit=20&sort=createdAt"
                   style="font-size: 12px; color: #4f46e5; text-decoration: none;">
                    ì „ì²´ ë³´ê¸° â†’
                </a>
            </div>

            <!-- Swiper ì»¨í…Œì´ë„ˆ -->
            <div class="swiper popupSwiper">
                <div class="swiper-wrapper">

                    <!-- ì‹¤ì œ DBì˜ popupListë¥¼ ë°˜ë³µ ì¶œë ¥ -->
                    <div class="swiper-slide popup-card"
                         th:each="popup : ${popupList}"
                         th:onclick="'location.href=\'/popupstore/' + ${popup.id} + '/detail.do\''">

                        <!-- ë°°ë„ˆ ì´ë¯¸ì§€ -->
                        <div class="popup-img"
                             th:style="'background-image:url(' + ${popup.bannerImageUrl} + ');
                            background-size:cover;
                            background-position:center;'">
                        </div>

                        <!-- íŒì—… ì •ë³´ -->
                        <div class="popup-info">

                            <!-- ì œëª© -->
                            <p class="popup-title" th:text="${popup.title}">íŒì—… ì œëª©</p>

                            <!-- ì¥ì†Œ (placeName ìš°ì„ , ì—†ìœ¼ë©´ regionName) -->
                            <p class="popup-place"
                               th:text="${popup.placeName != null ? popup.placeName : popup.regionName}">
                                ì¥ì†Œëª…
                            </p>

                            <!-- ê¸°ê°„ -->
                            <p class="popup-date"
                               th:text="|${popup.startDate} ~ ${popup.endDate}|">
                                2025.01.01 ~ 2025.01.31
                            </p>

                            <!-- ì§€ì—­ëª… í‘œì‹œ -->
                            <p class="popup-sub"
                               th:text="${popup.regionName}">
                                ì§€ì—­ëª…
                            </p>

                        </div>
                    </div>

                </div>
            </div>
        </section>

    </main>

    <!-- ë¬¸ì˜ floating ë²„íŠ¼ -->
    <a th:href="@{/help}" class="fab">
        <span class="fab-icon">ğŸ’¬</span>
        <span class="fab-text">ë¬¸ì˜ Â· AI ìƒë‹´</span>
    </a>
</div>


<!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
    <a th:href="@{/}" class="nav-item">
        <span class="icon">ğŸ </span>
        <span>í™ˆ</span>
    </a>
    <a th:href="@{/board}" class="nav-item active">
        <span class="icon">ğŸ“</span>
        <span>ë•ì§ˆê²Œì‹œíŒ</span>
    </a>
    <a th:href="@{/mypage}" class="nav-item">
        <span class="icon">ğŸ‘¤</span>
        <span>ë‚´ì •ë³´</span>
    </a>
</nav>

<!-- ğŸ”¥ ì§€ë„ ê²€ìƒ‰ ê²°ê³¼ ë°”í…€ì‹œíŠ¸ -->
<div id="mapSearchSheet" class="map-search-bottom">
    <div class="map-search-sheet-inner">
        <div class="map-search-sheet-header">
            <span class="map-search-sheet-title">ê²€ìƒ‰ ê²°ê³¼</span>
            <button type="button" class="map-search-close" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div id="mapSearchSheetContent" class="map-search-sheet-content">
            <!-- JSë¡œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
        </div>
    </div>
</div>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<script>
    const popupSwiper = new Swiper(".popupSwiper", {
        slidesPerView: 1,
        spaceBetween: 12,
        loop: true,
        centeredSlides: true,
        grabCursor: true,

        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
    });
</script>

<!-- ğŸ”¥ ì§€ë„ ê²€ìƒ‰ ê²°ê³¼ ë°”í…€ì‹œíŠ¸ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    (function () {
        const sheet = document.getElementById('mapSearchSheet');
        const contentEl = document.getElementById('mapSearchSheetContent');
        const closeBtn = sheet ? sheet.querySelector('.map-search-close') : null;

        function renderPlaces(places) {
            if (!sheet || !contentEl) return;

            const list = Array.isArray(places) ? places : [];

            contentEl.innerHTML = '';

            if (!list.length) {
                contentEl.innerHTML = '<p class="map-search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                sheet.classList.add('show');
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'map-search-list';

            list.forEach((p, idx) => {
                const li = document.createElement('li');
                li.className = 'map-search-item';

                // STORE ìª½ì€ storeId ë˜ëŠ” id ì‚¬ìš©
                const storeId = (p.storeId !== undefined && p.storeId !== null)
                    ? p.storeId
                    : p.id;

                li.innerHTML = `
                  <div class="map-search-line1">
                    <button type="button" class="map-search-name js-focus">${p.name || 'ì´ë¦„ ì—†ìŒ'}</button>
                    ${p.source ? `<span class="map-search-badge">${p.source === 'STORE' ? 'êµ¿ì¦ˆìƒµ(ë”ì¿ ì¿ )' : 'ë„¤ì´ë²„'}</span>` : ''}
                    ${p.source === 'STORE' && storeId != null
                    ? `<button type="button" class="map-search-detail" data-store-id="${storeId}">ìƒì„¸ë³´ê¸°</button>`
                    : ''}
                  </div>
                  <div class="map-search-meta">${p.address || ''}</div>
                `;

                // ì´ë¦„ ë²„íŠ¼ í´ë¦­ â†’ ì§€ë„ í¬ì»¤ìŠ¤ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
                const focusBtn = li.querySelector('.js-focus');
                focusBtn.addEventListener('click', () => {
                    const iframe = document.querySelector('.map-frame iframe');
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage(
                            {type: 'MAP_FOCUS_PLACE', idx},
                            window.location.origin
                        );
                    }
                    sheet.classList.remove('show');
                });

                // ìƒì„¸ë³´ê¸° ë²„íŠ¼ í´ë¦­ â†’ ë§¤ì¥ ìƒì„¸ í˜ì´ì§€ ì´ë™
                const detailBtn = li.querySelector('.map-search-detail');
                if (detailBtn) {
                    detailBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = detailBtn.dataset.storeId;
                        if (id) {
                            window.location.href = `/goods/store/${id}`;
                        }
                    });
                }

                ul.appendChild(li);
            });

            contentEl.appendChild(ul);
            sheet.classList.add('show');
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => sheet.classList.remove('show'));
        }

        // iframe(shop_map) â†’ index ë¡œ ë„˜ì–´ì˜¤ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            const data = event.data;
            if (!data || data.type !== 'MAP_SEARCH_RESULTS') return;
            renderPlaces(data.places || []);
        });
    })();
</script>
</body>
</html>
