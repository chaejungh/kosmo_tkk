<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/tkk_fragment/layout}">

<head>
    <th:block layout:fragment="head"></th:block>
</head>

<body>
<div layout:fragment="content">

    <!-- ===== ì£¼ë³€ êµ¿ì¦ˆë§¤ì¥ ì°¾ê¸° ===== -->
    <section class="card map-section">
        <div class="card-header">
            <div class="card-title">
                <span>ì£¼ë³€ êµ¿ì¦ˆë§¤ì¥ ì°¾ê¸°</span>
                <span class="pill pill-blue">BETA</span>
            </div>
        </div>

        <div class="home-search-row">
            <div class="home-input">
                <span class="ico">ğŸ”</span>
                <input id="qPlace" type="text" placeholder="ì§€ì—­ì´ë‚˜ ë§¤ì¥ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”">
            </div>
            <div class="home-input">
                <span class="ico">ğŸ“¦</span>
                <input id="qGoods" type="text" placeholder="ì¬ê³  ê²€ìƒ‰ (ì˜ˆ: ì§„ê²©ì˜ ê±°ì¸)">
            </div>
            <button id="btnMyPos" type="button" class="home-loc-btn">
                <span>ğŸ“</span> í˜„ì¬ ìœ„ì¹˜
            </button>
        </div>

        <div class="home-map-grid">
            <div class="home-map">
                <iframe th:src="@{/goods/map}" title="ë§¤ì¥ ì§€ë„" loading="lazy"
                        style="width:100%; height:100%; border:none;"></iframe>
            </div>

            <aside class="home-store-panel">
                <div class="home-store-head">ë§¤ì¥ ëª©ë¡</div>
                <div id="mapSideList" class="home-store-body">
                    <div class="home-store-empty">ê²€ìƒ‰í•˜ë©´ ì—¬ê¸°ì— ë§¤ì¥ ëª©ë¡ì´ ë– ìš”.</div>
                </div>
            </aside>
        </div>
    </section>

    <!-- ===== ì§„í–‰ì¤‘ì¸ íŒì—…ìŠ¤í† ì–´ ===== -->
    <section class="card popup-section">
        <div class="card-header">
            <div class="card-title">
                <span>ì§„í–‰ì¤‘ì¸ íŒì—…ìŠ¤í† ì–´</span>
                <span class="pill pill-purple">POP-UP</span>
            </div>

            <a class="btn-allview" th:href="@{/popupstore/list.do(page=0,size=10)}">
                ì „ì²´ë³´ê¸° <span style="font-weight:900;">â€º</span>
            </a>
        </div>

        <!-- âœ… Swiper -->
        <div class="swiper popupSwiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide"
                     th:each="popup : ${popupList}"
                     th:onclick="'location.href=\'/popupstore/' + ${popup.id} + '/detail.do\''">

                    <div class="popup-card">
                        <div class="popup-img"
                             th:style="${popup.bannerImageUrl != null}
                                ? |background-image:url(${popup.bannerImageUrl});|
                                : ''">

                            <div class="popup-badge"
                                 th:with="
                                    today=${T(java.time.LocalDate).now()},
                                    start=${popup.startDate},
                                    end=${popup.endDate},
                                    isActive=${start != null and end != null and (not today.isBefore(start)) and (not today.isAfter(end))},
                                    isUpcoming=${start != null and today.isBefore(start)}
                                 ">
                                <span class="popup-dot"
                                      th:classappend="${isUpcoming} ? ' upcoming' : (${isActive} ? '' : ' ended')"></span>
                                <span th:text="${isUpcoming} ? 'ì˜ˆì •' : (${isActive} ? 'ì§„í–‰ì¤‘' : 'ì¢…ë£Œ')">ì§„í–‰ì¤‘</span>
                            </div>
                        </div>

                        <div class="popup-info">
                            <p class="popup-title" th:text="${popup.title}">íŒì—… ì œëª©</p>
                            <p class="popup-place" th:text="${popup.placeName != null ? popup.placeName : popup.regionName}">ì¥ì†Œëª…</p>
                            <p class="popup-date" th:text="|${popup.startDate} ~ ${popup.endDate}|">ê¸°ê°„</p>

                            <!-- âœ… 3ë²ˆì§¸ ì‚¬ì§„ì²˜ëŸ¼ "ê²€ì • ë²„íŠ¼" -->
                            <a class="popup-cta"
                               th:href="@{|/popupstore/${popup.id}/detail.do|}"
                               onclick="event.stopPropagation();">
                                ìì„¸íˆ ë³´ê¸°
                            </a>
                        </div>
                    </div>

                </div>
            </div>

            <!-- âœ… ë²„íŠ¼/ë„íŠ¸ (íŒì—…Swiper ì•ˆì—ì„œë§Œ ì¡´ì¬) -->
            <div class="swiper-button-prev popup-nav"></div>
            <div class="swiper-button-next popup-nav"></div>
            <div class="swiper-pagination"></div>
        </div>
    </section>

    <!-- ë¬¸ì˜ ë²„íŠ¼ -->
    <a th:href="@{/help}" class="fab">
        <span class="fab-icon">ğŸ’¬</span>
        <span class="fab-text">ë¬¸ì˜ Â· AI ìƒë‹´</span>
    </a>

</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // âœ… 1) zoom(0.69) ì¨ë„ ë°ìŠ¤í¬íƒ‘ì€ ë¬´ì¡°ê±´ 3ê°œ ë³´ì´ê²Œ
            // âœ… 2) í•œ ë²ˆ í´ë¦­í•˜ë©´ "ë”± 1ì¹¸ì”©" ì´ë™
            const popupSwiper = new Swiper(".popupSwiper", {
                slidesPerView: 3,
                slidesPerGroup: 1,
                spaceBetween: 24,
                centeredSlides: false,
                loop: true,
                speed: 650,
                grabCursor: true,

                // ğŸ”¥ ì´ê±° ì—†ìœ¼ë©´ loopì—ì„œ ì¤„í”ë“¤ë¦¼/ë¹ˆì¹¸ ìƒê¸¸ ë•Œê°€ ìˆìŒ
                loopAdditionalSlides: 6,

                navigation: {
                    nextEl: ".popupSwiper .swiper-button-next",
                    prevEl: ".popupSwiper .swiper-button-prev"
                },
                pagination: {
                    el: ".popupSwiper .swiper-pagination",
                    clickable: true
                },

                // âœ… ëª¨ë°”ì¼ë§Œ ì¤„ì´ê¸° (zoom í™˜ê²½ì—ì„œë„ 3ê°œ ìœ ì§€í•˜ë ¤ê³  ê¸°ì¤€ì„ ë‚®ì¶¤)
                breakpoints: {
                    0:   { slidesPerView: 1.1, slidesPerGroup: 1, spaceBetween: 14 },
                    720: { slidesPerView: 2,   slidesPerGroup: 1, spaceBetween: 18 },
                    900: { slidesPerView: 3,   slidesPerGroup: 1, spaceBetween: 24 }
                }
            });

            // ===== ì§€ë„ iframe í†µì‹  (ê¸°ì¡´ ìœ ì§€) =====
            (function () {
                const sideList = document.getElementById('mapSideList');
                const iframe = document.querySelector('.home-map iframe');

                const qPlace = document.getElementById('qPlace');
                const qGoods = document.getElementById('qGoods');
                const btnMyPos = document.getElementById('btnMyPos');

                function sendSearch(){
                    if (!iframe || !iframe.contentWindow) return;
                    iframe.contentWindow.postMessage({
                        type: 'MAP_SEARCH',
                        place: (qPlace.value || '').trim(),
                        goods: (qGoods.value || '').trim()
                    }, window.location.origin);
                }
                function sendMyPos(){
                    if (!iframe || !iframe.contentWindow) return;
                    iframe.contentWindow.postMessage({ type:'MAP_MY_POSITION' }, window.location.origin);
                }

                if (qPlace) qPlace.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendSearch(); });
                if (qGoods) qGoods.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendSearch(); });
                if (btnMyPos) btnMyPos.addEventListener('click', sendMyPos);

                function renderPlaces(places){
                    if (!sideList) return;
                    const list = Array.isArray(places) ? places : [];
                    sideList.innerHTML = '';

                    if(!list.length){
                        sideList.innerHTML = '<div class="home-store-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const ul = document.createElement('ul');
                    ul.className = 'home-store-list';

                    list.forEach((p, idx)=>{
                        const li = document.createElement('li');
                        li.className = 'home-store-item';

                        const storeId = (p.storeId !== undefined && p.storeId !== null) ? p.storeId : p.id;

                        li.innerHTML = `
                            <div class="home-store-line1">
                              <button type="button" class="home-store-name js-focus">${p.name || 'ì´ë¦„ ì—†ìŒ'}</button>
                              ${p.source ? `<span class="home-store-badge">${p.source === 'STORE' ? 'êµ¿ì¦ˆìƒµ(ë”ì¿ ì¿ )' : 'ë„¤ì´ë²„'}</span>` : ''}
                              ${(p.source === 'STORE' && storeId != null)
                            ? `<button type="button" class="home-store-detail" data-store-id="${storeId}">ìƒì„¸ë³´ê¸°</button>`
                            : ''}
                            </div>
                            <div class="home-store-meta">${p.address || ''}</div>
                        `;

                        li.querySelector('.js-focus').addEventListener('click', ()=>{
                            if (iframe && iframe.contentWindow){
                                iframe.contentWindow.postMessage({ type:'MAP_FOCUS_PLACE', idx }, window.location.origin);
                            }
                        });

                        const detailBtn = li.querySelector('.home-store-detail');
                        if(detailBtn){
                            detailBtn.addEventListener('click', (e)=>{
                                e.stopPropagation();
                                const id = detailBtn.dataset.storeId;
                                if(id) window.location.href = `/goods/store/${encodeURIComponent(id)}`;
                            });
                        }

                        ul.appendChild(li);
                    });

                    sideList.appendChild(ul);
                }

                window.addEventListener('message', (event)=>{
                    if(event.origin !== window.location.origin) return;
                    const data = event.data;
                    if(!data || data.type !== 'MAP_SEARCH_RESULTS') return;
                    renderPlaces(data.places || []);
                });
            })();
        });
    </script>
</th:block>

</body>
</html>