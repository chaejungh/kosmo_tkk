<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/tkk_fragment/layout}">
<head>
    <style>

        /* ===== ì§€ë„ ê²€ìƒ‰ì°½ (ê¸°ì¡´ ìœ ì§€, ë°˜ì‘í˜•ë§Œ ì‚´ì§) ===== */
        .map-search-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            flex: none;
            max-width: 360px;
        }

        .map-search-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            outline: none;
        }

        .map-search-input:focus {
            border-color: #6366f1;
        }

        .map-search-button {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: #ff6b81;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .map-section .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                width: 100%;
            }

            .map-search-inline {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
            }

            .map-search-input {
                width: 100%;
                font-size: 14px;
            }
        }

        /* ===== íŒì—…ìŠ¤í† ì–´ ìŠ¬ë¼ì´ë“œ í•„ìˆ˜ CSS ===== */

        /* Swiper ì „ì²´ ì˜ì—­ */
        .popupSwiper {
            width: 100% !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ìŠ¬ë¼ì´ë“œë“¤ì´ ì˜†ìœ¼ë¡œ ë‚˜ì—´ë˜ë„ë¡ ë°˜ë“œì‹œ flex */
        .popupSwiper .swiper-wrapper {
            display: flex !important;
            width: 100% !important;
        }

        /* ê° ìŠ¬ë¼ì´ë“œê°€ 1ê°œì”© ì „ì²´ ë„ˆë¹„ */
        .popupSwiper .swiper-slide {
            width: 100% !important;
            flex-shrink: 0 !important;
        }

        /* ===== ì¹´ë“œ ì˜ì—­ ===== */
        .popup-card {
            width: 100% !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            background: #fff !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06) !important;
        }

        /* ===== ì´ë¯¸ì§€ ë” í¬ê²Œ ===== */
        .popup-img {
            width: 100% !important;
            height: 190px !important; /* â˜… í‚¤ í¬ì¸íŠ¸ */
            background: linear-gradient(135deg,#a5b4fc,#f9a8d4);
            border-radius: 14px !important;
        }

        /* ===== ê¸€ì”¨ ì˜ì—­ ë” ì¤„ì„ ===== */
        .popup-info {
            padding: 6px 10px !important; /* â˜… ì•„ë˜ìª½ ì—¬ë°± ì¤„ì„ */
            margin: 0 !important;
        }

        /* ì œëª© */
        .popup-title {
            font-size: 15px !important;
            font-weight: 700 !important;
            margin-bottom: 4px !important;
        }

        /* ì¥ì†Œ & ë‚ ì§œ */
        .popup-place,
        .popup-date {
            font-size: 12px !important;
            margin-bottom: 2px !important;
        }

        .popup-sub {
            font-size: 11px !important;
        }

        .event-right span.icon-dot {
            width: 4px;
            height: 4px;
            border-radius: 999px;
            background: #22c55e;
        }

        @media (max-width: 480px) {

            /* ì´ë¯¸ì§€ ë†’ì´ ë” ì¤„ì´ê¸° */
            .popup-img {
                height: 150px !important;
            }

            /* í…ìŠ¤íŠ¸ ì˜ì—­ ì—¬ë°± ìµœì†Œ */
            .popup-info {
                padding: 6px 10px 8px 10px !important;
            }

            .popup-title {
                font-size: 14px !important;
                margin-bottom: 3px !important;
                line-height: 1.2 !important;
            }

            .popup-place,
            .popup-date,
            .popup-sub {
                font-size: 11px !important;
                margin-bottom: 2px !important;
                line-height: 1.2 !important;
            }
        }

        /* ====== ğŸ”¥ ê²€ìƒ‰ ê²°ê³¼ ë°”í…€ì‹œíŠ¸ (ì¤‘ì•™ ì¹´ë“œ í­ìœ¼ë¡œ ì¶•ì†Œ) ====== */
        .map-search-bottom{
            position:fixed;
            left:50%;
            bottom:0;
            transform:translate(-50%,100%);
            width:calc(100% - 32px);   /* ì¢Œìš° 16px ì—¬ë°± */
            max-width:960px;           /* ì¤‘ì•™ ì¹´ë“œ í­ê³¼ ë¹„ìŠ·í•˜ê²Œ */
            z-index:1200;
            background:#ffffff;
            box-shadow:0 -8px 30px rgba(15,23,42,0.25);
            transition:transform .25s ease-out;
            border-radius:16px 16px 0 0;
        }
        .map-search-bottom.show{
            transform:translate(-50%,0);
        }
        .map-search-sheet-inner{
            width:100%;
            margin:0 auto;
            padding:10px 18px 14px;
        }
        .map-search-sheet-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            font-size:13px;
            padding-bottom:6px;
            margin-bottom:4px;
            border-bottom:1px solid #e5e7eb;
        }
        .map-search-sheet-title{
            font-weight:600;
            color:#111827;
        }
        .map-search-close{
            border:none;
            background:transparent;
            font-size:18px;
            line-height:1;
            cursor:pointer;
            color:#6b7280;
        }
        .map-search-sheet-content{
            max-height:220px;       /* íŒì—…ìŠ¤í† ì–´ ì¹´ë“œ ë†’ì´ ì •ë„ */
            overflow-y:auto;
            padding-right:4px;
        }
        .map-search-line1{
            display:flex;
            align-items:center;
            gap:6px;
            font-size:13px;
        }
        .map-search-name{
            border:none;
            background:none;
            padding:0;
            margin:0;
            font-size:13px;
            font-weight:600;
            color:#111827;
            text-align:left;
        }
        .map-search-badge{
            font-size:11px;
            padding:2px 6px;
            border-radius:999px;
            border:1px solid #e5e7eb;
            background:#f9fafb;
            color:#4b5563;
        }
        .map-search-meta{
            font-size:12px;
            color:#6b7280;
            margin-top:2px;
        }
        .map-search-empty{
            font-size:13px;
            color:#6b7280;
            padding:4px 0 8px;
        }

        .map-search-detail{
            margin-left:auto;
            border:none;
            background:#111827;
            color:#fff;
            font-size:11px;
            padding:4px 8px;
            border-radius:999px;
            cursor:pointer;
            white-space:nowrap;
        }

        @media (max-width:768px){
            .map-search-bottom{
                width:100%;
                max-width:100%;
                left:0;
                transform:translateY(100%);
            }
            .map-search-bottom.show{
                transform:translateY(0);
            }
            .map-search-sheet-inner{
                max-width:100%;
            }
            .map-search-sheet-content{
                max-height:60vh; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì¡°ê¸ˆ ë” í¬ê²Œ í—ˆìš© */
            }
        }

        #popupStoreModal .modal-content {
            position: relative;
            z-index: 9999 !important;
        }

        #popupStoreModal .carousel-item {
            position: relative;
            z-index: 1;
        }

        #popupStoreModal .btn-primary {
            position: relative;
            z-index: 99999 !important;
            pointer-events: auto !important;

            display: block;
            width: 70%;
            margin: 20px auto 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
            padding: 10px 0;
            font-size: 15px;
            text-align: center;
        }

        .modal-backdrop {
            z-index: 3000 !important;
        }

        #popupStoreModal {
            z-index: 3100 !important;
        }

        #popupStoreModal .modal-content {
            z-index: 3200 !important;
        }

        .map-search-bottom {
            z-index: 500 !important;  /* ëª¨ë‹¬ë³´ë‹¤ ë‚®ê²Œ */
        }

    </style>
</head>

<body>
<div layout:fragment="content">
    <!-- âœ… ê° í˜ì´ì§€ì—ì„œ ì´ fragment ë¥¼ ì±„ì›Œë„£ìŒ -->
    <main>

        <!-- ===== ì§€ë„ ì„¹ì…˜ ===== -->
        <section class="card map-section">
            <div class="card-header" style="display:flex; align-items:center; gap:16px;">
                <div class="card-title" style="display:flex; align-items:center; gap:8px;">
                    <span>ì§€ë„ì—ì„œ êµ¿ì¦ˆ ë§¤ì¥ ì°¾ê¸°</span>
                    <span class="pill pill-blue">BETA</span>
                </div>
            </div>

            <div class="map-frame" style="height: 450px;">
                <!-- ì§€ë„ iframe: ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ì! -->
                <iframe th:src="@{/goods/map}" title="ë§¤ì¥ ì§€ë„" loading="lazy"
                        style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </section>

        <!-- ===== 11ì›” íŒì—…ìŠ¤í† ì–´ ===== -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">
                    <span>11ì›” íŒì—…ìŠ¤í† ì–´</span>
                    <span class="pill pill-purple">POP-UP</span>
                </div>

                <a href="/popupstore/list.do?page=1&pageLimit=20&sort=createdAt"
                   style="font-size: 12px; color: #4f46e5; text-decoration: none;">
                    ì „ì²´ ë³´ê¸° â†’
                </a>
            </div>

            <!-- Swiper ì»¨í…Œì´ë„ˆ -->
            <div class="swiper popupSwiper">
                <div class="swiper-wrapper">

                    <!-- ì‹¤ì œ DBì˜ popupListë¥¼ ë°˜ë³µ ì¶œë ¥ -->
                    <div class="swiper-slide popup-card"
                         th:each="popup : ${popupList}"
                         th:onclick="'location.href=\'/popupstore/' + ${popup.id} + '/detail.do\''">

                        <!-- ë°°ë„ˆ ì´ë¯¸ì§€ -->
                        <div class="popup-img"
                             th:style="|background-image:url(${popup.bannerImageUrl});
                                       background-size:cover;
                                       background-position:center;|">
                        </div>

                        <!-- íŒì—… ì •ë³´ -->
                        <div class="popup-info">

                            <!-- ì œëª© -->
                            <p class="popup-title" th:text="${popup.title}">íŒì—… ì œëª©</p>

                            <!-- ì¥ì†Œ (placeName ìš°ì„ , ì—†ìœ¼ë©´ regionName) -->
                            <p class="popup-place"
                               th:text="${popup.placeName != null ? popup.placeName : popup.regionName}">
                                ì¥ì†Œëª…
                            </p>

                            <!-- ê¸°ê°„ -->
                            <p class="popup-date"
                               th:text="|${popup.startDate}+'~'+ ${popup.endDate}|">
                                2025.01.01 ~ 2025.01.31
                            </p>

                            <!-- ì§€ì—­ëª… í‘œì‹œ -->
                            <p class="popup-sub"
                               th:text="${popup.regionName}">
                                ì§€ì—­ëª…
                            </p>

                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- ğŸ”¥ ì§€ë„ ê²€ìƒ‰ ê²°ê³¼ ë°”í…€ì‹œíŠ¸ -->
        <div id="mapSearchSheet" class="map-search-bottom" style="z-index: 999;">
            <div class="map-search-sheet-inner">
                <div class="map-search-sheet-header">
                    <span class="map-search-sheet-title">ê²€ìƒ‰ ê²°ê³¼</span>
                    <button type="button" class="map-search-close" aria-label="ë‹«ê¸°">Ã—</button>
                </div>
                <div id="mapSearchSheetContent" class="map-search-sheet-content">
                    <!-- JSë¡œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="popupStoreModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 18px;">

                <div class="modal-header">
                    <h5 class="modal-title">ì§„í–‰ ì¤‘ì¸ íŒì—…ìŠ¤í† ì–´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div id="popupCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">

                            <!-- â­ ì—¬ëŸ¬ íŒì—…ì„ carousel-itemìœ¼ë¡œ ë°˜ë³µ -->
                            <div class="carousel-item"
                                 th:each="p, i : ${activePopupList}"
                                 th:classappend="${i.index == 0} ? ' active' : ''">

                                <!-- ëŒ€í‘œ ì´ë¯¸ì§€ (bannerImageUrl) -->
                                <img th:if="${p.bannerImageUrl != null}"
                                     th:src="${p.bannerImageUrl}"
                                     class="d-block w-100"
                                     style="border-radius:12px; margin-bottom:12px; object-fit:cover; max-height:260px;"/>

                                <!-- ì œëª© -->
                                <h5 th:text="${p.title}">íŒì—… ì œëª©</h5>

                                <!-- ì¥ì†Œ: placeName ìˆìœ¼ë©´ ê·¸ê±°, ì—†ìœ¼ë©´ regionName -->
                                <p th:if="${p.placeName != null}"
                                   th:text="'ğŸ“ ' + ${p.placeName}">ì¥ì†Œ</p>
                                <p th:if="${p.placeName == null}"
                                   th:text="'ğŸ“ ' + ${p.regionName}">ì¥ì†Œ</p>

                                <!-- ê¸°ê°„ -->
                                <p th:text="'ğŸ“… ' + ${p.startDate} + ' ~ ' + ${p.endDate}">ê¸°ê°„</p>

                                <!-- ì„¤ëª… -->
                                <p th:text="${p.description}">ì„¤ëª…</p>

                                <!-- ìƒì„¸ í˜ì´ì§€ ë§í¬ -->
                                <a class="btn btn-primary mt-2"
                                   th:href="@{'/popupstore/' + ${p.id} + '/detail.do'}">
                                    ìì„¸íˆ ë³´ê¸°
                                </a>

                            </div>

                        </div>

                        <!-- ì´ì „ / ë‹¤ìŒ ë²„íŠ¼ -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#popupCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#popupCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>

                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- ë¬¸ì˜ floating ë²„íŠ¼ -->
    <a th:href="@{/help}" class="fab" style="z-index: 998">
        <span class="fab-icon">ğŸ’¬</span>
        <span class="fab-text">ë¬¸ì˜ Â· AI ìƒë‹´</span>
    </a>
</div>

<!-- ğŸ”¥ í˜ì´ì§€ë³„ ìŠ¤í¬ë¦½íŠ¸ fragment -->
<th:block layout:fragment="script">

    <!-- Swiper + ì§€ë„ ë°”í…€ì‹œíŠ¸ -->
    <script>

        const popupSwiper = new Swiper(".popupSwiper", {
            slidesPerView: 1,
            spaceBetween: 12,
            loop: true,
            centeredSlides: true,
            grabCursor: true,
            autoplay: {
                delay: 2500,
                disableOnInteraction: false,
            },
        });

        (function () {
            const sheet = document.getElementById('mapSearchSheet');
            const contentEl = document.getElementById('mapSearchSheetContent');
            const closeBtn = sheet ? sheet.querySelector('.map-search-close') : null;

            function renderPlaces(places) {
                if (!sheet || !contentEl) return;

                const list = Array.isArray(places) ? places : [];

                contentEl.innerHTML = '';

                if (!list.length) {
                    contentEl.innerHTML = '<p class="map-search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    sheet.classList.add('show');
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'map-search-list';

                list.forEach((p, idx) => {
                    const li = document.createElement('li');
                    li.className = 'map-search-item';

                    const storeId = (p.storeId !== undefined && p.storeId !== null)
                        ? p.storeId
                        : p.id;

                    li.innerHTML = `
                              <div class="map-search-line1">
                                <button type="button" class="map-search-name js-focus">
                                  ${p.name || 'ì´ë¦„ ì—†ìŒ'}
                                </button>

                                ${p.source
                                                    ? `<span class="map-search-badge">
                                      ${p.source === 'STORE' ? 'êµ¿ì¦ˆìƒµ(ë”ì¿ ì¿ )' : 'ë„¤ì´ë²„'}
                                    </span>`
                                                    : ''}

                                ${(p.source === 'STORE' && storeId != null)
                                                    ? `<button type="button" class="map-search-detail" data-store-id="${storeId}">
                                      ìƒì„¸ë³´ê¸°
                                    </button>`
                                                    : ''}
                              </div>

                              <div class="map-search-meta">${p.address || ''}</div>
                            `;


                    const focusBtn = li.querySelector('.js-focus');
                    focusBtn.addEventListener('click', () => {
                        const iframe = document.querySelector('.map-frame iframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage(
                                {type: 'MAP_FOCUS_PLACE', idx},
                                window.location.origin
                            );
                        }
                        sheet.classList.remove('show');
                    });

                    const detailBtn = li.querySelector('.map-search-detail');
                    if (detailBtn) {
                        detailBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = detailBtn.dataset.storeId;
                            if (id) {
                                const url = '/goods/store/${id}';
                                window.location.href = url;
                            }
                        });
                    }

                    ul.appendChild(li);
                });

                contentEl.appendChild(ul);
                sheet.classList.add('show');
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => sheet.classList.remove('show'));
            }

            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) return;
                const data = event.data;
                if (!data || data.type !== 'MAP_SEARCH_RESULTS') return;
                renderPlaces(data.places || []);
            });
        })();
    </script>

    <!-- ğŸ”¥ ì§„í–‰ ì¤‘ íŒì—…ìŠ¤í† ì–´ ìë™ ëª¨ë‹¬ ì‹¤í–‰ -->
    <script th:if="${activePopupList != null and activePopupList.size() > 0}">
        document.addEventListener("DOMContentLoaded", function () {
            const modal = new bootstrap.Modal(document.getElementById("popupStoreModal"));
            modal.show();
        });
    </script>

</th:block>

</body>
</html>