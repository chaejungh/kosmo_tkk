<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/fragments/layout}">

<head>
    <!-- âœ… ì´ í˜ì´ì§€ì—ì„œë§Œ ì“°ëŠ” head -->
    <th:block layout:fragment="head">
        <!-- Swiper (ë ˆì´ì•„ì›ƒì—ì„œ ì´ë¯¸ ë¡œë“œ ì¤‘ì´ë©´ 2ì¤„ì€ ë¹¼ë„ ë¨) -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

        <style>
            /* =========================
               âœ… í™ˆ í™”ë©´ í­/í¬ê¸° ê³ ì • (ì„œë²„ì²˜ëŸ¼ ë³´ì´ê²Œ)
               ========================= */
            *, *::before, *::after { box-sizing: border-box; }
            html { font-size: 16px; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
            body { margin: 0; padding: 0; }

            /* âœ… "ì „ì²´ í­"ì´ ì´ìƒí•´ì¡Œì„ ë•Œ ê°€ì¥ í”í•œ ì›ì¸: ë‹¤ë¥¸ CSSê°€ max-widthë¥¼ ë®ì–´ì”€
               -> í™ˆì—ì„œë§Œ í™•ì‹¤í•˜ê²Œ 1200 ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ê³ ì • */
            .tkk-container{
                width: min(1200px, 92vw) !important;
                max-width: 1200px !important;
                margin: 0 auto !important;
                padding: 22px 16px 60px !important;
            }

            /* =========================
               ê³µí†µ ì¹´ë“œ
               ========================= */
            .card {
                background: #fff;
                border: 1px solid #eef2f7;
                border-radius: 18px;
                box-shadow: 0 10px 26px rgba(0,0,0,0.06);
                padding: 18px;
            }
            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                margin-bottom: 14px;
            }
            .card-title {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 18px;
                font-weight: 900;
            }

            .pill {
                display: inline-flex;
                align-items: center;
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 12px;
                font-weight: 800;
            }
            .pill-blue { background: #e6f0ff; color: #2557d6; }
            .pill-purple { background: #f1e8ff; color: #6d28d9; }

            /* =========================
               í™ˆ ê²€ìƒ‰ ì¤„
               ========================= */
            .home-search-row {
                display: grid;
                grid-template-columns: 1fr 1fr auto;
                gap: 12px;
                margin-bottom: 14px;
            }
            .home-input {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 14px;
                border: 1px solid #e5e7eb;
                border-radius: 14px;
                background: #fff;
                min-width: 0;
            }
            .home-input input {
                width: 100%;
                min-width: 0;
                border: none;
                outline: none;
                font-size: 14px;
            }
            .home-loc-btn {
                border: none;
                background: #111827;
                color: #fff;
                border-radius: 14px;
                padding: 12px 16px;
                font-weight: 800;
                cursor: pointer;
                white-space: nowrap;
            }

            /* =========================
               ì§€ë„ + ëª©ë¡
               ========================= */
            .home-map-grid {
                display: grid;
                grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
                gap: 16px;
                align-items: stretch;
            }
            .home-map {
                border-radius: 16px;
                overflow: hidden;
                min-height: 420px;
                background: #f3f4f6;
            }
            .home-map iframe { width: 100%; height: 100%; border: 0; display: block; }

            .home-store-panel {
                border-radius: 16px;
                border: 1px solid #e5e7eb;
                overflow: hidden;
                background: #fff;
            }
            .home-store-head {
                background: #111827;
                color: #fff;
                padding: 12px 14px;
                font-weight: 900;
            }
            .home-store-body {
                padding: 12px 14px;
                max-height: 420px;
                overflow: auto;
            }
            .home-store-empty { color: #6b7280; font-weight: 700; }

            .home-store-list {
                list-style: none;
                padding: 0;
                margin: 0;
                display: grid;
                gap: 10px;
            }
            .home-store-item {
                border: 1px solid #eef2f7;
                border-radius: 14px;
                padding: 10px 12px;
            }
            .home-store-line1 {
                display: flex;
                align-items: center;
                gap: 10px;
                min-width: 0;
            }
            .home-store-name {
                border: none;
                background: transparent;
                font-weight: 900;
                cursor: pointer;
                padding: 0;
                text-align: left;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .home-store-badge {
                font-size: 12px;
                font-weight: 900;
                padding: 4px 8px;
                border-radius: 999px;
                background: #f3f4f6;
                color: #111827;
                white-space: nowrap;
            }
            .home-store-detail {
                margin-left: auto;
                border: none;
                background: #111827;
                color: #fff;
                font-weight: 900;
                padding: 6px 10px;
                border-radius: 999px;
                cursor: pointer;
                white-space: nowrap;
            }
            .home-store-meta {
                margin-top: 6px;
                font-size: 13px;
                color: #6b7280;
                font-weight: 700;
            }

            /* =========================
               í™ˆ íŒì—… ì„¹ì…˜
               ========================= */
            .popup-section { margin-top: 18px; overflow: hidden}

            .btn-allview {
                text-decoration: none;
                font-weight: 900;
                color: #111827;
                padding: 10px 14px;
                border-radius: 999px;
                border: 1px solid #e5e7eb;
            }
            .btn-allview:hover { background: #f3f4f6; }

            /* âœ… Swiper: 3ê°œì”© + ë²„íŠ¼ì´ ì¹´ë“œ ì•ˆ ê°€ë¦¬ì§€ ì•Šê²Œ "ì–‘ìª½ íŒ¨ë”© í™•ë³´" */
            .popupSwiper{
                position: relative;
                overflow: hidden;
                padding: 6px 56px 30px; /* â† ì–‘ë ë²„íŠ¼ ìë¦¬ í™•ë³´ */
                width: 100%;
                max-width: 100%;
            }
            .popupSwiper .swiper-wrapper{ align-items: stretch; }
            .popupSwiper .swiper-slide{ height: auto; }

            /* âœ… ë²„íŠ¼: ì–‘ ë, ì¹´ë“œ ì•ˆ ê°€ë¦¬ê²Œ */
            .popupSwiper .swiper-button-prev,
            .popupSwiper .swiper-button-next{
                width: 42px;
                height: 42px;
                border-radius: 999px;
                background: rgba(255,255,255,0.95);
                border: 1px solid #e5e7eb;
                box-shadow: 0 10px 20px rgba(0,0,0,0.10);
                top: 50%;
                transform: translateY(-55%);
            }
            .popupSwiper .swiper-button-prev{ left: 10px; }
            .popupSwiper .swiper-button-next{ right: 10px; }

            .popupSwiper .swiper-button-prev::after,
            .popupSwiper .swiper-button-next::after{
                font-size: 16px;
                font-weight: 900;
                color: #111827;
            }

            .popupSwiper .swiper-pagination{
                bottom: 6px !important;
            }

            /* âœ… í™ˆ íŒì—… ì¹´ë“œ (ë‹¤ë¥¸ í˜ì´ì§€ë‘ ì¶©ëŒ ë°©ì§€ ìœ„í•´ home- prefix) */
            .home-popup-card{
                border-radius: 18px;
                overflow: hidden;
                border: 1px solid #eef2f7;
                box-shadow: 0 10px 26px rgba(0,0,0,0.06);
                background: #fff;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            .home-popup-img{
                height: 240px;
                background: #f3f4f6;
                background-size: cover;
                background-position: center;
                position: relative;
            }
            .home-popup-badge{
                position: absolute;
                top: 12px;
                left: 12px;
                background: rgba(255,255,255,0.92);
                border: 1px solid #e5e7eb;
                padding: 6px 10px;
                border-radius: 999px;
                font-weight: 900;
                display: inline-flex;
                gap: 8px;
                align-items: center;
            }
            .home-popup-dot{
                width: 8px; height: 8px; border-radius: 50%;
                background: #22c55e;
            }
            .home-popup-dot.upcoming { background: #3b82f6; }
            .home-popup-dot.ended { background: #9ca3af; }

            .home-popup-info{
                padding: 14px 14px 16px;
                display: flex;
                flex-direction: column;
                gap: 6px;
                flex: 1;
            }
            .home-popup-title{
                margin: 0;
                font-weight: 1000;
                font-size: 16px;
            }
            .home-popup-place,
            .home-popup-date{
                margin: 0;
                color: #6b7280;
                font-weight: 800;
                font-size: 13px;
            }
            .home-popup-cta{
                display: inline-flex;
                margin-top: 10px;
                width: fit-content;
                text-decoration: none;
                background: #111827;
                color: #fff;
                font-weight: 900;
                padding: 10px 12px;
                border-radius: 12px;
            }
            .home-popup-card,
            .home-popup-img,
            .home-popup-info {
                width: 100% !important;     /* í˜¹ì‹œ 100vw ë¨¹ëŠ”ê²Œ ìˆì–´ë„ ë®ì–´ì”€ */
                max-width: 100% !important;
            }
            /* =========================
               ë¬¸ì˜ FAB
               ========================= */
            .fab {
                position: fixed;
                right: 22px;
                bottom: 22px;
                display: inline-flex;
                align-items: center;
                gap: 10px;
                text-decoration: none;
                background: #111827;
                color: #fff;
                padding: 12px 14px;
                border-radius: 999px;
                font-weight: 900;
                box-shadow: 0 12px 26px rgba(0,0,0,0.18);
                z-index: 9999;
            }
            .fab-icon { font-size: 16px; }

            /* =========================
               ë°˜ì‘í˜•
               ========================= */
            @media (max-width: 980px) {
                .home-search-row { grid-template-columns: 1fr; }
                .home-map-grid { grid-template-columns: 1fr; }
                .home-store-body { max-height: 320px; }

                .popupSwiper{ padding: 6px 44px 28px; }
                .home-popup-img{ height: 220px; }
            }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <!-- =============================
         ì£¼ë³€ êµ¿ì¦ˆë§¤ì¥ ì°¾ê¸°
    ============================== -->
    <section class="card map-section">
        <div class="card-header">
            <div class="card-title">
                <span>ì£¼ë³€ êµ¿ì¦ˆë§¤ì¥ ì°¾ê¸°</span>
                <span class="pill pill-blue">BETA</span>
            </div>
        </div>


        <div class="home-map-grid">
            <div class="home-map">
                <iframe th:src="@{/goods/map}"
                        title="ë§¤ì¥ ì§€ë„"
                        loading="lazy"></iframe>
            </div>

            <aside class="home-store-panel">
                <div class="home-store-head">ë§¤ì¥ ëª©ë¡</div>
                <div id="mapSideList" class="home-store-body">
                    <div class="home-store-empty">
                        ê²€ìƒ‰í•˜ë©´ ì—¬ê¸°ì— ë§¤ì¥ ëª©ë¡ì´ ë– ìš”.
                    </div>
                </div>
            </aside>
        </div>
    </section>

    <!-- =============================
         ì§„í–‰ì¤‘ì¸ íŒì—…ìŠ¤í† ì–´
    ============================== -->
    <section class="card popup-section">
        <div class="card-header">
            <div class="card-title">
                <span>ì§„í–‰ì¤‘ì¸ íŒì—…ìŠ¤í† ì–´</span>
                <span class="pill pill-purple">POP-UP</span>
            </div>

            <a class="btn-allview"
               th:href="@{/popupstore/list.do(page=0,size=10)}">
                ì „ì²´ë³´ê¸° <span style="font-weight:900;">â€º</span>
            </a>
        </div>

        <div class="swiper popupSwiper">
            <div class="swiper-wrapper">

                <div class="swiper-slide"
                     th:each="popup : ${activePopupList}"
                     th:onclick="'location.href=\'/popupstore/' + ${popup.id} + '/detail.do\''">

                    <div class="home-popup-card">

                        <div class="home-popup-img"
                             th:style="${popup.bannerImageUrl != null}
                                ? |background-image:url(${popup.bannerImageUrl});|
                                : ''">

                            <div class="home-popup-badge"
                                 th:with="
                                    today=${T(java.time.LocalDate).now()},
                                    start=${popup.startDate},
                                    end=${popup.endDate},
                                    isActive=${start != null and end != null and (not today.isBefore(start)) and (not today.isAfter(end))},
                                    isUpcoming=${start != null and today.isBefore(start)}
                                 ">

                                <span class="home-popup-dot"
                                      th:classappend="${isUpcoming} ? ' upcoming' : (${isActive} ? '' : ' ended')"></span>

                                <span th:if="${isUpcoming}">ì˜ˆì •</span>
                                <span th:if="${!isUpcoming and isActive}">ì§„í–‰ì¤‘</span>
                                <span th:if="${!isUpcoming and !isActive}">ì¢…ë£Œ</span>
                            </div>
                        </div>

                        <div class="home-popup-info">
                            <p class="home-popup-title" th:text="${popup.title}">íŒì—… ì œëª©</p>
                            <p class="home-popup-place"
                               th:text="${popup.placeName != null ? popup.placeName : popup.regionName}">
                                ì¥ì†Œëª…
                            </p>
                            <p class="home-popup-date"
                               th:text="|${popup.startDate} ~ ${popup.endDate}|">
                                ê¸°ê°„
                            </p>

                            <a class="home-popup-cta"
                               th:href="@{|/popupstore/${popup.id}/detail.do|}"
                               onclick="event.stopPropagation();">
                                ìì„¸íˆ ë³´ê¸°
                            </a>
                        </div>

                    </div>
                </div>

            </div>

            <!-- âœ… ë²„íŠ¼ì€ íŒì—… ì¹´ë“œ ì•ˆ ê°€ë¦¬ê²Œ ì–‘ë -->
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>

            <div class="swiper-pagination"></div>
        </div>
    </section>

    <!-- ë¬¸ì˜ Â· AI ìƒë‹´ -->
    <a th:href="@{/help}" class="fab">
        <span class="fab-icon">ğŸ’¬</span>
        <span class="fab-text">ë¬¸ì˜ Â· AI ìƒë‹´</span>
    </a>

</div>

<th:block layout:fragment="script">
    <!-- Swiper JS (ë ˆì´ì•„ì›ƒì—ì„œ ì´ë¯¸ ë¡œë“œ ì¤‘ì´ë©´ ì´ ì¤„ì€ ë¹¼ë„ ë¨) -->


    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // âœ… íŒì—… ìŠ¤ì™€ì´í¼ (ìŠ¬ë¼ì´ë“œ ê°œìˆ˜ì— ë§ì¶° ìë™)
            const slideCount = document.querySelectorAll(".popupSwiper .swiper-slide").length;

            new Swiper(".popupSwiper", {
                slidesPerView: Math.min(3, slideCount),
                slidesPerGroup: 1,
                spaceBetween: 24,

                // âœ… ì™¼ìª½ìœ¼ë¡œ ìë™ ìŠ¬ë¼ì´ìŠ¤ (ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ë©° í™”ë©´ì´ ì™¼ìª½ìœ¼ë¡œ ë°€ë¦¼)
                autoplay: {
                    delay: 2500,              // 2.5ì´ˆë§ˆë‹¤ ì´ë™ (ì›í•˜ë©´ ë°”ê¿”)
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true
                },

                loop: slideCount > 3,
                speed: 650,
                grabCursor: true,
                watchOverflow: true,
                simulateTouch: true,

                // âœ… ë§ˆìš°ìŠ¤ íœ ë¡œë„ ì¢Œìš° ì´ë™(ì›í•˜ë©´ ìœ ì§€)
                mousewheel: { forceToAxis: true },

                navigation: {
                    nextEl: ".popupSwiper .swiper-button-next",
                    prevEl: ".popupSwiper .swiper-button-prev"
                },
                pagination: {
                    el: ".popupSwiper .swiper-pagination",
                    clickable: true
                },

                breakpoints: {
                    0:   { slidesPerView: Math.min(1.1, slideCount), spaceBetween: 14 },
                    680: { slidesPerView: Math.min(2,   slideCount), spaceBetween: 18 },
                    840: { slidesPerView: Math.min(3,   slideCount), spaceBetween: 24 }
                }
            });
            // âœ… ì§€ë„ iframe â†” ì˜¤ë¥¸ìª½ ëª©ë¡
            (function () {
                const sideList = document.getElementById('mapSideList');
                const iframe = document.querySelector('.home-map iframe');
                const qPlace = document.getElementById('qPlace');
                const qGoods = document.getElementById('qGoods');
                const btnMyPos = document.getElementById('btnMyPos');

                function getIframeOrigin(){
                    try{
                        if(!iframe) return null;
                        return new URL(iframe.getAttribute('src') || iframe.src, window.location.href).origin;
                    }catch(e){
                        return null;
                    }
                }

                function sendSearch(){
                    if (!iframe || !iframe.contentWindow) return;
                    iframe.contentWindow.postMessage({
                        type: 'MAP_SEARCH',
                        place: (qPlace?.value || '').trim(),
                        goods: (qGoods?.value || '').trim()
                    }, '*');
                }

                function sendMyPos(){
                    if (!iframe || !iframe.contentWindow) return;
                    iframe.contentWindow.postMessage({ type:'MAP_MY_POSITION' }, '*');
                }

                qPlace?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendSearch(); });
                qGoods?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendSearch(); });
                btnMyPos?.addEventListener('click', sendMyPos);

                function renderPlaces(places){
                    if (!sideList) return;
                    const list = Array.isArray(places) ? places : [];
                    sideList.innerHTML = '';

                    if(!list.length){
                        sideList.innerHTML = '<div class="home-store-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const ul = document.createElement('ul');
                    ul.className = 'home-store-list';

                    list.forEach((p, idx)=>{
                        const li = document.createElement('li');
                        li.className = 'home-store-item';

                        const storeId = (p.storeId !== undefined && p.storeId !== null) ? p.storeId : p.id;

                        li.innerHTML = `
                          <div class="home-store-line1">
                            <button type="button" class="home-store-name js-focus">${p.name || 'ì´ë¦„ ì—†ìŒ'}</button>
                            ${p.source ? `<span class="home-store-badge">${p.source === 'STORE' ? 'êµ¿ì¦ˆìƒµ(ë”ì¿ ì¿ )' : 'ë„¤ì´ë²„'}</span>` : ''}
                            ${(p.source === 'STORE' && storeId != null)
                            ? `<button type="button" class="home-store-detail" data-store-id="${storeId}">ìƒì„¸ë³´ê¸°</button>`
                            : ''}
                          </div>
                          <div class="home-store-meta">${p.roadAddress || p.address || ''}</div>
                        `;

                        li.querySelector('.js-focus').addEventListener('click', ()=>{
                            iframe?.contentWindow?.postMessage({ type:'MAP_FOCUS_PLACE', idx }, '*');
                        });

                        const detailBtn = li.querySelector('.home-store-detail');
                        if(detailBtn){
                            detailBtn.addEventListener('click', (e)=>{
                                e.stopPropagation();
                                const id = detailBtn.dataset.storeId;
                                if(id) window.location.href = `/goods/store/${encodeURIComponent(id)}`;
                            });
                        }

                        ul.appendChild(li);
                    });

                    sideList.appendChild(ul);
                }

                window.addEventListener('message', (event)=>{
                    const iframeOrigin = getIframeOrigin();
                    if(iframeOrigin && event.origin !== iframeOrigin) return;

                    const data = event.data;
                    if(!data || data.type !== 'MAP_SEARCH_RESULTS') return;
                    renderPlaces(data.places || []);
                });

            })();
        });
    </script>
</th:block>

</body>
</html>