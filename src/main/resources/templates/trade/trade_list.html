<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/trade_fragment/layout}">
<head>
    <meta charset="UTF-8" />
    <title>êµ¿ì¦ˆê±°ë˜ | ë”ì¿ ì¿ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <style>
        /* ===== ê²€ìƒ‰ ì˜ì—­ (ì˜ˆì „ ì¹´í…Œê³ ë¦¬ ìë¦¬ì—) ===== */
        .trade-filter {
            background: white;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }

        .trade-search-form {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .trade-search-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 9px 14px;
            font-size: 13px;
            outline: none;
        }

        .trade-search-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 0 1px rgba(99,102,241,0.18);
        }

        .trade-search-button {
            border-radius: 999px;
            border: none;
            background: var(--purple);
            color: white;
            padding: 0 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .trade-search-button:hover {
            background: var(--purple-deep);
        }

    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- ===== ê²€ìƒ‰ (ì˜ˆì „ ì¹´í…Œê³ ë¦¬ ìë¦¬) ===== -->
    <div class="trade-filter">
        <form class="trade-search-form" th:action="@{/trade}" method="get">
            <input type="text"
                   name="keyword"
                   class="trade-search-input"
                   placeholder="êµ¿ì¦ˆëª…, ì œëª©, ì§€ì—­ ê²€ìƒ‰"
                   th:value="${keyword}">
            <button type="submit" class="trade-search-button">ê²€ìƒ‰</button>
        </form>
        <div class="view-buttons">
            <button class="view-btn" id="listViewBtn">â‰¡</button>
            <button class="view-btn" id="gridViewBtn">â–¢</button>
            <button class="view-btn" id="sortBtn">â‡…</button>
        </div>
        <div id="sortMenu" class="sort-menu">
            <a href="?sort=like">â¤ï¸ ì°œ ë§ì€ ìˆœ</a>
            <a href="?sort=view">ğŸ‘€ ì¡°íšŒ ë§ì€ ìˆœ</a>
            <a href="?sort=latest">ğŸ•’ ìµœì‹ ìˆœ</a>
        </div>
    </div>

    <!-- ğŸ”¥ íŒë§¤ì ì „ìš© ë¦¬ìŠ¤íŠ¸ì¼ ë•Œë§Œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ -->
    <div th:if="${sellerName != null}"
         style="padding: 8px 18px 0; font-size: 13px; color: var(--text-sub);">
        <span th:text="${sellerName}">íŒë§¤ì</span> ë‹˜ì˜ íŒë§¤ ìƒí’ˆ
    </div>

    <!-- ===== LIST ===== -->
    <div class="trade-list">

        <div class="trade-card"
             th:each="post : ${page.content}"
             th:onclick="|location.href='/trade/${post.id}/article/detail.do'|">

            <!-- ì¸ë„¤ì¼ -->
            <img class="trade-thumb"
                 th:src="${post.thumbnailUrl != null ? post.thumbnailUrl : '/images/dummy/noimg.png'}" />

            <!-- ë‚´ìš© -->
            <div class="trade-info">
                <div>
                    <div class="trade-title" th:text="${post.title}">ìƒí’ˆ ì œëª©</div>

                    <div class="trade-meta">
                        <span th:text="${post.region}"></span> Â·
                        <span th:text="${post.timeAgo}"></span>
                    </div>

                    <!-- â¤ï¸ ì°œ Â· ğŸ’¬ ì±„íŒ… Â· ğŸ‘€ ì¡°íšŒ ìˆœì„œ -->
                    <div class="trade-stats">
                        â™¥ <span th:text="${post.likeCount}">0</span> ì°œ Â·
                        ğŸ’¬ <span th:text="${post.chatCount}">0</span> ì±„íŒ… Â·
                        ğŸ‘€ <span th:text="${post.viewCount}">0</span> ì¡°íšŒ
                    </div>
                </div>

                <div class="trade-price"
                     th:text="${post.priceText}">
                    ê°€ê²©
                </div>
            </div>
        </div>

    </div>

    <!-- ===== ê¸€ì“°ê¸° ë²„íŠ¼ ===== -->
    <a href="/trade/1/write" class="write-btn">+ ê¸€ì“°ê¸°</a>

</div>

<!-- ================= í•˜ë‹¨ JS (ê¸°ì¡´ ë„¤ë¹„/ë±ƒì§€ + ìƒˆ ê¸€ ì‹¤ì‹œê°„) ================= -->
<script layout:fragment="script">
    const listBtn = document.getElementById("listViewBtn");
    const gridBtn = document.getElementById("gridViewBtn");

    listBtn.addEventListener("click", () => {
        document.body.classList.remove("grid-mode");
        listBtn.classList.add("active");
        gridBtn.classList.remove("active");
    });

    gridBtn.addEventListener("click", () => {
        document.body.classList.add("grid-mode");
        gridBtn.classList.add("active");
        listBtn.classList.remove("active");
    });
    document.getElementById("sortBtn").addEventListener("click", () => {
        const menu = document.getElementById("sortMenu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    });

    (function () {

        const nav = document.querySelector(".bottom-nav");
        const items = nav.querySelectorAll(".nav-item");
        const badge = document.getElementById("chatBadge");
        const STORAGE_KEY = "duckuku_unread_msg";

        /* --- í™œì„±í™” í˜ì´ì§€ ìë™ ê°ì§€ --- */
        const pathname = window.location.pathname;

        let active = "home";
        if (pathname.startsWith("/chat")) active = "chat";
        else if (pathname.startsWith("/mypage")) active = "mypage";

        items.forEach(i => {
            if (i.dataset.page === active) i.classList.add("active");
        });

        /* --- ì±„íŒ… í´ë¦­í•˜ë©´ ì½ìŒ ì²˜ë¦¬ --- */
        const chatItem = document.querySelector('.nav-item[data-page="chat"]');
        if (chatItem) {
            chatItem.addEventListener("click", () => {
                if (badge) badge.style.display = "none";
                localStorage.setItem(STORAGE_KEY, "0");
            });
        }

    })();


<!-- ğŸ”¥ ìƒˆ ê²Œì‹œê¸€ / ìƒˆ ì±„íŒ…ë°© ì‹¤ì‹œê°„ ë°˜ì˜ìš© WebSocket êµ¬ë… -->

    (function () {
        const socket = new SockJS("/ws-chat");      // WebSocketConfig endpoint
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            /* ğŸ“Œ 1) ìƒˆ ê²Œì‹œê¸€ ì˜¬ë¼ì™”ì„ ë•Œ (ì´ë¯¸ ìˆë˜ ê¸°ëŠ¥) */
            stompClient.subscribe("/sub/trade.list", function (msg) {
                console.log("ğŸ“¢ ìƒˆ ê²Œì‹œê¸€ ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();   // ìƒˆ ê¸€ ë³´ë ¤ê³  ì „ì²´ ë¦¬ë¡œë“œ
            });

            /* ğŸ“Œ 2) ìƒˆ ì±„íŒ…ë°© ìƒê²¼ì„ ë•Œ (ì±„íŒ… ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜) */
            stompClient.subscribe("/sub/trade.chat", function (msg) {
                console.log("ğŸ’¬ ìƒˆ ì±„íŒ…ë°© ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();   // ì±„íŒ… ìˆ˜, ì°œ ìˆ˜, ì¡°íšŒìˆ˜ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        });
    })();
</script>

</body>
</html>