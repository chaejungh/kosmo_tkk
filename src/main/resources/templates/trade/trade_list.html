<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/tkk_fragment/layout}">

<head>
    <th:block layout:fragment="head">
        <style>
            :root{
                --bg:#f4f5f7;
                --card:#ffffff;
                --text:#111827;
                --sub:#6b7280;
                --border:#e5e7eb;

                --purple:#ff6b86;      /* âœ… ì¿ ì¿ ë§ˆì¼“ í•‘í¬ í†¤ìœ¼ë¡œ ë§ì¶¤ */
                --purple-deep:#ff4d6d;

                --shadow: 0 10px 28px rgba(17,24,39,.08);
                --radius:18px;
            }
            *{box-sizing:border-box}

            /* âœ… í™ˆì´ë‘ ë¹„ìŠ·í•˜ê²Œ ë„“ê²Œ */
            .trade-shell{
                max-width: 1320px;
                margin: 0 auto;
                padding: 18px 16px 60px;
            }

            /* ===== ìƒë‹¨ íƒ€ì´í‹€ ===== */
            .trade-title{
                font-size: 26px;
                font-weight: 900;
                color: var(--text);
                margin: 4px 0 4px;
                letter-spacing: -.4px;
            }
            .trade-sub{
                color: var(--sub);
                font-size: 13px;
                margin: 0 0 14px;
            }

            /* ===== ìƒë‹¨ íˆ´ë°”(ë²„íŠ¼/ê²€ìƒ‰) ===== */
            .trade-toolbar{
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 18px;
                box-shadow: var(--shadow);
                padding: 14px;
                display:flex;
                gap: 12px;
                align-items:center;
                flex-wrap:wrap;
            }

            .trade-tabs{
                display:flex;
                gap:10px;
                align-items:center;
                flex-wrap:wrap;
            }
            .trade-tab{
                border: 1px solid var(--border);
                background:#fff;
                border-radius: 14px;
                padding: 10px 14px;
                font-size: 13px;
                font-weight: 800;
                cursor:pointer;
                display:flex;
                gap:8px;
                align-items:center;
                box-shadow: 0 2px 10px rgba(17,24,39,.03);
            }
            .trade-tab.active{
                background: var(--purple);
                border-color: var(--purple);
                color:#fff;
            }

            .trade-search-form{
                flex: 1;
                min-width: 320px;
                display:flex;
                gap: 10px;
                align-items:center;
            }
            .trade-search{
                flex: 1;
                display:flex;
                align-items:center;
                gap: 10px;
                border: 1px solid var(--border);
                border-radius: 999px;
                padding: 10px 14px;
                background:#fff;
            }
            .trade-search .ico{opacity:.6}
            .trade-search input{
                border:none;
                outline:none;
                width:100%;
                font-size: 13px;
                color: var(--text);
                background: transparent;
            }
            .trade-search input:focus{
                outline:none;
            }

            .trade-search-button{
                border:none;
                border-radius: 999px;
                background: var(--purple);
                color:#fff;
                font-weight: 800;
                font-size: 13px;
                padding: 10px 16px;
                cursor:pointer;
                box-shadow: 0 10px 18px rgba(255,107,134,.25);
                white-space: nowrap;
            }
            .trade-search-button:hover{background: var(--purple-deep);}

            .trade-actions{
                display:flex;
                gap:8px;
                align-items:center;
                margin-left:auto;
                position: relative;
            }
            .view-btn{
                width: 38px;
                height: 38px;
                border-radius: 12px;
                border: 1px solid var(--border);
                background:#fff;
                cursor:pointer;
                display:flex;
                align-items:center;
                justify-content:center;
                font-weight: 900;
                color: var(--text);
            }
            .view-btn.active{
                background:#111827;
                border-color:#111827;
                color:#fff;
            }

            /* ì •ë ¬ ë©”ë‰´ */
            .sort-menu{
                position:absolute;
                right:0;
                top: 46px;
                min-width: 160px;
                background:#fff;
                border:1px solid var(--border);
                border-radius: 14px;
                box-shadow: var(--shadow);
                padding: 8px;
                display:none;
                z-index: 50;
            }
            .sort-menu a{
                display:block;
                padding: 10px 12px;
                border-radius: 10px;
                color: var(--text);
                text-decoration:none;
                font-size: 13px;
                font-weight: 700;
            }
            .sort-menu a:hover{background:#f3f4f6}

            /* íŒë§¤ì ì•ˆë‚´ */
            .seller-hint{
                padding: 10px 4px 0;
                font-size: 13px;
                color: var(--sub);
            }

            /* ===== ë¦¬ìŠ¤íŠ¸ ë˜í¼ ===== */
            .trade-list{
                margin-top: 16px;
            }

            /* âœ… GRID ê¸°ë³¸(ì°¸ê³  ì´ë¯¸ì§€ì²˜ëŸ¼ 4ì—´ ëŠë‚Œ) */
            .trade-list-inner{
                display:grid;
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 16px;
            }
            @media (max-width: 1200px){
                .trade-list-inner{grid-template-columns: repeat(3, minmax(0,1fr));}
            }
            @media (max-width: 900px){
                .trade-list-inner{grid-template-columns: repeat(2, minmax(0,1fr));}
            }
            @media (max-width: 600px){
                .trade-list-inner{grid-template-columns: 1fr;}
            }

            /* âœ… LIST ëª¨ë“œ(ê°€ë¡œ ì¹´ë“œ) */
            body.list-mode .trade-list-inner{
                grid-template-columns: 1fr;
            }

            .trade-card{
                background:#fff;
                border: 1px solid var(--border);
                border-radius: 18px;
                box-shadow: var(--shadow);
                overflow:hidden;
                cursor:pointer;
                display:flex;
                flex-direction: column;
                transition: transform .08s ease;
            }
            .trade-card:hover{transform: translateY(-1px);}

            /* ë¦¬ìŠ¤íŠ¸ ëª¨ë“œì¼ ë•ŒëŠ” ê°€ë¡œ ë°°ì¹˜ */
            body.list-mode .trade-card{
                flex-direction: row;
                align-items: stretch;
            }

            .trade-thumb{
                width:100%;
                height: 240px;
                object-fit: cover;
                background:#111827;
                display:block;
            }
            body.list-mode .trade-thumb{
                width: 220px;
                height: 160px;
                flex: 0 0 auto;
            }

            .trade-info{
                padding: 12px 14px 14px;
                display:flex;
                justify-content: space-between;
                gap: 14px;
                flex: 1;
                min-width: 0;
            }

            .trade-title-text{
                font-size: 14px;
                font-weight: 900;
                color: var(--text);
                line-height: 1.25;
                margin-bottom: 8px;
                white-space: nowrap;
                overflow:hidden;
                text-overflow: ellipsis;
            }
            body.list-mode .trade-title-text{
                font-size: 15px;
                white-space: normal;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow:hidden;
            }

            .trade-meta{
                color: var(--sub);
                font-size: 12px;
                margin-bottom: 8px;
            }
            .trade-stats{
                color: var(--sub);
                font-size: 12px;
                display:flex;
                gap: 10px;
                flex-wrap:wrap;
            }

            .trade-price{
                font-weight: 900;
                color: var(--text);
                font-size: 16px;
                white-space: nowrap;
                align-self: flex-end;
            }
            body.list-mode .trade-price{
                align-self: center;
                font-size: 18px;
            }

            /* âœ… ìš°ìƒë‹¨ ì°œ ì•„ì´ì½˜ ëŠë‚Œ(ì›í•˜ë©´ ì‹¤ì œ ë²„íŠ¼ìœ¼ë¡œ êµì²´ ê°€ëŠ¥) */
            .trade-like-chip{
                position:absolute;
                top:10px;
                right:10px;
                width: 34px;
                height: 34px;
                border-radius: 999px;
                border: 1px solid rgba(255,255,255,.65);
                background: rgba(255,255,255,.85);
                display:flex;
                align-items:center;
                justify-content:center;
                font-weight: 900;
                box-shadow: 0 8px 18px rgba(17,24,39,.10);
            }

            .trade-media{
                position: relative;
            }

            /* ===== ê¸€ì“°ê¸° ë²„íŠ¼ ===== */
            .write-btn{
                position: fixed;
                right: 18px;
                bottom: 18px;
                background: var(--purple);
                color:#fff;
                border:none;
                border-radius: 999px;
                padding: 14px 18px;
                font-weight: 900;
                text-decoration:none;
                box-shadow: 0 14px 28px rgba(255,107,134,.35);
            }
            .write-btn:hover{background: var(--purple-deep);}
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <div class="trade-shell">

        <div class="trade-title">ì¿ ì¿ ë§ˆì¼“</div>
        <div class="trade-sub">ì• ë‹ˆ êµ¿ì¦ˆ ì¤‘ê³ ê±°ë˜ ì „ë¬¸ ë§ˆì¼“</div>

        <!-- ===== íˆ´ë°” (íƒ­ + ê²€ìƒ‰ + ë³´ê¸°/ì •ë ¬) ===== -->
        <div class="trade-toolbar">

            <!-- (ì˜µì…˜) íƒ­ UI: í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ ê°€ëŠ¥ -->
            <div class="trade-tabs">
                <button class="trade-tab active" type="button" onclick="location.href='/trade'">ğŸ›ï¸ ê±°ë˜ ìƒí’ˆ</button>
                <button class="trade-tab" type="button" onclick="location.href='/chat'">ğŸ’¬ ì±„íŒ…</button>
            </div>

            <!-- ê²€ìƒ‰ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) -->
            <form class="trade-search-form" th:action="@{/trade}" method="get">
                <div class="trade-search">
                    <span class="ico">ğŸ”</span>
                    <input type="text"
                           name="keyword"
                           placeholder="êµ¿ì¦ˆëª…, ì œëª©, ì§€ì—­ ê²€ìƒ‰"
                           th:value="${keyword}">
                </div>
                <button type="submit" class="trade-search-button">ê²€ìƒ‰</button>
            </form>

            <!-- ë³´ê¸°/ì •ë ¬ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) -->
            <div class="trade-actions">
                <button class="view-btn" id="listViewBtn" type="button" title="ë¦¬ìŠ¤íŠ¸">â‰¡</button>
                <button class="view-btn active" id="gridViewBtn" type="button" title="ê·¸ë¦¬ë“œ">â–¢</button>
                <button class="view-btn" id="sortBtn" type="button" title="ì •ë ¬">â‡…</button>

                <div id="sortMenu" class="sort-menu">
                    <a th:href="@{/trade(sort='like', keyword=${keyword})}">â¤ï¸ ì°œ ë§ì€ ìˆœ</a>
                    <a th:href="@{/trade(sort='view', keyword=${keyword})}">ğŸ‘€ ì¡°íšŒ ë§ì€ ìˆœ</a>
                    <a th:href="@{/trade(sort='latest', keyword=${keyword})}">ğŸ•’ ìµœì‹ ìˆœ</a>
                </div>
            </div>
        </div>

        <!-- ğŸ”¥ íŒë§¤ì ì „ìš© ë¦¬ìŠ¤íŠ¸ì¼ ë•Œë§Œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ -->
        <div class="seller-hint" th:if="${sellerName != null}">
            <b th:text="${sellerName}">íŒë§¤ì</b> ë‹˜ì˜ íŒë§¤ ìƒí’ˆ
        </div>

        <!-- ===== LIST ===== -->
        <div class="trade-list">

            <div class="trade-list-inner">

                <div class="trade-card"
                     th:each="post : ${page.content}"
                     th:onclick="|location.href='/trade/${post.id}/article/detail.do'|">

                    <div class="trade-media">
                        <!-- ì¸ë„¤ì¼ -->
                        <img class="trade-thumb"
                             th:src="${#strings.isEmpty(post.thumbnailUrl) ? '/images/dummy/noimg.png' : post.thumbnailUrl}"
                             alt="thumb">

                        <!-- (UI) ì°œ ì•„ì´ì½˜ ëŠë‚Œ -->
                        <div class="trade-like-chip">â™¡</div>
                    </div>

                    <!-- ë‚´ìš© -->
                    <div class="trade-info">
                        <div style="min-width:0;">
                            <div class="trade-title-text" th:text="${post.title}">ìƒí’ˆ ì œëª©</div>

                            <div class="trade-meta">
                                <span th:text="${post.region}">ì§€ì—­</span>
                                Â·
                                <span th:text="${post.timeAgo}">në¶„ ì „</span>
                            </div>

                            <div class="trade-stats">
                                <span>â¤ï¸ <b th:text="${post.likeCount}">0</b></span>
                                <span>ğŸ’¬ <b th:text="${post.chatCount}">0</b></span>
                                <span>ğŸ‘€ <b th:text="${post.viewCount}">0</b></span>
                            </div>
                        </div>

                        <div class="trade-price" th:text="${post.priceText}">ê°€ê²©</div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- ===== ê¸€ì“°ê¸° ë²„íŠ¼(ê¸°ì¡´ ìœ ì§€) ===== -->
    <a href="/trade/1/write" class="write-btn">+ ê¸€ì“°ê¸°</a>

</div>

<!-- ================= í•˜ë‹¨ JS (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) ================= -->
<script layout:fragment="script">
    const listBtn = document.getElementById("listViewBtn");
    const gridBtn = document.getElementById("gridViewBtn");

    // âœ… ê¸°ë³¸ì€ ê·¸ë¦¬ë“œ
    document.body.classList.remove("list-mode");

    listBtn.addEventListener("click", () => {
        document.body.classList.add("list-mode");
        listBtn.classList.add("active");
        gridBtn.classList.remove("active");
    });

    gridBtn.addEventListener("click", () => {
        document.body.classList.remove("list-mode");
        gridBtn.classList.add("active");
        listBtn.classList.remove("active");
    });

    document.getElementById("sortBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        const menu = document.getElementById("sortMenu");
        menu.style.display = (menu.style.display === "block") ? "none" : "block";
    });

    document.addEventListener("click", () => {
        const menu = document.getElementById("sortMenu");
        if(menu) menu.style.display = "none";
    });

    (function () {
        const nav = document.querySelector(".bottom-nav");
        if(!nav) return;

        const items = nav.querySelectorAll(".nav-item");
        const badge = document.getElementById("chatBadge");
        const STORAGE_KEY = "duckuku_unread_msg";

        const pathname = window.location.pathname;

        let active = "home";
        if (pathname.startsWith("/chat")) active = "chat";
        else if (pathname.startsWith("/mypage")) active = "mypage";

        items.forEach(i => {
            if (i.dataset.page === active) i.classList.add("active");
        });

        const chatItem = document.querySelector('.nav-item[data-page="chat"]');
        if (chatItem) {
            chatItem.addEventListener("click", () => {
                if (badge) badge.style.display = "none";
                localStorage.setItem(STORAGE_KEY, "0");
            });
        }
    })();

    /* ğŸ”¥ ìƒˆ ê²Œì‹œê¸€ / ìƒˆ ì±„íŒ…ë°© ì‹¤ì‹œê°„ ë°˜ì˜ìš© WebSocket êµ¬ë… (ê¸°ì¡´ ìœ ì§€) */
    (function () {
        if (typeof SockJS === "undefined" || typeof Stomp === "undefined") return;

        const socket = new SockJS("/ws-chat");
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            stompClient.subscribe("/sub/trade.list", function (msg) {
                console.log("ğŸ“¢ ìƒˆ ê²Œì‹œê¸€ ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();
            });

            stompClient.subscribe("/sub/trade.chat", function (msg) {
                console.log("ğŸ’¬ ìƒˆ ì±„íŒ…ë°© ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();
            });
        });
    })();
</script>

</body>
</html>