<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>êµ¿ì¦ˆê±°ë˜ | ë”ì¿ ì¿ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ğŸ”¥ WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì±„íŒ…ì´ë‘ ë™ì¼) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        :root {
            --purple: #6366f1;
            --purple-deep: #4f46e5;
            --bg-soft: #f5f3ff;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-sub: #6b7280;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-soft);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* ===== ìƒë‹¨ í—¤ë” ===== */
        .trade-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: white;
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            color: var(--purple);
        }

        .header-title {
            font-size: 15px;
            font-weight: 700;
            margin-left: 6px;
            color: var(--text-main);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== ê²€ìƒ‰ ì˜ì—­ (ì˜ˆì „ ì¹´í…Œê³ ë¦¬ ìë¦¬ì—) ===== */
        .trade-filter {
            background: white;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }

        .trade-search-form {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .trade-search-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 9px 14px;
            font-size: 13px;
            outline: none;
        }

        .trade-search-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 0 1px rgba(99,102,241,0.18);
        }

        .trade-search-button {
            border-radius: 999px;
            border: none;
            background: var(--purple);
            color: white;
            padding: 0 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .trade-search-button:hover {
            background: var(--purple-deep);
        }

        /* ===== ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ===== */
        .trade-list {
            padding: 12px 18px 40px;
        }

        .trade-card {
            background: var(--card-bg);
            border-radius: 14px;
            display: flex;
            gap: 12px;
            padding: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        .trade-card + .trade-card {
            margin-top: 10px;
        }

        .trade-thumb {
            width: 95px;
            height: 95px;
            border-radius: 10px;
            background: #eee;
            object-fit: cover;
        }

        .trade-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .trade-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .trade-meta {
            font-size: 12px;
            color: var(--text-sub);
        }

        /* ì±„íŒ…/ì°œ/ì¡°íšŒ ìˆ«ì ë¼ì¸ */
        .trade-stats {
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-sub);
        }

        .trade-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--purple);
            margin-top: 6px;
        }

        /* ===== ê¸€ì“°ê¸° floating ë²„íŠ¼ ===== */
        .write-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--purple);
            color: white;
            padding: 14px 22px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 30;
            border: none;
            text-decoration: none;
        }

        .write-btn:hover {
            background: var(--purple-deep);
        }

        /* ===== í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: #ffffff;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.12);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            z-index: 50;
        }

        .nav-item {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            text-decoration: none;
            color: var(--text-sub);
            border-right: 1px solid var(--border);
        }

        .nav-item:last-child {
            border-right: none;
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--purple);
            font-weight: 700;
        }

        .badge {
            position: absolute;
            top: 7px;
            right: 28px;
            background: #ff4e4e;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
        }

        .badge.pulse {
            animation: pulseBadge 1.4s infinite;
        }

        @keyframes pulseBadge {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,78,78,0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(255,78,78,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,78,78,0); }
        }
        .trade-search-input {
            max-width: 500px;   /* ğŸ‘ˆ ì…ë ¥ì¹¸ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
        }
        .view-buttons {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .view-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 16px;
        }

        .view-btn.active {
            border-color: #6366f1;
            color: #6366f1;
        }
        /* ì‚¬ì§„í˜• ë³´ê¸° */
        .grid-mode .trade-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }

        .grid-mode .trade-card {
            flex-direction: column;
        }

        .grid-mode .trade-thumb {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #fff;
            border-radius: 10px;
        }

        .sort-menu {
            display: none;
            position: absolute;
            margin-top: 6px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 8px 0;
            width: 140px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .sort-menu a {
            display: block;
            padding: 8px 14px;
            font-size: 13px;
            color: #333;
            text-decoration: none;
        }

        .sort-menu a:hover {
            background: #f5f5f5;
        }

    </style>
</head>
<body>

<!-- ===== í—¤ë” ===== -->
<div class="trade-header">
    <div class="header-left">
        <a th:href="@{/}" class="logo" style="margin-right: 10px;">ë”ì¿ ì¿ </a>
        <a th:href="@{/trade/list.do}" class="logo">êµ¿ì¦ˆê±°ë˜</a>
    </div>

    <!-- âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì¸ / íšŒì›ê°€ì… ë²„íŠ¼ -->
    <div th:if="${nickname == null}">
        <a th:href="@{/auth/login}" class="btn-auth">ë¡œê·¸ì¸</a>
        <a th:href="@{/auth/join}" class="btn-auth btn-auth-primary">íšŒì›ê°€ì…</a>
    </div>
    <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ: ë‹‰ë„¤ì„ + ë¡œê·¸ì•„ì›ƒ -->
    <div class="logged-in-box"
         th:if="${session.loginMember != null or nickname != null}">
                 <span class="welcome-text"
                       th:text="|${session.loginMember != null ? session.loginMember.nickname : nickname} ë‹˜|">
                ë‹‰ë„¤ì„ ë‹˜
                </span>
        <a th:href="@{/auth/logout}" class="btn-auth">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<!-- ===== ê²€ìƒ‰ (ì˜ˆì „ ì¹´í…Œê³ ë¦¬ ìë¦¬) ===== -->
<div class="trade-filter">
    <form class="trade-search-form" th:action="@{/trade}" method="get">
        <input type="text"
               name="keyword"
               class="trade-search-input"
               placeholder="êµ¿ì¦ˆëª…, ì œëª©, ì§€ì—­ ê²€ìƒ‰"
               th:value="${keyword}">
        <button type="submit" class="trade-search-button">ê²€ìƒ‰</button>
    </form>
    <div class="view-buttons">
        <button class="view-btn" id="listViewBtn">â‰¡</button>
        <button class="view-btn" id="gridViewBtn">â–¢</button>
        <button class="view-btn" id="sortBtn">â‡…</button>
    </div>
    <div id="sortMenu" class="sort-menu">
        <a href="?sort=like">â¤ï¸ ì°œ ë§ì€ ìˆœ</a>
        <a href="?sort=view">ğŸ‘€ ì¡°íšŒ ë§ì€ ìˆœ</a>
        <a href="?sort=latest">ğŸ•’ ìµœì‹ ìˆœ</a>
    </div>
</div>

<!-- ğŸ”¥ íŒë§¤ì ì „ìš© ë¦¬ìŠ¤íŠ¸ì¼ ë•Œë§Œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ -->
<div th:if="${sellerName != null}"
     style="padding: 8px 18px 0; font-size: 13px; color: var(--text-sub);">
    <span th:text="${sellerName}">íŒë§¤ì</span> ë‹˜ì˜ íŒë§¤ ìƒí’ˆ
</div>

<!-- ===== LIST ===== -->
<div class="trade-list">

    <div class="trade-card"
         th:each="post : ${page.content}"
         th:onclick="|location.href='/trade/${post.id}/article/detail.do'|">

        <!-- ì¸ë„¤ì¼ -->
        <img class="trade-thumb"
             th:src="${post.thumbnailUrl != null ? post.thumbnailUrl : '/images/dummy/noimg.png'}" />

        <!-- ë‚´ìš© -->
        <div class="trade-info">
            <div>
                <div class="trade-title" th:text="${post.title}">ìƒí’ˆ ì œëª©</div>

                <div class="trade-meta">
                    <span th:text="${post.region}"></span> Â·
                    <span th:text="${post.timeAgo}"></span>
                </div>

                <!-- â¤ï¸ ì°œ Â· ğŸ’¬ ì±„íŒ… Â· ğŸ‘€ ì¡°íšŒ ìˆœì„œ -->
                <div class="trade-stats">
                    â™¥ <span th:text="${post.likeCount}">0</span> ì°œ Â·
                    ğŸ’¬ <span th:text="${post.chatCount}">0</span> ì±„íŒ… Â·
                    ğŸ‘€ <span th:text="${post.viewCount}">0</span> ì¡°íšŒ
                </div>
            </div>

            <div class="trade-price"
                 th:text="${post.priceText}">
                ê°€ê²©
            </div>
        </div>
    </div>

</div>

<!-- ===== ê¸€ì“°ê¸° ë²„íŠ¼ ===== -->
<a href="/trade/1/write" class="write-btn">+ ê¸€ì“°ê¸°</a>

<!-- ===== í•˜ë‹¨ ë„¤ë¹„ ===== -->
<nav class="bottom-nav">

    <a href="/trade/list.do" class="nav-item" data-page="home">
        <span class="icon">ğŸ </span>
        í™ˆ
    </a>

    <a href="/chat/list" class="nav-item" data-page="chat">
        <span class="icon">ğŸ’¬</span>
        ì±„íŒ…ë°©
        <span class="badge pulse" id="chatBadge">3</span>
    </a>

    <a href="/mypage" class="nav-item" data-page="mypage">
        <span class="icon">ğŸ‘¤</span>
        ë‚´ì •ë³´
    </a>

</nav>

<!-- ================= í•˜ë‹¨ JS (ê¸°ì¡´ ë„¤ë¹„/ë±ƒì§€ + ìƒˆ ê¸€ ì‹¤ì‹œê°„) ================= -->
<script>
    const listBtn = document.getElementById("listViewBtn");
    const gridBtn = document.getElementById("gridViewBtn");

    listBtn.addEventListener("click", () => {
        document.body.classList.remove("grid-mode");
        listBtn.classList.add("active");
        gridBtn.classList.remove("active");
    });

    gridBtn.addEventListener("click", () => {
        document.body.classList.add("grid-mode");
        gridBtn.classList.add("active");
        listBtn.classList.remove("active");
    });
    document.getElementById("sortBtn").addEventListener("click", () => {
        const menu = document.getElementById("sortMenu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    });

    (function () {

        const nav = document.querySelector(".bottom-nav");
        const items = nav.querySelectorAll(".nav-item");
        const badge = document.getElementById("chatBadge");
        const STORAGE_KEY = "duckuku_unread_msg";

        /* --- í™œì„±í™” í˜ì´ì§€ ìë™ ê°ì§€ --- */
        const pathname = window.location.pathname;

        let active = "home";
        if (pathname.startsWith("/chat")) active = "chat";
        else if (pathname.startsWith("/mypage")) active = "mypage";

        items.forEach(i => {
            if (i.dataset.page === active) i.classList.add("active");
        });

        /* --- ë±ƒì§€ ì €ì¥ëœ unread ì—¬ë¶€ í™•ì¸ --- */
        const unread = localStorage.getItem(STORAGE_KEY);

        if (unread === "0" && badge) {
            badge.style.display = "none";
        }

        /* --- ì±„íŒ… í´ë¦­í•˜ë©´ ì½ìŒ ì²˜ë¦¬ --- */
        const chatItem = document.querySelector('.nav-item[data-page="chat"]');
        if (chatItem) {
            chatItem.addEventListener("click", () => {
                if (badge) badge.style.display = "none";
                localStorage.setItem(STORAGE_KEY, "0");
            });
        }

    })();
</script>

<!-- ğŸ”¥ ìƒˆ ê²Œì‹œê¸€ / ìƒˆ ì±„íŒ…ë°© ì‹¤ì‹œê°„ ë°˜ì˜ìš© WebSocket êµ¬ë… -->
<script>
    (function () {
        const socket = new SockJS("/ws-chat");      // WebSocketConfig endpoint
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            /* ğŸ“Œ 1) ìƒˆ ê²Œì‹œê¸€ ì˜¬ë¼ì™”ì„ ë•Œ (ì´ë¯¸ ìˆë˜ ê¸°ëŠ¥) */
            stompClient.subscribe("/sub/trade.list", function (msg) {
                console.log("ğŸ“¢ ìƒˆ ê²Œì‹œê¸€ ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();   // ìƒˆ ê¸€ ë³´ë ¤ê³  ì „ì²´ ë¦¬ë¡œë“œ
            });

            /* ğŸ“Œ 2) ìƒˆ ì±„íŒ…ë°© ìƒê²¼ì„ ë•Œ (ì±„íŒ… ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜) */
            stompClient.subscribe("/sub/trade.chat", function (msg) {
                console.log("ğŸ’¬ ìƒˆ ì±„íŒ…ë°© ì•Œë¦¼ ë„ì°©:", msg.body);
                location.reload();   // ì±„íŒ… ìˆ˜, ì°œ ìˆ˜, ì¡°íšŒìˆ˜ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        });
    })();
</script>

</body>
</html>