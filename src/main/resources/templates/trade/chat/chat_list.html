<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/fragments/layout}">

<head>
    <th:block layout:fragment="head">
        <style>
            .chatlist-bg{ background:#F3F4F6; padding:18px 0 26px; }
            .chatlist-container{ width:min(980px, 92vw); margin:0 auto; }

            .chatlist-header{
                background:#fff;
                border:1px solid #EEF2F7;
                border-radius:18px;
                box-shadow:0 10px 26px rgba(0,0,0,0.06);
                padding:14px 16px;
                display:flex;
                align-items:center;
                justify-content:space-between;
                margin-bottom:12px;
            }
            .chatlist-header-left{ display:flex; align-items:center; gap:10px; min-width:0; }

            .chatlist-back{
                width:34px; height:34px;
                border-radius:999px;
                border:1px solid #E5E7EB;
                background:#fff;
                color:#374151;
                font-size:18px;
                cursor:pointer;
                display:inline-flex;
                align-items:center;
                justify-content:center;
                text-decoration:none;
                flex:none;
            }

            .chatlist-titlewrap{ display:flex; flex-direction:column; min-width:0; }
            .chatlist-title{
                font-weight:1000; font-size:18px; color:#111827;
                white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
            }
            .chatlist-sub{
                font-size:12px; font-weight:800; color:#6B7280;
                margin-top:2px;
            }

            .chatlist-card{
                background:#fff;
                border:1px solid #EEF2F7;
                border-radius:18px;
                box-shadow:0 10px 26px rgba(0,0,0,0.06);
                overflow:hidden;
            }

            .room-item{
                display:flex;
                align-items:center;
                gap:12px;
                padding:14px 14px;
                cursor:pointer;
                border-bottom:1px solid #EEF2F7;
                background:#fff;
            }
            .room-item:hover{ background:#F9FAFB; }
            .room-item:last-child{ border-bottom:none; }

            .thumb{
                width:56px; height:56px;
                border-radius:14px;
                overflow:hidden;
                background:#F3F4F6;
                border:1px solid #EEF2F7;
                flex:none;
            }
            .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

            .info{
                display:flex;
                flex-direction:column;
                gap:6px;
                min-width:0;
                flex:1;
            }
            .top-row{
                display:flex;
                justify-content:space-between;
                align-items:center;
                gap:10px;
                min-width:0;
            }
            .nickname{
                font-weight:1000; font-size:14px; color:#111827;
                white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
                min-width:0;
                max-width:70%;
            }
            .time{
                font-size:12px; font-weight:800; color:#9CA3AF;
                white-space:nowrap; flex:none;
            }
            .last-message{
                font-size:13px; font-weight:700; color:#4B5563;
                white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
                max-width:100%;
            }

            /* âœ… (í‘œì‹œ ê°•ì œ) ê³µìš© CSSì—ì„œ span ìƒ‰ì„ ë®ì–´ì¨ë„ ì•ˆ ì£½ê²Œ */
            .nickname{ color:#111827 !important; }
            .time{ color:#9CA3AF !important; }
            .last-message{ color:#4B5563 !important; }

            .unread-badge{
                min-width:24px; height:24px;
                padding:0 8px;
                border-radius:999px;
                background:#EF4444;
                color:#fff;
                font-size:12px;
                font-weight:1000;
                display:inline-flex;
                align-items:center;
                justify-content:center;
                flex:none;
                margin-left:6px;
            }

            .chatlist-empty{
                padding:22px 16px;
                text-align:center;
                color:#6B7280;
                font-weight:900;
                background:#fff;
            }
            .chatlist-empty small{
                display:block;
                margin-top:6px;
                font-weight:800;
                color:#9CA3AF;
            }

            @media (max-width: 640px){
                .chatlist-container{ width:min(680px, 94vw); }
                .thumb{ width:52px; height:52px; border-radius:12px; }
                .room-item{ padding:12px 12px; }
                .nickname{ max-width:64%; }
            }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <div class="chatlist-bg">
        <div class="chatlist-container">

            <div class="chatlist-header">
                <div class="chatlist-header-left">
                    <a class="chatlist-back" th:href="@{/trade/list.do}" title="ë’¤ë¡œê°€ê¸°">â†</a>

                    <div class="chatlist-titlewrap">
                        <div class="chatlist-title">ì±„íŒ…ë°©</div>
                        <div class="chatlist-sub">ê±°ë˜ ì±„íŒ… ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>

            <div class="chatlist-card" style="min-height:70vh;">

                <div class="chatlist-empty" th:if="${rooms == null or #lists.isEmpty(rooms)}">
                    ì•„ì§ ì±„íŒ…ë°©ì´ ì—†ì–´ìš” ğŸ™‚
                    <small>ê±°ë˜ê¸€ì—ì„œ ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</small>
                </div>

                <div th:if="${rooms != null and !#lists.isEmpty(rooms)}"
                     th:each="room : ${rooms}"
                     th:onclick="|location.href='/trade/' + ${room.tradeId} + '/chat/' + ${room.roomId}|"
                     class="room-item">

                    <div class="thumb">
                        <img th:src="${
                                room.tradeThumb == null
                                ? '/images/dummy/noimg.png'
                                : (room.tradeThumb instanceof T(java.util.Optional)
                                    ? room.tradeThumb.orElse('/images/dummy/noimg.png')
                                    : (#strings.isEmpty(room.tradeThumb) ? '/images/dummy/noimg.png' : room.tradeThumb))
                             }"
                             alt="ì¸ë„¤ì¼">
                    </div>

                    <div class="info">
                        <div class="top-row">
                            <!-- âœ… null/ë¹ˆê°’ì´ë©´ í™”ë©´ í…… ë¹„ëŠ”ê±° ë°©ì§€ (ê¸°ëŠ¥ ë³€í™” ì—†ìŒ) -->
                            <span class="nickname"
                                  th:text="${#strings.isEmpty(room.opponentName) ? 'ìƒëŒ€ë°©' : room.opponentName}">
                                ìƒëŒ€ ë‹‰ë„¤ì„
                            </span>
                            <span class="time"
                                  th:text="${#strings.isEmpty(room.lastTime) ? '' : room.lastTime}">
                                ë°©ê¸ˆ ì „
                            </span>
                        </div>

                        <div class="last-message"
                             th:text="${#strings.isEmpty(room.lastMessage) ? 'ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.' : room.lastMessage}">
                            ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë‚´ìš©
                        </div>
                    </div>

                    <div th:if="${room.unreadCount > 0}"
                         class="unread-badge"
                         th:text="${room.unreadCount}">1</div>
                </div>

            </div>

        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script>
        (function () {
            const nav = document.querySelector(".bottom-nav");
            const items = nav ? nav.querySelectorAll(".nav-item") : [];
            const badge = document.getElementById("chatBadge");
            const STORAGE_KEY = "duckuku_unread_msg";

            const pathname = window.location.pathname;

            let active = "home";
            if (pathname.startsWith("/chat")) active = "chat";
            else if (pathname.startsWith("/mypage")) active = "mypage";

            items.forEach(i => {
                if (i.dataset.page === active) i.classList.add("active");
            });

            const chatItem = document.querySelector('.nav-item[data-page="chat"]');
            if (chatItem) {
                chatItem.addEventListener("click", () => {
                    if (badge) badge.style.display = "none";
                    localStorage.setItem(STORAGE_KEY, "0");
                });
            }
        })();
    </script>
</th:block>

</body>
</html>