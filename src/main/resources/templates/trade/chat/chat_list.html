<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/fragments/trade_fragment/layout}">
<head>
</head>

<body>
<div layout:fragment="content">
    <!-- ===== 헤더 ===== -->
    <div class="trade-header">
        <div class="header-left">
            <a class="back-btn" type="button" th:href="@{/trade/chat/list.do}">←</a>
            <span class="header-title">채팅방</span>
        </div>
    </div>

    <!-- ===== 채팅방 리스트 ===== -->
    <div class="chat-list" style="min-height: 70vh">

        <!-- rooms : List<ChatRoomListDTO> -->
        <div th:each="room : ${rooms}"
             th:onclick="|location.href='/trade/' + ${room.tradeId} + '/chat/' + ${room.roomId}|"
             class="room-item">

            <!-- 썸네일 -->
            <div class="thumb">
                <img th:src="${room.tradeThumb}">
            </div>

            <!-- 상대 닉네임 / 마지막 메시지 / 시간 -->
            <div class="info">

                <div class="top-row">
                    <span class="nickname" th:text="${room.opponentName}">상대 닉네임</span>
                    <span class="time" th:text="${room.lastTime}">방금 전</span>
                </div>

                <div class="last-message" th:text="${room.lastMessage}">
                    마지막 메시지 내용이 한 줄로 잘립니다.
                </div>

            </div>

            <!-- 안 읽은 메시지 개수 배지 -->
            <div th:if="${room.unreadCount > 0}"
                 class="unread-badge"
                 th:text="${room.unreadCount}">1</div>

        </div>

    </div>

<!-- ===== 하단 네비 ===== -->

</div>
</body>

<!-- ===== 네비 활성화 + 뱃지 상태 JS (굿즈거래와 동일 로직) ===== -->
<script layout:fragment="script">
    (function () {

        const nav = document.querySelector(".bottom-nav");
        const items = nav.querySelectorAll(".nav-item");
        const badge = document.getElementById("chatBadge");
        const STORAGE_KEY = "duckuku_unread_msg";

        /* --- 활성화 페이지 자동 감지 --- */
        const pathname = window.location.pathname;

        let active = "home";
        if (pathname.startsWith("/chat")) active = "chat";
        else if (pathname.startsWith("/mypage")) active = "mypage";

        items.forEach(i => {
            if (i.dataset.page === active) i.classList.add("active");
        });

        const roomBadges = document.querySelectorAll(".unread-badge");
        /* --- 채팅 클릭하면 읽음 처리 --- */
        const chatItem = document.querySelector('.nav-item[data-page="chat"]');
        if (chatItem) {
            chatItem.addEventListener("click", () => {
                if (badge) badge.style.display = "none";
                localStorage.setItem(STORAGE_KEY, "0");
            });
        }

    })();
</script>
</html>