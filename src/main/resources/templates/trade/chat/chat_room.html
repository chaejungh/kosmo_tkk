<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Í±∞Îûò Ï±ÑÌåÖÎ∞© | ÎçîÏø†Ïø†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #F9FAFB;
            color: #111827;
        }

        .chat-room {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F9FAFB;
            display: flex;
            flex-direction: column;
        }

        .room-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #ffffff;
            border-bottom: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .room-topbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
        }

        .back-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            color: #4B5563;
            font-size: 18px;
            cursor: pointer;
        }

        .seller-info { display: flex; flex-direction: column; gap: 2px; }
        .seller-name { font-size: 15px; font-weight: 700; color: #111827; }
        .seller-sub { font-size: 12px; color: #6B7280; }

        .product-card {
            display: flex; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB; background: #ffffff;
        }

        .product-thumb {
            width: 52px; height: 52px; border-radius: 12px;
            overflow: hidden; background: #F3F4F6; flex-shrink: 0;
        }

        .product-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .product-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }

        .badge-onsale { background: rgba(99,102,241,0.12); color: #4F46E5; }
        .badge-reserved { background: rgba(251,191,36,0.15); color: #D97706; }
        .badge-sold { background: #E5E7EB; color: #6B7280; }

        .product-title {
            font-size: 13px; font-weight: 600; color: #111827;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .product-price { font-size: 13px; color: #4F46E5; font-weight: 700; }

        .chat-body {
            flex: 1; display: flex; flex-direction: column;
            padding: 14px 14px 0;
            overflow-y: auto; background: #F9FAFB;
        }

        .msg {
            max-width: 70%; margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 4px;
        }

        .msg.me { margin-left: auto; align-items: flex-end; }
        .msg.other { margin-right: auto; align-items: flex-start; }

        .bubble {
            padding: 10px 14px; font-size: 14px; line-height: 1.45;
            border-radius: 20px; word-break: break-word;
        }

        .me .bubble {
            background: #6366F1; color: #ffffff;
            border-bottom-right-radius: 6px;
        }

        .other .bubble {
            background: #ffffff; color: #111827;
            border: 1px solid #E5E7EB; border-bottom-left-radius: 6px;
        }

        .time { font-size: 11px; color: #9CA3AF; padding: 0 4px; }

        .chat-input-wrap {
            position: sticky; bottom: 0; background: #ffffff;
            border-top: 1px solid #E5E7EB; padding: 12px 14px;
        }

        .chat-input-form { display: flex; align-items: center; gap: 10px; }

        .btn-plus {
            width: 32px; height: 32px; border-radius: 999px;
            border: 1px solid #E5E7EB; background: #ffffff;
            font-size: 20px; color: #4B5563; cursor: pointer;
        }

        .msg-input {
            flex: 1; border-radius: 999px; border: 1px solid #D1D5DB;
            background: #ffffff; padding: 10px 16px;
        }

        .btn-send {
            border-radius: 999px; border: none;
            background: #6366F1; color: #ffffff;
            font-size: 14px; font-weight: 600;
            padding: 9px 18px; cursor: pointer;
        }
    </style>
</head>
<body>
<div class="chat-room">

    <!-- ÏÉÅÎã® -->
    <div class="room-header">
        <div class="room-topbar">
            <button class="back-btn"
                    th:onclick="|location.href='@{/trade/{memberId}/chat(memberId=${memberId})}'|">‚Üê</button>

            <div class="seller-info">
                <div class="seller-name" th:text="${sellerName}"></div>
                <div class="seller-sub">Î≥¥ÌÜµ 10Î∂Ñ Ïù¥ÎÇ¥ ÏùëÎãµ</div>
            </div>
        </div>

        <div class="product-card">
            <div class="product-thumb">
                <img th:src="${productThumbnailUrl}">
            </div>
            <div class="product-info">
                <span th:text="${productStatusLabel}"
                      th:class="'badge ' + ${productStatusClass}"></span>

                <div class="product-title" th:text="${productTitle}"></div>
                <div class="product-price" th:text="${productPriceText}"></div>
            </div>
        </div>
    </div>

    <!-- Î©îÏãúÏßÄ Î™©Î°ù -->
    <div id="chatListCont">
        <div class="chat-body">
            <div th:each="msg : ${msgList}"
                 th:class="'msg ' + (${msg.senderId} == ${currentMemberId} ? 'me' : 'other')">

                <div class="bubble">

                    <span th:if="${!#strings.startsWith(msg.message, '[img]')}"
                          th:text="${msg.message}"></span>

                    <img th:if="${#strings.startsWith(msg.message, '[img]')}"
                         th:src="@{${#strings.substring(msg.message, 5)}}"
                         style="max-width:200px; border-radius:12px;">
                </div>

                <div class="time"
                     th:text="${msg.createdAt != null ? msg.createdAt : ''}"></div>
            </div>
        </div>
    </div>

    <!-- ÏûÖÎ†•ÏòÅÏó≠ -->
    <div class="chat-input-wrap">
        <form name="chatForm"
              class="chat-input-form"
              th:action="@{|/trade/${memberId}/chat/${room.id}/send|}"
              method="post">

            <button type="button" class="btn-plus" onclick="selectImage()">+</button>

            <input type="file" id="imgFile" accept="image/*" style="display:none;" />

            <input type="text" name="message" class="msg-input"
                   placeholder="Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞" autocomplete="off">

            <button type="submit" class="btn-send">Ï†ÑÏÜ°</button>
        </form>
    </div>

    <script>
        const memberId = "[[${memberId}]]";
        const roomId = "[[${room.id}]]";
        const chatForm=document.forms["chatForm"];
        const chatListCont=document.querySelector(".chat-body");

        setInterval(getChatList,1000);

        function formatTime(date) {
            let hour = date.getHours();
            let minute = String(date.getMinutes()).padStart(2,'0');
            const ampm = hour >= 12 ? 'Ïò§ÌõÑ':'Ïò§Ï†Ñ';
            hour = hour % 12 || 12;
            return `${ampm} ${hour}:${minute}`;
        }

        function formatDate(date) {
            const today = new Date();
            const d = new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const t = new Date(today.getFullYear(),today.getMonth(),today.getDate());
            const diff = (t - d) / (86400000);
            if(diff===0) return "Ïò§Îäò";
            if(diff===1) return "Ïñ¥Ï†ú";
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        }

        function formatDateTime(str){
            if(!str) return "";
            const date=new Date(str);
            return `${formatDate(date)} ${formatTime(date)}`;
        }

        async function getChatList(){
            const response = await fetch(`/trade/api/${roomId}/chat/list`);
            if(response.ok){
                const chatList = await response.json();
                let html="";
                for(const msg of chatList){

                    let contentHtml = "";
                    if(msg.message.startsWith("[img]")){
                        let path = msg.message.substring(5);
                        contentHtml = `<img src="${path}" style="max-width:200px;border-radius:12px;">`;
                    } else {
                        contentHtml = msg.message;
                    }

                    html+=`
                <div class="msg ${msg.senderId==memberId?'me':'other'}">
                    <div class="bubble">${contentHtml}</div>
                    <div class="time">${msg.createdAt ? formatDateTime(msg.createdAt):''}</div>
                </div>`;
                }
                chatListCont.innerHTML=html;

                /* üî• DOM Î†åÎçîÎßÅ ÌõÑ ÏûêÎèô Ïä§ÌÅ¨Î°§ */
                setTimeout(() => {
                    scrollToBottom();
                }, 30);
            }
        }

        function scrollToBottom(){
            const chatBody=document.querySelector(".chat-body");
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        chatForm.onsubmit = sendMsg;

        async function sendMsg(e){
            e.preventDefault();
            let url=`/trade/api/${memberId}/chat/${roomId}/send`;
            const response=await fetch(url,{method:"POST",body:new FormData(chatForm)});
            if(response.ok){
                getChatList();

                /* üî• Ï†ÑÏÜ° ÌõÑ ÏûêÎèô Ïä§ÌÅ¨Î°§ */
                setTimeout(() => {
                    scrollToBottom();
                }, 30);

                chatForm.reset();
            }
        }

        function selectImage() {
            document.getElementById("imgFile").click();
        }

        document.getElementById("imgFile")
            .addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fd = new FormData();
                fd.append("image", file);

                const response = await fetch(`/trade/api/${memberId}/chat/${roomId}/image`, {
                    method: "POST",
                    body: fd
                });

                if (response.ok) {
                    getChatList();

                    /* üî• Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÌõÑ ÏûêÎèô Ïä§ÌÅ¨Î°§ */
                    setTimeout(() => {
                        scrollToBottom();
                    }, 30);

                } else {
                    alert("Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° Ïã§Ìå®");
                }
            });

    </script>
</div>
</body>
</html>