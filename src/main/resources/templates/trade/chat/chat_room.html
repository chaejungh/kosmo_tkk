<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê±°ë˜ ì±„íŒ…ë°© | ë”ì¿ ì¿ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #F9FAFB;
            color: #111827;
        }

        .chat-room {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F9FAFB;
            display: flex;
            flex-direction: column;
        }

        .room-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #ffffff;
            border-bottom: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .room-topbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
        }

        .back-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            color: #4B5563;
            font-size: 18px;
            cursor: pointer;
        }

        .seller-info { display: flex; flex-direction: column; gap: 2px; }
        .seller-name { font-size: 15px; font-weight: 700; color: #111827; }
        .seller-sub { font-size: 12px; color: #6B7280; }

        .product-card {
            display: flex; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB; background: #ffffff;
        }

        .product-thumb {
            width: 52px; height: 52px; border-radius: 12px;
            overflow: hidden; background: #F3F4F6; flex-shrink: 0;
        }

        .product-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .product-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }

        .badge-onsale { background: rgba(99,102,241,0.12); color: #4F46E5; }
        .badge-reserved { background: rgba(251,191,36,0.15); color: #D97706; }
        .badge-sold { background: #E5E7EB; color: #6B7280; }

        .product-title {
            font-size: 13px; font-weight: 600; color: #111827;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .product-price { font-size: 13px; color: #4F46E5; font-weight: 700; }

        .chat-body {
            flex: 1; display: flex; flex-direction: column;
            padding: 14px 14px 0;
            overflow-y: auto; background: #F9FAFB;
        }

        .msg {
            max-width: 70%; margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 4px;
        }

        .msg.me { margin-left: auto; align-items: flex-end; }
        .msg.other { margin-right: auto; align-items: flex-start; }

        .bubble {
            padding: 10px 14px; font-size: 14px; line-height: 1.45;
            border-radius: 20px; word-break: break-word;
        }

        .me .bubble {
            background: #6366F1; color: #ffffff;
            border-bottom-right-radius: 6px;
        }

        .other .bubble {
            background: #ffffff; color: #111827;
            border: 1px solid #E5E7EB; border-bottom-left-radius: 6px;
        }

        .time { font-size: 11px; color: #9CA3AF; padding: 0 4px; }

        .chat-input-wrap {
            position: sticky; bottom: 0; background: #ffffff;
            border-top: 1px solid #E5E7EB; padding: 12px 14px;
        }

        .chat-input-form { display: flex; align-items: center; gap: 10px; }

        .btn-plus {
            width: 32px; height: 32px; border-radius: 999px;
            border: 1px solid #E5E7EB; background: #ffffff;
            font-size: 20px; color: #4B5563; cursor: pointer;
        }

        .msg-input {
            flex: 1; border-radius: 999px; border: 1px solid #D1D5DB;
            background: #ffffff; padding: 10px 16px;
        }

        .btn-send {
            border-radius: 999px; border: none;
            background: #6366F1; color: #ffffff;
            font-size: 14px; font-weight: 600;
            padding: 9px 18px; cursor: pointer;
        }
        .bubble-row {
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }

        /* ë‚´ ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬, ìƒëŒ€ëŠ” ì™¼ìª½ ì •ë ¬ */
        .msg.me .bubble-row {
            justify-content: flex-end;
        }

        .msg.other .bubble-row {
            justify-content: flex-start;
        }

        .time-left {
            font-size: 11px;
            color: #9CA3AF;
            white-space: nowrap;
        }

        .status-row {
            font-size: 11px;
            color: #9CA3AF;
            margin: 2px 4px 0;
            text-align: right;
        }

        .read-status {
            /* í•„ìš”í•˜ë©´ êµµê¸° ê°™ì€ ê±° ì¶”ê°€ */
        }
        .room-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between; /* ì¢Œìš°ë¡œ ë‚˜ëˆ„ê¸° */
            padding: 12px 16px;
            gap: 10px;
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .room-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-btn {
            min-width: 52px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            font-size: 11px;
            color: #4B5563;
            cursor: pointer;
        }

        .header-btn-exit {
            color: #EF4444;
            border-color: #FECACA;
            background: #FEF2F2;
        }

        .header-btn-edit {
            font-weight: 600;
        }

        .header-btn-edit.active {
            background: #6366F1;
            color: #ffffff;
            border-color: #6366F1;
        }
        .msg-delete-btn {
            display: none;              /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
            margin-top: 2px;
            font-size: 11px;
            color: #EF4444;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        /* í¸ì§‘ëª¨ë“œ + ë‚´ ë©”ì‹œì§€(me)ì¼ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ */
        .chat-room.edit-mode .msg.me .msg-delete-btn {
            display: inline-flex;
        }


    </style>
</head>
<body>

<div class="chat-room">

    <!-- ìƒë‹¨ -->
    <div class="room-header">
        <div class="room-topbar">
            <!-- ì™¼ìª½: ë’¤ë¡œê°€ê¸° + ìƒëŒ€ ì •ë³´ -->
            <div class="top-left">
                <button class="back-btn"
                        onclick="history.back()">â†</button>

                <div class="seller-info">
                    <div class="seller-name" th:text="${sellerName}"></div>
                    <div class="seller-sub">ì‹¤ì‹œê°„ ì±„íŒ…</div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë‚˜ê°€ê¸° / í¸ì§‘ ë²„íŠ¼ -->
            <div class="room-actions">
                <button type="button" id="exitBtn" class="header-btn header-btn-exit">ë‚˜ê°€ê¸°</button>
                <button type="button" id="editBtn" class="header-btn header-btn-edit">í¸ì§‘</button>
            </div>
        </div>


        <div class="product-card">
            <div class="product-thumb">
                <img th:src="${productThumbnailUrl}">
            </div>
            <div class="product-info">
                <span th:text="${productStatusLabel}"
                      th:class="'badge ' + ${productStatusClass}"></span>

                <div class="product-title" th:text="${productTitle}"></div>
                <div class="product-price" th:text="${productPriceText}"></div>
            </div>
        </div>
    </div>
    <div id="chatBody" class="chat-body">
        <!-- ë©”ì‹œì§€ ëª©ë¡ -->
        <div th:each="msg : ${msgList}"
             th:class="'msg ' + (${msg.senderId} == ${currentMemberId} ? 'me' : 'other')"
             th:attr="data-msg-id=${msg.id}">
            <!-- ğŸ”¼ ì—¬ê¸° data-msg-id ì¶”ê°€ -->

            <!-- ì‹œê°„ + ë§í’ì„  í•œ ì¤„ -->
            <div class="bubble-row">
                <div class="time-left"
                     th:text="${msg.createdAt != null ? #temporals.format(msg.createdAt, 'a h:mm') : ''}">
                </div>

                <div class="bubble">
                <span th:if="${!#strings.startsWith(msg.message, '[img]')}"
                      th:text="${msg.message}"></span>

                    <img th:if="${#strings.startsWith(msg.message, '[img]')}"
                         th:src="@{${#strings.substring(msg.message, 5)}}"
                         style="max-width:200px; border-radius:12px;">
                </div>
            </div>

            <!-- ë§í’ì„  ì•„ë˜ ì½ìŒ/ì•ˆì½ìŒ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ) -->
            <div class="status-row"
                 th:if="${msg.senderId} == ${currentMemberId}">
            <span class="read-status"
                  th:text="${msg.readYn == 'Y' ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}"></span>
            </div>

            <!-- í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ë³´ì´ëŠ” ì‚­ì œ ë²„íŠ¼ (ë‚´ ë©”ì‹œì§€ë§Œ ë³´ì´ê²Œ CSSë¡œ ì œì–´) -->
            <button type="button" class="msg-delete-btn">ì‚­ì œ</button>
        </div>
    </div>

    <!-- ì…ë ¥ ë°•ìŠ¤ -->
    <div class="chat-input-wrap">
        <form class="chat-input-form" onsubmit="return sendMessage();">
            <button type="button" class="btn-plus" onclick="selectImage()">+</button>
            <input type="file" id="imgFile" accept="image/*" style="display:none;" />

            <input type="text" id="msgInput" class="msg-input"
                   placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°" autocomplete="off">

            <button type="submit" class="btn-send">ì „ì†¡</button>
        </form>
    </div>
</div>


<!-- ========================================== -->
<!--                WebSocket Script            -->
<!-- ========================================== -->

<script>
    const currentMemberId = String("[[${currentMemberId}]]");
    const roomId = String("[[${room.id}]]");
    const chatBody = document.getElementById("chatBody");
    const chatRoomEl = document.querySelector(".chat-room");
    let editMode = false;

    let stompClient = null;

    let typingTimer = null;
    const TYPING_TIMEOUT = 2000;
    let typingIndicator = null;

    function formatTime(date) {
        let hour = date.getHours();
        let minute = String(date.getMinutes()).padStart(2, '0');
        const ampm = hour >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
        hour = hour % 12 || 12;
        return `${ampm} ${hour}:${minute}`;
    }

    function formatDate(date) {
        const today = new Date();
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const diff = (t - d) / 86400000;

        if (diff === 0) return "ì˜¤ëŠ˜";
        if (diff === 1) return "ì–´ì œ";

        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    function formatDateTime(str) {
        if (!str) return "";
        let date = new Date(str);
        if (isNaN(date.getTime())) return "";
        return formatTime(date);   // ìœ„ì— ì´ë¯¸ ìˆëŠ” í•¨ìˆ˜ ì¬ì‚¬ìš©
    }


    function connectWebSocket() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            stompClient.subscribe(`/sub/chat.room.${roomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                handleIncoming(body);
            });

            sendReadEvent();
        });
    }

    function sendReadEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.read", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            type: "READ"
        }));
    }

    function sendTypingEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.typing", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            type: "TYPING"
        }));
    }

    function sendDeleteEvent(messageId) {
        if (!stompClient) return;
        stompClient.send("/pub/chat.delete", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            messageId,
            type: "DELETE"
        }));
    }

    function sendMessage() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text) return false;

        stompClient.send("/pub/chat.send", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            message: text,
            type: "TEXT"
        }));

        input.value = "";
        return false;
    }

    function selectImage() {
        document.getElementById("imgFile").click();
    }

    document.getElementById("imgFile").addEventListener("change", async (e) => {

        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("roomId", roomId);
        formData.append("senderId", currentMemberId);
        formData.append("image", file);

        // âœ… ChatFileController ì™€ ë§¤í•‘ë˜ëŠ” ê²½ë¡œ ( /chat-file + /upload-image )
        const response = await fetch("/chat-file/upload-image", {
            method: "POST",
            body: formData
        });

        if (!response.ok) alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");

    });

    function handleIncoming(msg) {

        switch (msg.type) {

            // ğŸ”¹ TEXT/IMAGEë§Œ ë©”ì‹œì§€ ì¶”ê°€
            case "TEXT":
            case "IMAGE":
                addMessage(msg);

                sendReadEvent();
                break;

            // ğŸ”¹ ì½ìŒ ì²˜ë¦¬
            case "READ":
                handleRead(msg);
                break;

            // ğŸ”¹ ìƒëŒ€ typing
            case "TYPING":
                handleTyping(msg);
                break;

            // ğŸ”¹ ë©”ì‹œì§€ ì‚­ì œ
            case "DELETE":
                handleDelete(msg);
                break;

            // ğŸ”¹ ê·¸ ì™¸ íƒ€ì…ì€ ë¬´ì‹œ
            default:
                console.warn("Unknown message type:", msg);
                break;
        }
    }

    // í¸ì§‘ ëª¨ë“œì—ì„œ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„)
    chatBody.addEventListener("click", (e) => {
        if (!editMode) return;

        const btn = e.target.closest(".msg-delete-btn");
        if (!btn) return;

        const msgEl = btn.closest(".msg");
        if (!msgEl) return;
        if (!msgEl.classList.contains("me")) return; // í˜¹ì‹œ ëª¨ë¥¼ ì•ˆì •ì¥ì¹˜

        const msgId = msgEl.dataset.msgId;
        if (!msgId) return;

        if (!confirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        sendDeleteEvent(msgId);
    });


    let lastMyMessageEl = null;

    function addMessage(msg) {

        let content = "";

        if (msg.type === "IMAGE" || (msg.message && msg.message.startsWith("[img]"))) {
            const path = msg.message.replace("[img]", "");
            content = `<img src="${path}" style="max-width:200px;border-radius:12px;">`;
        } else {
            content = msg.message;
        }

        const isMe = String(msg.senderId) === currentMemberId;

        if (isMe && lastMyMessageEl) {
            const prevStatus = lastMyMessageEl.querySelector(".status-row");
            if (prevStatus) prevStatus.remove();
        }

        const wrap = document.createElement("div");
        wrap.className = "msg " + (isMe ? "me" : "other");

        if (msg.messageId) wrap.dataset.msgId = msg.messageId;

        // ë‚´ ë©”ì‹œì§€ì—ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ "ì•ˆì½ìŒ" í‘œì‹œ
        const statusHtml = isMe
            ? `<div class="status-row"><span class="read-status">ì•ˆì½ìŒ</span></div>`
            : "";

        wrap.innerHTML = `
        <div class="bubble-row">
            <div class="time-left">${formatDateTime(msg.createdAt)}</div>
            <div class="bubble">${content}</div>
        </div>
        ${statusHtml}
        <button type="button" class="msg-delete-btn">ì‚­ì œ</button>
    `;

        chatBody.appendChild(wrap);
        scrollToBottom();

        if (isMe) {
            lastMyMessageEl = wrap;
        }
    }


    function handleRead(msg) {
        // ë‚´ê°€ ë³´ë‚¸ READ ì´ë²¤íŠ¸ë©´ ë¬´ì‹œ (ìƒëŒ€ê°€ ì½ì—ˆë‹¤ëŠ” ì‹ í˜¸ë§Œ ì²˜ë¦¬)
        if (String(msg.senderId) === currentMemberId) return;

        const lastMy = lastMyMessageEl || chatBody.querySelector(".msg.me:last-child");
        if (!lastMy) return;

        const statusEl = lastMy.querySelector(".read-status");
        if (statusEl) {
            statusEl.textContent = "ì½ìŒ";
        }
    }


    function handleTyping(msg) {

        if (String(msg.senderId) === currentMemberId) return;

        if (!typingIndicator) {
            typingIndicator = document.createElement("div");
            typingIndicator.id = "typingIndicator";
            typingIndicator.style.fontSize = "12px";
            typingIndicator.style.color = "#9CA3AF";
            typingIndicator.style.padding = "4px 16px 6px";
            typingIndicator.textContent = "ìƒëŒ€ë°©ì´ ì…ë ¥ ì¤‘â€¦";
            chatBody.appendChild(typingIndicator);
        }

        typingIndicator.style.display = "block";

        if (typingTimer) clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
            typingIndicator.style.display = "none";
        }, TYPING_TIMEOUT);
    }

    function handleDelete(msg) {
        const target = chatBody.querySelector(`.msg[data-msg-id="${msg.messageId}"]`);
        if (!target) return;

        const bubble = target.querySelector(".bubble");
        bubble.textContent = "(ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤)";
        bubble.style.color = "#9CA3AF";
        bubble.style.fontStyle = "italic";
    }
    const editBtn = document.getElementById("editBtn");
    if (editBtn) {
        editBtn.addEventListener("click", () => {
            editMode = !editMode;

            if (editMode) {
                chatRoomEl.classList.add("edit-mode");
                editBtn.classList.add("active");
                editBtn.textContent = "ì™„ë£Œ";
            } else {
                chatRoomEl.classList.remove("edit-mode");
                editBtn.classList.remove("active");
                editBtn.textContent = "í¸ì§‘";
            }
        });
    }

    const exitBtn = document.getElementById("exitBtn");
    if (exitBtn) {
        exitBtn.addEventListener("click", async () => {
            if (!confirm("ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const res = await fetch(`/trade/chat/${roomId}/leave`, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                if (!res.ok) {
                    alert("ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                // âœ… ë°±ì—”ë“œ ì²˜ë¦¬ ì„±ê³µ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
                window.location.href = "/chat/list";
            } catch (e) {
                console.error(e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ì±„íŒ…ë°©ì„ ë‚˜ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }



    function scrollToBottom(instant) {
        // ì‹¤ì œ ìŠ¤í¬ë¡¤ ë˜ëŠ” ì—˜ë¦¬ë¨¼íŠ¸ (html/body)
        const el = document.scrollingElement || document.documentElement;
        const top = el.scrollHeight;

        if (instant) {
            // ì¦‰ì‹œ ë§¨ ì•„ë˜ë¡œ ì í”„ (ì´ˆê¸° ë¡œë”©ìš©)
            el.scrollTop = top;
        } else {
            // ìƒˆ ë©”ì‹œì§€ ì˜¬ ë•ŒëŠ” ë¶€ë“œëŸ½ê²Œ
            el.scrollTo({
                top,
                behavior: "smooth"
            });
        }
    }


    const msgInput = document.getElementById("msgInput");
    msgInput.addEventListener("input", () => {
        sendTypingEvent();
    });

    window.onload = function () {
        // ğŸ”¥ í˜ì´ì§€ ì²˜ìŒ ì—´ë¦´ ë•Œ: ê¸°ì¡´ ë©”ì‹œì§€ë“¤ ì¤‘ ë§ˆì§€ë§‰ ë‚´ ë©”ì‹œì§€ í•˜ë‚˜ë§Œ ìƒíƒœ ë‚¨ê¸°ê¸°
        const myMsgs = chatBody.querySelectorAll(".msg.me");
        if (myMsgs.length > 0) {
            lastMyMessageEl = myMsgs[myMsgs.length - 1];
            for (let i = 0; i < myMsgs.length - 1; i++) {
                const statusRow = myMsgs[i].querySelector(".status-row");
                if (statusRow) statusRow.remove();
            }
        }

        connectWebSocket();
        setTimeout(() => {
            scrollToBottom(true); // instant=true
        }, 0);
    };

</script>

</body>
</html>