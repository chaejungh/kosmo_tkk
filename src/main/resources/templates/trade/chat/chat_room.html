<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Í±∞Îûò Ï±ÑÌåÖÎ∞© | ÎçîÏø†Ïø†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- WebSocket ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #F3F4F6; /* ‚úÖ ÎßàÏù¥ÌéòÏù¥ÏßÄ ÌÜ§ */
            color: #111827;
        }

        /* ‚úÖ Ï†ÑÏ≤¥ Î∞∞Í≤Ω + Í∞ÄÏö¥Îç∞ Ìè≠ Í≥†Ï†ï */
        .chat-page-bg{
            min-height: 100vh;
            padding: 22px 0 28px;
        }
        .chat-page-container{
            width: min(1100px, 92vw);  /* ‚úÖ ÎßàÏù¥ÌéòÏù¥ÏßÄ Î©îÏù∏Í∏â ÌÅ¨Í∏∞ */
            margin: 0 auto;
        }

        /* ‚úÖ Ï±ÑÌåÖ Ïπ¥Îìú(ÌÅ∞ Î∞ïÏä§) */
        .chat-room {
            max-width: none;          /* ‚ùå 600px Ï†úÍ±∞ */
            margin: 0;
            min-height: calc(100vh - 44px); /* bg padding Í≥†Î†§ */
            background: #ffffff;      /* ‚úÖ Ïπ¥ÎìúÎ°ú Î≥¥Ïù¥Í≤å */
            display: flex;
            flex-direction: column;
            border: 1px solid #EEF2F7;
            border-radius: 18px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .room-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #ffffff;
            border-bottom: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .room-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px; /* ‚úÖ ÏÇ¥Ïßù Ïó¨Ïú† */
            gap: 10px;
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .back-btn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            color: #4B5563;
            font-size: 18px;
            cursor: pointer;
            flex: none;
        }

        .seller-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .seller-name {
            font-size: 15px;
            font-weight: 800;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .seller-sub { font-size: 12px; color: #6B7280; font-weight: 700; }

        .room-actions {
            display: flex;
            flex-direction: row; /* ‚úÖ Í∞ÄÎ°úÎ°ú Î≥¥Í∏∞ Ï¢ãÍ≤å */
            gap: 8px;
            flex: none;
        }

        .header-btn {
            min-width: 64px;
            padding: 7px 12px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            font-size: 12px;
            font-weight: 800;
            color: #4B5563;
            cursor: pointer;
        }

        .header-btn-exit {
            color: #EF4444;
            border-color: #FECACA;
            background: #FEF2F2;
        }

        .header-btn-edit {
            font-weight: 800;
        }

        .header-btn-edit.active {
            background: #6366F1;
            color: #ffffff;
            border-color: #6366F1;
        }

        .product-card {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-top: 1px solid #EEF2F7;
            border-bottom: 1px solid #E5E7EB;
            background: #ffffff;
        }

        .product-thumb {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            overflow: hidden;
            background: #F3F4F6;
            flex-shrink: 0;
            border: 1px solid #EEF2F7;
        }

        .product-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }

        .product-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }

        .badge-onsale { background: rgba(99,102,241,0.12); color: #4F46E5; }
        .badge-reserved { background: rgba(251,191,36,0.15); color: #D97706; }
        .badge-sold { background: #E5E7EB; color: #6B7280; }

        .product-title {
            font-size: 13px;
            font-weight: 800;
            color: #111827;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .product-price { font-size: 13px; color: #4F46E5; font-weight: 900; }

        /* ‚úÖ Ï±ÑÌåÖ ÏòÅÏó≠: Ïπ¥Îìú ÏïàÏóêÏÑú Ïä§ÌÅ¨Î°§ */
        .chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px 16px 6px;
            overflow-y: auto;
            background: #F9FAFB; /* ÎßêÌíçÏÑ†Ïù¥ Ïûò Î≥¥Ïù¥Í≤å */
        }

        .msg {
            max-width: 70%;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .msg.me { margin-left: auto; align-items: flex-end; }
        .msg.other { margin-right: auto; align-items: flex-start; }

        .bubble-row {
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }

        .msg.me .bubble-row { justify-content: flex-end; }
        .msg.other .bubble-row { justify-content: flex-start; }

        .time-left {
            font-size: 11px;
            color: #9CA3AF;
            white-space: nowrap;
        }

        .bubble {
            padding: 10px 14px;
            font-size: 14px;
            line-height: 1.45;
            border-radius: 20px;
            word-break: break-word;
        }

        .me .bubble {
            background: #6366F1;
            color: #ffffff;
            border-bottom-right-radius: 6px;
        }

        .other .bubble {
            background: #ffffff;
            color: #111827;
            border: 1px solid #E5E7EB;
            border-bottom-left-radius: 6px;
        }

        .status-row {
            font-size: 11px;
            color: #9CA3AF;
            margin: 2px 4px 0;
            text-align: right;
        }

        .msg-delete-btn {
            display: none;
            margin-top: 2px;
            font-size: 11px;
            color: #EF4444;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .chat-room.edit-mode .msg.me .msg-delete-btn {
            display: inline-flex;
        }

        /* üîπ ÎÇ†Ïßú Íµ¨Î∂ÑÏÑ† */
        .date-divider {
            display: flex;
            justify-content: center;
            margin: 16px 0 10px;
        }

        .date-pill {
            padding: 4px 12px;
            border-radius: 999px;
            background: #E5E7EB;
            color: #4B5563;
            font-size: 11px;
            font-weight: 800;
        }

        /* ‚úÖ ÏûÖÎ†• Î∞ïÏä§Îäî Ïπ¥Îìú ÌïòÎã®Ïóê Í≥†Ï†ï */
        .chat-input-wrap {
            position: sticky;
            bottom: 0;
            background: #ffffff;
            border-top: 1px solid #E5E7EB;
            padding: 12px 14px;
        }

        .chat-input-form { display: flex; align-items: center; gap: 10px; }

        .btn-plus {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            font-size: 20px;
            color: #4B5563;
            cursor: pointer;
            flex: none;
        }

        .msg-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid #D1D5DB;
            background: #ffffff;
            padding: 10px 16px;
            outline: none;
        }

        .btn-send {
            border-radius: 999px;
            border: none;
            background: #6366F1;
            color: #ffffff;
            font-size: 14px;
            font-weight: 800;
            padding: 10px 18px;
            cursor: pointer;
            flex: none;
        }

        /* ‚úÖ Î∞òÏùëÌòï */
        @media (max-width: 820px){
            .chat-page-container{ width: min(680px, 94vw); }
            .msg{ max-width: 82%; }
            .room-actions{ flex-direction: column; gap: 6px; }
            .header-btn{ min-width: 60px; padding: 6px 10px; }
        }
        @media (max-width: 520px){
            .chat-page-bg{ padding: 10px 0 14px; }
            .chat-room{ border-radius: 14px; }
            .msg{ max-width: 86%; }
        }
    </style>
</head>
<body>

<!-- ‚úÖ Î∑∞/ÌÅ¨Í∏∞Îßå ÎßûÏ∂îÎäî ÎûòÌçº Ï∂îÍ∞Ä(Í∏∞Îä• ÏòÅÌñ• X) -->
<div class="chat-page-bg">
    <div class="chat-page-container">

        <div class="chat-room">

            <!-- ÏÉÅÎã® -->
            <div class="room-header">
                <div class="room-topbar">
                    <!-- ÏôºÏ™Ω: Îí§Î°úÍ∞ÄÍ∏∞ + ÏÉÅÎåÄ Ï†ïÎ≥¥ -->
                    <div class="top-left">
                        <button class="back-btn"
                                onclick="history.back()">‚Üê</button>

                        <div class="seller-info">
                            <div class="seller-name" th:text="${sellerName}"></div>
                            <div class="seller-sub">Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</div>
                        </div>
                    </div>

                    <!-- Ïò§Î•∏Ï™Ω: ÎÇòÍ∞ÄÍ∏∞ / Ìé∏Ïßë Î≤ÑÌäº -->
                    <div class="room-actions">
                        <button type="button" id="exitBtn" class="header-btn header-btn-exit">ÎÇòÍ∞ÄÍ∏∞</button>
                        <button type="button" id="editBtn" class="header-btn header-btn-edit">Ìé∏Ïßë</button>
                    </div>
                </div>

                <div class="product-card"
                     style="cursor:pointer;"
                     th:onclick="|location.href='@{/trade/{tradeId}/article/detail.do(tradeId=${tradeId})}'|">
                    <div class="product-thumb">
                        <img th:src="${productThumbnailUrl}">
                    </div>
                    <div class="product-info">
                        <span th:text="${productStatusLabel}"
                              th:class="'badge ' + ${productStatusClass}"></span>

                        <div class="product-title" th:text="${productTitle}"></div>
                        <div class="product-price" th:text="${productPriceText}"></div>
                    </div>
                </div>
            </div>

            <div id="chatBody" class="chat-body">
                <!-- Î©îÏãúÏßÄ Î™©Î°ù -->
                <div th:each="msg : ${msgList}"
                     th:class="'msg ' + (${msg.senderId} == ${currentMemberId} ? 'me' : 'other')"
                     th:attr="
                        data-msg-id=${msg.id},
                        data-date=${#temporals.format(msg.createdAt, 'yyyy-MM-dd')},
                        data-date-label=${#temporals.format(msg.createdAt, 'yyyyÎÖÑ MÏõî dÏùº EÏöîÏùº')}
                     ">

                    <div class="bubble-row">
                        <div class="time-left"
                             th:text="${msg.createdAt != null ? #temporals.format(msg.createdAt, 'a h:mm') : ''}">
                        </div>

                        <div class="bubble">
                            <span th:if="${!#strings.startsWith(msg.message, '[img]')}"
                                  th:text="${msg.message}"></span>

                            <img th:if="${#strings.startsWith(msg.message, '[img]')}"
                                 th:src="@{${#strings.substring(msg.message, 5)}}"
                                 style="max-width:200px; border-radius:12px;">
                        </div>
                    </div>

                    <div class="status-row"
                         th:if="${msg.senderId} == ${currentMemberId}">
                        <span class="read-status"
                              th:text="${msg.readYn == 'Y' ? 'ÏùΩÏùå' : 'ÏïàÏùΩÏùå'}"></span>
                    </div>

                    <button type="button" class="msg-delete-btn">ÏÇ≠Ï†ú</button>
                </div>
            </div>

            <!-- ÏûÖÎ†• Î∞ïÏä§ -->
            <div class="chat-input-wrap">
                <form class="chat-input-form" onsubmit="return sendMessage();">
                    <button type="button" class="btn-plus" onclick="selectImage()">+</button>
                    <input type="file" id="imgFile" accept="image/*" style="display:none;" />

                    <input type="text" id="msgInput" class="msg-input"
                           placeholder="Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞" autocomplete="off">

                    <button type="submit" class="btn-send">Ï†ÑÏÜ°</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- ========================================== -->
<!--                WebSocket Script            -->
<!-- ========================================== -->

<script>
    const currentMemberId = String("[[${currentMemberId}]]");
    const roomId = String("[[${room.id}]]");
    const chatBody = document.getElementById("chatBody");
    const chatRoomEl = document.querySelector(".chat-room");
    let editMode = false;

    let stompClient = null;
    let typingTimer = null;
    const TYPING_TIMEOUT = 2000;
    let typingIndicator = null;
    let lastDateKey = null;

    function formatTime(date) {
        let hour = date.getHours();
        let minute = String(date.getMinutes()).padStart(2, '0');
        const ampm = hour >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
        hour = hour % 12 || 12;
        return `${ampm} ${hour}:${minute}`;
    }

    function formatDateTime(str) {
        if (!str) return "";
        let date = new Date(str);
        if (isNaN(date.getTime())) return "";
        return formatTime(date);
    }

    function formatDateLabelByKey(dateKey) {
        const parts = dateKey.split("-");
        if (parts.length !== 3) return dateKey;

        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);

        const date = new Date(y, m, d);
        const weekday = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][date.getDay()];

        return `${y}ÎÖÑ ${m + 1}Ïõî ${d}Ïùº ${weekday}ÏöîÏùº`;
    }

    function insertInitialDateDividers() {
        const msgs = chatBody.querySelectorAll(".msg");
        let prevKey = null;

        msgs.forEach(msgEl => {
            const dateKey = msgEl.dataset.date;
            if (!dateKey) return;

            if (!prevKey || prevKey !== dateKey) {
                const label = msgEl.dataset.dateLabel || formatDateLabelByKey(dateKey);
                const divider = document.createElement("div");
                divider.className = "date-divider";
                divider.innerHTML = `<div class="date-pill">${label}</div>`;
                chatBody.insertBefore(divider, msgEl);
                prevKey = dateKey;
            }
        });

        lastDateKey = prevKey;
    }

    function appendDateDividerIfNeeded(dateKey, dateLabel) {
        if (!lastDateKey || lastDateKey !== dateKey) {
            const divider = document.createElement("div");
            divider.className = "date-divider";
            divider.innerHTML = `<div class="date-pill">${dateLabel}</div>`;
            chatBody.appendChild(divider);
            lastDateKey = dateKey;
        }
    }

    function connectWebSocket() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            stompClient.subscribe(`/sub/chat.room.${roomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                handleIncoming(body);
            });

            sendReadEvent();
        });
    }

    function sendReadEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.read", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            type: "READ"
        }));
    }

    function sendTypingEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.typing", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            type: "TYPING"
        }));
    }

    function sendDeleteEvent(messageId) {
        if (!stompClient) return;
        stompClient.send("/pub/chat.delete", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            messageId,
            type: "DELETE"
        }));
    }

    function sendMessage() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text) return false;

        stompClient.send("/pub/chat.send", {}, JSON.stringify({
            roomId,
            senderId: currentMemberId,
            message: text,
            type: "TEXT"
        }));

        input.value = "";
        return false;
    }

    function selectImage() {
        document.getElementById("imgFile").click();
    }

    document.getElementById("imgFile").addEventListener("change", async (e) => {

        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("roomId", roomId);
        formData.append("senderId", currentMemberId);
        formData.append("image", file);

        const response = await fetch("/chat-file/upload-image", {
            method: "POST",
            body: formData
        });

        if (!response.ok) alert("Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®");
    });

    function handleIncoming(msg) {

        switch (msg.type) {
            case "TEXT":
            case "IMAGE":
                addMessage(msg);
                sendReadEvent();
                break;

            case "READ":
                handleRead(msg);
                break;

            case "TYPING":
                handleTyping(msg);
                break;

            case "DELETE":
                handleDelete(msg);
                break;

            default:
                console.warn("Unknown message type:", msg);
                break;
        }
    }

    chatBody.addEventListener("click", (e) => {
        if (!editMode) return;

        const btn = e.target.closest(".msg-delete-btn");
        if (!btn) return;

        const msgEl = btn.closest(".msg");
        if (!msgEl) return;
        if (!msgEl.classList.contains("me")) return;

        const msgId = msgEl.dataset.msgId;
        if (!msgId) return;

        if (!confirm("Ïù¥ Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

        sendDeleteEvent(msgId);
    });

    let lastMyMessageEl = null;

    function addMessage(msg) {

        let content = "";

        if (msg.type === "IMAGE" || (msg.message && msg.message.startsWith("[img]"))) {
            const path = msg.message.replace("[img]", "");
            content = `<img src="${path}" style="max-width:200px;border-radius:12px;">`;
        } else {
            content = msg.message;
        }

        const isMe = String(msg.senderId) === currentMemberId;

        const createdAtDate = msg.createdAt ? new Date(msg.createdAt) : new Date();
        const dateKey = createdAtDate.toISOString().slice(0, 10);
        const dateLabel = formatDateLabelByKey(dateKey);

        appendDateDividerIfNeeded(dateKey, dateLabel);

        if (isMe && lastMyMessageEl) {
            const prevStatus = lastMyMessageEl.querySelector(".status-row");
            if (prevStatus) prevStatus.remove();
        }

        const wrap = document.createElement("div");
        wrap.className = "msg " + (isMe ? "me" : "other");

        if (msg.messageId) wrap.dataset.msgId = msg.messageId;

        const statusHtml = isMe
            ? `<div class="status-row"><span class="read-status">ÏïàÏùΩÏùå</span></div>`
            : "";

        wrap.innerHTML = `
        <div class="bubble-row">
            <div class="time-left">${formatDateTime(msg.createdAt)}</div>
            <div class="bubble">${content}</div>
        </div>
        ${statusHtml}
        <button type="button" class="msg-delete-btn">ÏÇ≠Ï†ú</button>
    `;

        chatBody.appendChild(wrap);
        scrollToBottom();

        if (isMe) {
            lastMyMessageEl = wrap;
        }
    }

    function handleRead(msg) {
        if (String(msg.senderId) === currentMemberId) return;

        const lastMy = lastMyMessageEl || chatBody.querySelector(".msg.me:last-child");
        if (!lastMy) return;

        const statusEl = lastMy.querySelector(".read-status");
        if (statusEl) {
            statusEl.textContent = "ÏùΩÏùå";
        }
    }

    function handleTyping(msg) {

        if (String(msg.senderId) === currentMemberId) return;

        if (!typingIndicator) {
            typingIndicator = document.createElement("div");
            typingIndicator.id = "typingIndicator";
            typingIndicator.style.fontSize = "12px";
            typingIndicator.style.color = "#9CA3AF";
            typingIndicator.style.padding = "4px 16px 6px";
            typingIndicator.textContent = "ÏÉÅÎåÄÎ∞©Ïù¥ ÏûÖÎ†• Ï§ë‚Ä¶";
            chatBody.appendChild(typingIndicator);
        }

        typingIndicator.style.display = "block";

        if (typingTimer) clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
            typingIndicator.style.display = "none";
        }, TYPING_TIMEOUT);
    }

    function handleDelete(msg) {
        const target = chatBody.querySelector(`.msg[data-msg-id="${msg.messageId}"]`);
        if (!target) return;

        const bubble = target.querySelector(".bubble");
        bubble.textContent = "(ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏûÖÎãàÎã§)";
        bubble.style.color = "#9CA3AF";
        bubble.style.fontStyle = "italic";
    }

    const editBtn = document.getElementById("editBtn");
    if (editBtn) {
        editBtn.addEventListener("click", () => {
            editMode = !editMode;

            if (editMode) {
                chatRoomEl.classList.add("edit-mode");
                editBtn.classList.add("active");
                editBtn.textContent = "ÏôÑÎ£å";
            } else {
                chatRoomEl.classList.remove("edit-mode");
                editBtn.classList.remove("active");
                editBtn.textContent = "Ìé∏Ïßë";
            }
        });
    }

    const exitBtn = document.getElementById("exitBtn");
    if (exitBtn) {
        exitBtn.addEventListener("click", async () => {
            if (!confirm("Ï±ÑÌåÖÎ∞©ÏùÑ ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?")) return;

            try {
                const res = await fetch(`/trade/chat/${roomId}/leave`, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                if (!res.ok) {
                    alert("Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    return;
                }

                window.location.href = "/chat/list";
            } catch (e) {
                console.error(e);
                alert("ÏÑúÎ≤Ñ ÌÜµÏã† Ïò§Î•òÎ°ú Ï±ÑÌåÖÎ∞©ÏùÑ ÎÇòÍ∞à Ïàò ÏóÜÏäµÎãàÎã§.");
            }
        });
    }

    function scrollToBottom(instant) {
        const el = document.scrollingElement || document.documentElement;
        const top = el.scrollHeight;

        if (instant) {
            el.scrollTop = top;
        } else {
            el.scrollTo({
                top,
                behavior: "smooth"
            });
        }
    }

    const msgInput = document.getElementById("msgInput");
    msgInput.addEventListener("input", () => {
        sendTypingEvent();
    });

    window.onload = function () {
        const myMsgs = chatBody.querySelectorAll(".msg.me");
        if (myMsgs.length > 0) {
            lastMyMessageEl = myMsgs[myMsgs.length - 1];
            for (let i = 0; i < myMsgs.length - 1; i++) {
                const statusRow = myMsgs[i].querySelector(".status-row");
                if (statusRow) statusRow.remove();
            }
        }
        insertInitialDateDividers();
        connectWebSocket();
        setTimeout(() => {
            scrollToBottom(true);
        }, 0);
    };
</script>

</body>
</html>