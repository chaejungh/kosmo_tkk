<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Í±∞Îûò Ï±ÑÌåÖÎ∞© | ÎçîÏø†Ïø†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- WebSocket ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #F9FAFB;
            color: #111827;
        }

        .chat-room {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F9FAFB;
            display: flex;
            flex-direction: column;
        }

        .room-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #ffffff;
            border-bottom: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .room-topbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
        }

        .back-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            color: #4B5563;
            font-size: 18px;
            cursor: pointer;
        }

        .seller-info { display: flex; flex-direction: column; gap: 2px; }
        .seller-name { font-size: 15px; font-weight: 700; color: #111827; }
        .seller-sub { font-size: 12px; color: #6B7280; }

        .product-card {
            display: flex; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB; background: #ffffff;
        }

        .product-thumb {
            width: 52px; height: 52px; border-radius: 12px;
            overflow: hidden; background: #F3F4F6; flex-shrink: 0;
        }

        .product-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .product-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }

        .badge-onsale { background: rgba(99,102,241,0.12); color: #4F46E5; }
        .badge-reserved { background: rgba(251,191,36,0.15); color: #D97706; }
        .badge-sold { background: #E5E7EB; color: #6B7280; }

        .product-title {
            font-size: 13px; font-weight: 600; color: #111827;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .product-price { font-size: 13px; color: #4F46E5; font-weight: 700; }

        .chat-body {
            flex: 1; display: flex; flex-direction: column;
            padding: 14px 14px 0;
            overflow-y: auto; background: #F9FAFB;
        }

        .msg {
            max-width: 70%; margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 4px;
        }

        .msg.me { margin-left: auto; align-items: flex-end; }
        .msg.other { margin-right: auto; align-items: flex-start; }

        .bubble {
            padding: 10px 14px; font-size: 14px; line-height: 1.45;
            border-radius: 20px; word-break: break-word;
        }

        .me .bubble {
            background: #6366F1; color: #ffffff;
            border-bottom-right-radius: 6px;
        }

        .other .bubble {
            background: #ffffff; color: #111827;
            border: 1px solid #E5E7EB; border-bottom-left-radius: 6px;
        }

        .time { font-size: 11px; color: #9CA3AF; padding: 0 4px; }

        .chat-input-wrap {
            position: sticky; bottom: 0; background: #ffffff;
            border-top: 1px solid #E5E7EB; padding: 12px 14px;
        }

        .chat-input-form { display: flex; align-items: center; gap: 10px; }

        .btn-plus {
            width: 32px; height: 32px; border-radius: 999px;
            border: 1px solid #E5E7EB; background: #ffffff;
            font-size: 20px; color: #4B5563; cursor: pointer;
        }

        .msg-input {
            flex: 1; border-radius: 999px; border: 1px solid #D1D5DB;
            background: #ffffff; padding: 10px 16px;
        }

        .btn-send {
            border-radius: 999px; border: none;
            background: #6366F1; color: #ffffff;
            font-size: 14px; font-weight: 600;
            padding: 9px 18px; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="chat-room">

    <!-- ÏÉÅÎã® -->
    <div class="room-header">
        <div class="room-topbar">
            <button class="back-btn"
                    th:onclick="|location.href='@{/trade/{memberId}/chat(memberId=${memberId})}'|">‚Üê</button>

            <div class="seller-info">
                <div class="seller-name" th:text="${sellerName}"></div>
                <div class="seller-sub">Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</div>
            </div>
        </div>

        <div class="product-card">
            <div class="product-thumb">
                <img th:src="${productThumbnailUrl}">
            </div>
            <div class="product-info">
                <span th:text="${productStatusLabel}"
                      th:class="'badge ' + ${productStatusClass}"></span>

                <div class="product-title" th:text="${productTitle}"></div>
                <div class="product-price" th:text="${productPriceText}"></div>
            </div>
        </div>
    </div>

    <!-- Î©îÏãúÏßÄ Î™©Î°ù -->
    <div class="chat-body" id="chatBody">
        <!-- Í∏∞Ï°¥ Î©îÏãúÏßÄ Î†åÎçîÎßÅ -->
        <div th:each="msg : ${msgList}"
             th:class="'msg ' + (${msg.senderId} == ${currentMemberId} ? 'me' : 'other')">

            <div class="bubble">

                <span th:if="${!#strings.startsWith(msg.message, '[img]')}"
                      th:text="${msg.message}"></span>

                <img th:if="${#strings.startsWith(msg.message, '[img]')}"
                     th:src="@{${#strings.substring(msg.message, 5)}}"
                     style="max-width:200px; border-radius:12px;">
            </div>

            <div class="time"
                 th:text="${msg.createdAt != null ? msg.createdAt : ''}"></div>
        </div>
    </div>

    <!-- ÏûÖÎ†• Î∞ïÏä§ -->
    <div class="chat-input-wrap">
        <form class="chat-input-form" onsubmit="return sendMessage();">
            <button type="button" class="btn-plus" onclick="selectImage()">+</button>
            <input type="file" id="imgFile" accept="image/*" style="display:none;" />

            <input type="text" id="msgInput" class="msg-input"
                   placeholder="Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞" autocomplete="off">

            <button type="submit" class="btn-send">Ï†ÑÏÜ°</button>
        </form>
    </div>
</div>


<!-- ========================================== -->
<!--                WebSocket Script            -->
<!-- ========================================== -->

<script>
    const memberId = String("[[${memberId}]]");
    const roomId = String("[[${room.id}]]");
    const chatBody = document.getElementById("chatBody");

    let stompClient = null;

    let typingTimer = null;
    const TYPING_TIMEOUT = 2000;
    let typingIndicator = null;

    function formatTime(date) {
        let hour = date.getHours();
        let minute = String(date.getMinutes()).padStart(2, '0');
        const ampm = hour >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
        hour = hour % 12 || 12;
        return `${ampm} ${hour}:${minute}`;
    }

    function formatDate(date) {
        const today = new Date();
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const diff = (t - d) / 86400000;

        if (diff === 0) return "Ïò§Îäò";
        if (diff === 1) return "Ïñ¥Ï†ú";

        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    function formatDateTime(str) {
        if (!str) return "Î∞©Í∏à Ï†Ñ";
        let date = new Date(str);
        if (isNaN(date.getTime())) return "Î∞©Í∏à Ï†Ñ";
        return `${formatDate(date)} ${formatTime(date)}`;
    }

    function connectWebSocket() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            stompClient.subscribe(`/sub/chat.room.${roomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                handleIncoming(body);
            });

            sendReadEvent();
        });
    }

    function sendReadEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.read", {}, JSON.stringify({
            roomId,
            senderId: memberId,
            type: "READ"
        }));
    }

    function sendTypingEvent() {
        if (!stompClient) return;
        stompClient.send("/pub/chat.typing", {}, JSON.stringify({
            roomId,
            senderId: memberId,
            type: "TYPING"
        }));
    }

    function sendDeleteEvent(messageId) {
        if (!stompClient) return;
        stompClient.send("/pub/chat.delete", {}, JSON.stringify({
            roomId,
            senderId: memberId,
            messageId,
            type: "DELETE"
        }));
    }

    function sendMessage() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text) return false;

        stompClient.send("/pub/chat.send", {}, JSON.stringify({
            roomId,
            senderId: memberId,
            message: text,
            type: "TEXT"
        }));

        input.value = "";
        return false;
    }

    function selectImage() {
        document.getElementById("imgFile").click();
    }

    document.getElementById("imgFile").addEventListener("change", async (e) => {

        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("roomId", roomId);
        formData.append("senderId", memberId);
        formData.append("image", file);

        // ‚úÖ ChatFileController ÏôÄ Îß§ÌïëÎêòÎäî Í≤ΩÎ°ú ( /chat-file + /upload-image )
        const response = await fetch("/chat-file/upload-image", {
            method: "POST",
            body: formData
        });

        if (!response.ok) alert("Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®");

    });

    function handleIncoming(msg) {

        switch (msg.type) {

            // üîπ TEXT/IMAGEÎßå Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            case "TEXT":
            case "IMAGE":
                addMessage(msg);
                break;

            // üîπ ÏùΩÏùå Ï≤òÎ¶¨
            case "READ":
                handleRead(msg);
                break;

            // üîπ ÏÉÅÎåÄ typing
            case "TYPING":
                handleTyping(msg);
                break;

            // üîπ Î©îÏãúÏßÄ ÏÇ≠Ï†ú
            case "DELETE":
                handleDelete(msg);
                break;

            // üîπ Í∑∏ Ïô∏ ÌÉÄÏûÖÏùÄ Î¨¥Ïãú
            default:
                console.warn("Unknown message type:", msg);
                break;
        }
    }

    let lastMyMessageEl = null;

    function addMessage(msg) {

        let content = "";

        if (msg.type === "IMAGE" || (msg.message && msg.message.startsWith("[img]"))) {
            const path = msg.message.replace("[img]", "");
            content = `<img src="${path}" style="max-width:200px;border-radius:12px;">`;
        } else {
            content = msg.message;
        }

        const wrap = document.createElement("div");
        wrap.className = "msg " + (String(msg.senderId) === memberId ? "me" : "other");

        if (msg.messageId) wrap.dataset.msgId = msg.messageId;

        wrap.innerHTML = `
            <div class="bubble">${content}</div>
            <div class="time">${formatDateTime(msg.createdAt)}</div>
        `;

        chatBody.appendChild(wrap);
        scrollToBottom();

        if (String(msg.senderId) === memberId) {
            lastMyMessageEl = wrap;
        }
    }

    function handleRead(msg) {
        if (String(msg.senderId) === memberId) return;

        const lastMy = lastMyMessageEl || chatBody.querySelector(".msg.me:last-child");
        if (!lastMy) return;

        const timeEl = lastMy.querySelector(".time");
        if (timeEl && !timeEl.textContent.includes("ÏùΩÏùå")) {
            timeEl.textContent += " ¬∑ ÏùΩÏùå";
        }
    }

    function handleTyping(msg) {

        if (String(msg.senderId) === memberId) return;

        if (!typingIndicator) {
            typingIndicator = document.createElement("div");
            typingIndicator.id = "typingIndicator";
            typingIndicator.style.fontSize = "12px";
            typingIndicator.style.color = "#9CA3AF";
            typingIndicator.style.padding = "4px 16px 6px";
            typingIndicator.textContent = "ÏÉÅÎåÄÎ∞©Ïù¥ ÏûÖÎ†• Ï§ë‚Ä¶";
            chatBody.appendChild(typingIndicator);
        }

        typingIndicator.style.display = "block";

        if (typingTimer) clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
            typingIndicator.style.display = "none";
        }, TYPING_TIMEOUT);
    }

    function handleDelete(msg) {
        const target = chatBody.querySelector(`.msg[data-msg-id="${msg.messageId}"]`);
        if (!target) return;

        const bubble = target.querySelector(".bubble");
        bubble.textContent = "(ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏûÖÎãàÎã§)";
        bubble.style.color = "#9CA3AF";
        bubble.style.fontStyle = "italic";
    }

    function scrollToBottom() {
        setTimeout(() => {
            chatBody.scrollTo({
                top: chatBody.scrollHeight,
                behavior: "smooth"
            });
        }, 10);
    }

    const msgInput = document.getElementById("msgInput");
    msgInput.addEventListener("input", () => {
        sendTypingEvent();
    });

    window.onload = function () {
        connectWebSocket();
        scrollToBottom();
    };
</script>

</body>
</html>