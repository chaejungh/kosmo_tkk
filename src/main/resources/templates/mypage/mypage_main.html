<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나의 더쿠쿠</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" th:href="@{/css/mypage.css}"/>
</head>

<body>
<div class="mypage-bg">
    <div class="mypage-container">

        <!-- 상단 타이틀 -->
        <div class="mypage-top">
            <div class="mypage-top-title">
                <h2 class="page-title">마이페이지</h2>
                <p class="page-sub">나의 활동과 정보를 관리하세요</p>
            </div>
        </div>

        <div class="mypage-grid">

            <!-- =========================
                 LEFT : 프로필 요약 + 메뉴
                 ========================= -->
            <aside class="left-col">

                <!-- 프로필 요약 카드 -->
                <section class="profile-summary">
                    <!-- ✅ 이미지 클릭하면 파일 선택(수정모드일 때만 업로드/저장) -->
                    <label for="profileImageInput" class="avatar-wrap" title="프로필 사진 변경">
                        <img
                                id="profileImage"
                                class="avatar"
                                th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                src="/images/default_profile.png"
                                alt="프로필">
                        <span class="avatar-badge">📷</span>
                    </label>

                    <!-- ✅ id 유지 -->
                    <input id="profileImageInput" type="file" accept="image/*" style="display:none;">

                    <div class="profile-text">
                        <div class="nickname-line">
                            <span class="nickname" id="nickname" th:text="${member.nickname}">닉네임</span>
                        </div>

                        <div class="intro" id="intro" th:text="${member.intro}">한 줄 소개를 입력해 주세요.</div>

                        <div class="profile-meta">
                            <span class="meta-pill">ID</span>
                            <span class="meta-value" th:text="${member.id}">1</span>
                        </div>
                    </div>

                    <!-- 통계(현재 값 없어서 0) -->
                    <div class="profile-stats">
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">게시글</div>
                        </div>
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">댓글</div>
                        </div>
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">좋아요</div>
                        </div>
                    </div>
                </section>

                <!-- 메뉴 카드 -->
                <nav class="menu-card">
                    <a class="menu-item active" th:href="@{'/mypage/' + ${member.id} + '/'}">
                        <span class="menu-ico">👤</span>
                        <span class="menu-txt">프로필 설정</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/posts'}">
                        <span class="menu-ico">📝</span>
                        <span class="menu-txt">게시판 활동</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/likes'}">
                        <span class="menu-ico">❤️</span>
                        <span class="menu-txt">좋아요 한 글</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/bookmarks'}">
                        <span class="menu-ico">📌</span>
                        <span class="menu-txt">북마크</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/trade/mine'}">
                        <span class="menu-ico">📦</span>
                        <span class="menu-txt">쿠쿠마켓 활동</span>
                    </a>

                    <a class="menu-item" th:href="@{/mypage/{memberId}/stores(memberId=${member.id})}">
                        <span class="menu-ico">🏪</span>
                        <span class="menu-txt">찜한 매장</span>
                    </a>

                    <a class="menu-item" th:href="@{/mypage/{memberId}/popups(memberId=${member.id})}">
                        <span class="menu-ico">🎪</span>
                        <span class="menu-txt">찜한 팝업스토어</span>
                    </a>

                    <div class="menu-divider"></div>

                    <a class="menu-item" href="/mypage/service/setting">
                        <span class="menu-ico">⚙</span>
                        <span class="menu-txt">설정 & 고객센터</span>
                    </a>

                    <a class="menu-item danger" href="/mypage/service/logout">
                        <span class="menu-ico">🚪</span>
                        <span class="menu-txt">로그아웃</span>
                    </a>
                </nav>

            </aside>

            <!-- =========================
                 RIGHT : 프로필 설정
                 ========================= -->
            <main class="right-col">

                <section class="panel">
                    <div class="panel-head">
                        <div>
                            <h3 class="panel-title">프로필 설정</h3>
                            <p class="panel-sub">수정 버튼을 누르면 바로 수정할 수 있어요</p>
                        </div>

                        <button id="editOpenBtn" class="btn btn-dark" type="button">수정</button>
                    </div>

                    <div class="panel-body">

                        <!-- =========================
                             보기 모드 (수정 누르면 숨김)
                             ========================= -->
                        <div id="viewMode">

                            <div class="photo-row view-only">
                                <div class="photo">
                                    <img
                                            id="profileImageRight"
                                            class="photo-img"
                                            th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                            src="/images/default_profile.png"
                                            alt="프로필">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-field">
                                    <label class="label">닉네임</label>
                                    <div class="readonly" th:text="${member.nickname}">닉네임</div>
                                </div>

                                <div class="form-field">
                                    <label class="label">소개</label>
                                    <div class="readonly" th:text="${member.intro}">소개</div>
                                </div>
                            </div>
                        </div>

                        <!-- =========================
                             수정 모드 (처음엔 숨김)
                             ✅ 저장 시: updateProfile로 nickname/intro/profileImage(URL) 전송
                             ========================= -->
                        <form id="editMode"
                              th:action="@{'/mypage/' + ${member.id} + '/profile'}"
                              method="post"
                              class="edit-form"
                              style="display:none;">

                            <div class="edit-photo-row">
                                <div class="edit-photo-left">
                                    <div class="mini-photo">
                                        <img id="editPreview"
                                             th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                             src="/images/default_profile.png"
                                             alt="프로필">
                                    </div>
                                    <div class="edit-photo-text">
                                        <div class="edit-photo-title">프로필 사진</div>
                                        <div class="edit-photo-sub">사진 변경 후 저장하면 반영됩니다</div>
                                    </div>
                                </div>

                                <!-- ✅ 수정모드에서만 버튼 노출 -->
                                <label for="profileImageInput" class="btn btn-ghost">사진 변경</label>
                            </div>

                            <div class="edit-grid">
                                <div class="form-field">
                                    <label class="label">새 닉네임</label>
                                    <input type="text"
                                           name="nickname"
                                           class="input"
                                           th:value="${member.nickname}"
                                           placeholder="새 닉네임"
                                           required>
                                </div>

                                <div class="form-field">
                                    <label class="label">소개</label>
                                    <textarea name="intro"
                                              class="textarea"
                                              placeholder="한 줄 소개"
                                              required
                                              th:text="${#strings.isEmpty(member.intro) ? '안녕하세요, ' + member.nickname + '입니다.' : member.intro}"></textarea>
                                </div>
                            </div>

                            <!-- ✅ 컨트롤러가 저장하는 URL 문자열 -->
                            <input type="hidden"
                                   id="profileImageHidden"
                                   name="profileImage"
                                   th:value="${member.profileImageUrl}">

                            <div class="edit-actions">
                                <button type="submit" class="btn btn-dark" id="saveBtn">저장</button>
                                <button type="button" id="editCancelBtn" class="btn btn-ghost">취소</button>
                            </div>

                            <div class="edit-hint" id="uploadState" style="display:none;"></div>
                        </form>

                        <script>
                            // =========================
                            // 보기/수정 전환 (중복 제거)
                            // =========================
                            const viewMode = document.getElementById("viewMode");
                            const editMode = document.getElementById("editMode");
                            const editOpenBtn = document.getElementById("editOpenBtn");
                            const editCancelBtn = document.getElementById("editCancelBtn");

                            editOpenBtn.onclick = () => {
                                viewMode.style.display = "none";
                                editMode.style.display = "block";
                            };

                            editCancelBtn.onclick = () => {
                                editMode.style.display = "none";
                                viewMode.style.display = "block";
                            };

                            // =========================
                            // 사진 업로드 (S3) → URL 받아서 hidden에 저장
                            // =========================
                            const fileInput = document.getElementById("profileImageInput");

                            const leftImg = document.getElementById("profileImage");        // 왼쪽 카드
                            const rightImg = document.getElementById("profileImageRight");  // 보기 모드
                            const editImg = document.getElementById("editPreview");         // 수정 모드

                            const hidden = document.getElementById("profileImageHidden");
                            const uploadState = document.getElementById("uploadState");

                            // ✅ 우리가 만든 업로드 API
                            const UPLOAD_ENDPOINT = "/api/upload/profile";

                            function setState(msg, show = true) {
                                uploadState.textContent = msg;
                                uploadState.style.display = show ? "block" : "none";
                            }

                            fileInput?.addEventListener("change", async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;

                                // 1) 미리보기(즉시)
                                const localUrl = URL.createObjectURL(file);
                                if (leftImg) leftImg.src = localUrl;
                                if (rightImg) rightImg.src = localUrl;
                                if (editImg) editImg.src = localUrl;

                                // 2) 업로드 시작 안내
                                setState("사진 업로드 중...");

                                try {
                                    const fd = new FormData();
                                    fd.append("file", file);

                                    const res = await fetch(UPLOAD_ENDPOINT, {
                                        method: "POST",
                                        body: fd
                                    });

                                    if (!res.ok) {
                                        throw new Error("upload failed: " + res.status);
                                    }

                                    const data = await res.json(); // { url: "..." }
                                    if (!data?.url) {
                                        throw new Error("no url in response");
                                    }

                                    // ✅ 이 URL이 updateProfile로 전송되어 DB에 저장됨
                                    hidden.value = data.url;

                                    setState("업로드 완료! 저장을 누르면 반영됩니다 ✅");
                                } catch (err) {
                                    console.error(err);
                                    setState("업로드 실패 😭 (업로드 API/권한/응답형식 확인 필요)");
                                }
                            });

                            // 저장 전에 업로드 중이면 막기(선택)
                            editMode?.addEventListener("submit", (e) => {
                                // 파일을 선택했는데 업로드가 실패해서 hidden이 그대로면 저장해도 사진이 안 바뀜
                                // hidden이 비어있으면 경고만 하고 막지 않아도 됨(원하는 방식으로)
                                if (!hidden.value) {
                                    // 사진 안 바꾸는 경우도 있으니 막지는 않음
                                    return;
                                }
                            });
                        </script>

                    </div>
                </section>

            </main>

        </div>
    </div>
</div>

<!-- 하단 네비 -->
<nav class="bottom-nav">
    <a th:href="@{/}" class="nav-item">
        <span class="icon">🏠</span>
        <span>홈</span>
    </a>
    <a th:href="@{/board}" class="nav-item">
        <span class="icon">📁</span>
        <span>덕질게시판</span>
    </a>
    <a th:href="@{/mypage}" class="nav-item active">
        <span class="icon">👤</span>
        <span>내정보</span>
    </a>
</nav>

<script src="/js/mypage.js"></script>
</body>
</html>