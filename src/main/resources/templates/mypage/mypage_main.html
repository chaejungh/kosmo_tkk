<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ì˜ ë”ì¿ ì¿ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" th:href="@{/css/mypage.css}"/>
</head>

<body>
<div class="mypage-bg">
    <div class="mypage-container">

        <!-- ìƒë‹¨ íƒ€ì´í‹€ -->
        <div class="mypage-top">
            <div class="mypage-top-title">
                <h2 class="page-title">ë§ˆì´í˜ì´ì§€</h2>
                <p class="page-sub">ë‚˜ì˜ í™œë™ê³¼ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
        </div>

        <div class="mypage-grid">

            <!-- =========================
                 LEFT : í”„ë¡œí•„ ìš”ì•½ + ë©”ë‰´
                 ========================= -->
            <aside class="left-col">

                <!-- í”„ë¡œí•„ ìš”ì•½ ì¹´ë“œ -->
                <section class="profile-summary">
                    <!-- âœ… ì‚¬ì§„ í´ë¦­í•˜ë©´ íŒŒì¼ ì„ íƒ (ë¯¸ë¦¬ë³´ê¸°) -->
                    <label for="profileImageInput" class="avatar-wrap" title="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½">
                        <img
                                id="profileImage"
                                class="avatar"
                                th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                src="/images/default_profile.png"
                                alt="í”„ë¡œí•„">
                        <span class="avatar-badge">ğŸ“·</span>
                    </label>

                    <!-- âœ… id ìœ ì§€ -->
                    <input id="profileImageInput" type="file" accept="image/*" style="display:none;">

                    <div class="profile-text">
                        <div class="nickname-line">
                            <span class="nickname" id="nickname" th:text="${member.nickname}">ë‹‰ë„¤ì„</span>
                        </div>

                        <div class="intro" id="intro" th:text="${member.intro}">í•œ ì¤„ ì†Œê°œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>

                        <div class="profile-meta">
                            <span class="meta-pill">ID</span>
                            <span class="meta-value" th:text="${member.id}">1</span>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">ê²Œì‹œê¸€</div>
                        </div>
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">ëŒ“ê¸€</div>
                        </div>
                        <div class="stat">
                            <div class="num">0</div>
                            <div class="label">ì¢‹ì•„ìš”</div>
                        </div>
                    </div>
                </section>

                <!-- ë©”ë‰´ ì¹´ë“œ -->
                <nav class="menu-card">
                    <a class="menu-item active" th:href="@{'/mypage/' + ${member.id} + '/'}">
                        <span class="menu-ico">ğŸ‘¤</span>
                        <span class="menu-txt">í”„ë¡œí•„ ì„¤ì •</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/posts'}">
                        <span class="menu-ico">ğŸ“</span>
                        <span class="menu-txt">ê²Œì‹œíŒ í™œë™</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/likes'}">
                        <span class="menu-ico">â¤ï¸</span>
                        <span class="menu-txt">ì¢‹ì•„ìš” í•œ ê¸€</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/bookmarks'}">
                        <span class="menu-ico">ğŸ“Œ</span>
                        <span class="menu-txt">ë¶ë§ˆí¬</span>
                    </a>

                    <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/trade/mine'}">
                        <span class="menu-ico">ğŸ“¦</span>
                        <span class="menu-txt">ì¿ ì¿ ë§ˆì¼“ í™œë™</span>
                    </a>

                    <a class="menu-item" th:href="@{/mypage/{memberId}/stores(memberId=${member.id})}">
                        <span class="menu-ico">ğŸª</span>
                        <span class="menu-txt">ì°œí•œ ë§¤ì¥</span>
                    </a>

                    <a class="menu-item" th:href="@{/mypage/{memberId}/popups(memberId=${member.id})}">
                        <span class="menu-ico">ğŸª</span>
                        <span class="menu-txt">ì°œí•œ íŒì—…ìŠ¤í† ì–´</span>
                    </a>

                    <div class="menu-divider"></div>

                    <a class="menu-item" href="/mypage/service/setting">
                        <span class="menu-ico">âš™</span>
                        <span class="menu-txt">ì„¤ì • & ê³ ê°ì„¼í„°</span>
                    </a>

                    <a class="menu-item danger" href="/mypage/service/logout">
                        <span class="menu-ico">ğŸšª</span>
                        <span class="menu-txt">ë¡œê·¸ì•„ì›ƒ</span>
                    </a>
                </nav>
            </aside>

            <!-- =========================
                 RIGHT : í”„ë¡œí•„ ì„¤ì •
                 ========================= -->
            <main class="right-col">

                <section class="panel">
                    <div class="panel-head">
                        <div>
                            <h3 class="panel-title">í”„ë¡œí•„ ì„¤ì •</h3>
                            <p class="panel-sub">ë‹‰ë„¤ì„/ì†Œê°œ/ì‚¬ì§„ì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”</p>
                        </div>

                        <!-- âœ… ìˆ˜ì • ë²„íŠ¼ ëˆ„ë¥´ë©´ í¸ì§‘ì˜ì—­ + ì‚¬ì§„ë³€ê²½ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚¨ -->
                        <button id="nicknameEditBtn" class="btn btn-dark" type="button">ìˆ˜ì •</button>
                    </div>

                    <div class="panel-body">

                        <!-- âœ… í‰ì†Œì—ëŠ” ì‚¬ì§„ ë³€ê²½ ë²„íŠ¼ ì—†ìŒ (ìš”ì²­ ë°˜ì˜) -->
                        <div class="photo-row view-only">
                            <div class="photo">
                                <img
                                        id="profileImageRight"
                                        class="photo-img"
                                        th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                        src="/images/default_profile.png"
                                        alt="í”„ë¡œí•„">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <label class="label">ë‹‰ë„¤ì„</label>
                                <div class="readonly" th:text="${member.nickname}">ë‹‰ë„¤ì„</div>
                            </div>

                            <div class="form-field">
                                <label class="label">ì†Œê°œ</label>
                                <div class="readonly" th:text="${member.intro}">ì†Œê°œ</div>
                            </div>
                        </div>

                        <!-- âœ… ê¸°ì¡´ í¼ id/action ìœ ì§€ + profileImage íŒŒë¼ë¯¸í„° ìœ ì§€ -->
                        <form id="nicknameForm"
                              th:action="@{'/mypage/' + ${member.id} + '/profile'}"
                              method="post"
                              class="edit-form"
                              style="display:none;">

                            <!-- âœ… ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ ì‚¬ì§„ ë³€ê²½ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° -->
                            <div class="edit-photo-row">
                                <div class="edit-photo-left">
                                    <div class="mini-photo">
                                        <img id="editPreview"
                                             th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                             src="/images/default_profile.png"
                                             alt="í”„ë¡œí•„">
                                    </div>
                                    <div class="edit-photo-text">
                                        <div class="edit-photo-title">í”„ë¡œí•„ ì‚¬ì§„</div>
                                        <div class="edit-photo-sub">ìˆ˜ì • ìƒíƒœì—ì„œë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”</div>
                                    </div>
                                </div>

                                <!-- íŒŒì¼ inputì€ ì™¼ìª½ì— ìˆì§€ë§Œ, label forë¡œ íŠ¸ë¦¬ê±° ê°€ëŠ¥ -->
                                <label for="profileImageInput" class="btn btn-ghost">ì‚¬ì§„ ë³€ê²½</label>
                            </div>

                            <div class="edit-grid">
                                <div class="form-field">
                                    <label class="label">ìƒˆ ë‹‰ë„¤ì„</label>
                                    <input type="text"
                                           name="nickname"
                                           class="input"
                                           th:value="${member.nickname}"
                                           placeholder="ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                           required>
                                </div>

                                <div class="form-field">
                                    <label class="label">ì†Œê°œ</label>
                                    <textarea name="intro"
                                              class="textarea"
                                              placeholder="í•œ ì¤„ ì†Œê°œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."
                                              required
                                              th:text="${#strings.isEmpty(member.intro) ? 'ì•ˆë…•í•˜ì„¸ìš”, ' + member.nickname + 'ì…ë‹ˆë‹¤.' : member.intro}"></textarea>
                                </div>
                            </div>

                            <!-- âœ… ì—¬ê¸° ê°’ì´ DBì— ì €ì¥ë˜ëŠ” profileImageUrlì´ ë¨ -->
                            <input type="hidden" id="profileImageHidden" name="profileImage"
                                   th:value="${member.profileImageUrl}">

                            <div class="edit-actions">
                                <button type="submit" class="btn btn-dark">ì €ì¥</button>
                                <button type="button" id="nicknameCancelBtn" class="btn btn-ghost">ì·¨ì†Œ</button>
                            </div>

                            <div class="edit-hint">
                                â€» ì‚¬ì§„ì´ â€œì €ì¥ê¹Œì§€â€ ë˜ë ¤ë©´ ì—…ë¡œë“œ í›„ URLì´ profileImageHiddenì— ë“¤ì–´ê°€ì•¼ í•´ìš”.
                            </div>
                        </form>

                        <script>
                            // ====== ìˆ˜ì •/ì·¨ì†Œ í† ê¸€ ======
                            const editBtn = document.getElementById("nicknameEditBtn");
                            const form = document.getElementById("nicknameForm");
                            const cancelBtn = document.getElementById("nicknameCancelBtn");

                            editBtn.onclick = function () {
                                form.style.display = "block";
                            };
                            cancelBtn.onclick = function () {
                                form.style.display = "none";
                            };

                            // ====== ì‚¬ì§„ ë³€ê²½(í”„ë¡ íŠ¸ ë¯¸ë¦¬ë³´ê¸° + (ê°€ëŠ¥í•˜ë©´) ì—…ë¡œë“œ) ======
                            const fileInput = document.getElementById("profileImageInput");
                            const leftImg = document.getElementById("profileImage");
                            const rightImg = document.getElementById("profileImageRight");
                            const editImg = document.getElementById("editPreview");
                            const hidden = document.getElementById("profileImageHidden");

                            /**
                             * âœ… ì—…ë¡œë“œ APIê°€ ì´ë¯¸ ìˆë‹¤ë©´, ì—¬ê¸°ë§Œ ë„ˆí¬ í”„ë¡œì íŠ¸ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ê¾¸ë©´
                             *    DB ì €ì¥ê¹Œì§€ ë¨ (hiddenì— URL ë„£ê³  ì €ì¥ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë)
                             *
                             * ì˜ˆì‹œ) "/api/upload/profile" ê°™ì€ ê²ƒ
                             */
                            const UPLOAD_ENDPOINT = "/api/upload/profile"; // <- ë„ˆí¬ ì—…ë¡œë“œ ì£¼ì†Œ ìˆìœ¼ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •

                            fileInput?.addEventListener("change", async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;

                                // 1) ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸°(í™”ë©´ì—ì„œ ë°”ë¡œ ë°”ë€Œê²Œ)
                                const localUrl = URL.createObjectURL(file);
                                if (leftImg) leftImg.src = localUrl;
                                if (rightImg) rightImg.src = localUrl;
                                if (editImg) editImg.src = localUrl;

                                // 2) ì—…ë¡œë“œ APIê°€ ìˆìœ¼ë©´ ì—…ë¡œë“œí•´ì„œ URL ë°›ì•„ hiddenì— ë„£ê¸°
                                //    (ì—…ë¡œë“œ APIê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì‹¤íŒ¨ -> ê·¸ë˜ë„ ë¯¸ë¦¬ë³´ê¸°ëŠ” ë¨)
                                try {
                                    const fd = new FormData();
                                    fd.append("file", file);

                                    const res = await fetch(UPLOAD_ENDPOINT, {
                                        method: "POST",
                                        body: fd
                                    });

                                    if (!res.ok) throw new Error("upload failed");

                                    const data = await res.json(); // { url: "https://..." } í˜•íƒœ ê°€ì •
                                    if (data?.url) {
                                        hidden.value = data.url; // âœ… ì´ ê°’ì´ ì €ì¥ë¨
                                    } else {
                                        throw new Error("no url in response");
                                    }
                                } catch (err) {
                                    // ì—…ë¡œë“œ APIê°€ ì—†ê±°ë‚˜ ì‘ë‹µì´ ë‹¤ë¥´ë©´ ì—¬ê¸°ë¡œ ì˜´
                                    // â†’ ê·¸ë˜ë„ ë¯¸ë¦¬ë³´ê¸°ëŠ” ë˜ë‹ˆê¹Œ ì‚¬ìš©ìëŠ” â€œë°”ë€ ê²ƒâ€ì²˜ëŸ¼ ë³´ì„
                                    console.warn("í”„ë¡œí•„ ì—…ë¡œë“œ APIê°€ ì—†ê±°ë‚˜ ì‘ë‹µì´ ë‹¤ë¦…ë‹ˆë‹¤.", err);
                                }
                            });
                        </script>

                    </div>
                </section>

                <!-- âœ… ë…¸ë€ìƒ‰ ë™ê·¸ë¼ë¯¸ ì„¹ì…˜(í€µì¹´ë“œ) ì‚­ì œ (ìš”ì²­ ë°˜ì˜) -->

            </main>

        </div>
    </div>
</div>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="bottom-nav">
    <a th:href="@{/}" class="nav-item">
        <span class="icon">ğŸ </span>
        <span>í™ˆ</span>
    </a>
    <a th:href="@{/board}" class="nav-item">
        <span class="icon">ğŸ“</span>
        <span>ë•ì§ˆê²Œì‹œíŒ</span>
    </a>
    <a th:href="@{/mypage}" class="nav-item active">
        <span class="icon">ğŸ‘¤</span>
        <span>ë‚´ì •ë³´</span>
    </a>
</nav>

<script src="/js/mypage.js"></script>
</body>
</html>