<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/fragments/mypage_fragment/layout}">

<head>
    <th:block layout:fragment="head">
        <style>
            /* âœ… (ì›í•˜ë©´ ìœ ì§€) footer/ë‚´ìš© ì—¬ë°±ìš© */
            .bottom-nav-spacer { height: 90px; }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <div class="mypage-bg">
        <div class="mypage-container">

            <!-- ìƒë‹¨ íƒ€ì´í‹€ -->
            <div class="mypage-top">
                <div class="mypage-top-title">
                    <h2 class="page-title">ë§ˆì´í˜ì´ì§€</h2>
                    <p class="page-sub">ë‚˜ì˜ í™œë™ê³¼ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
                </div>
            </div>

            <div class="mypage-grid">

                <!-- =========================
                     LEFT : í”„ë¡œí•„ ìš”ì•½ + ë©”ë‰´
                     ========================= -->
                <aside class="left-col">

                    <!-- í”„ë¡œí•„ ìš”ì•½ ì¹´ë“œ -->
                    <section class="profile-summary">
                        <label for="profileImageInput" class="avatar-wrap" title="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½">
                            <img
                                    id="profileImage"
                                    class="avatar"
                                    th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                    src="/images/default_profile.png"
                                    alt="í”„ë¡œí•„">
                            <span class="avatar-badge">ğŸ“·</span>
                        </label>

                        <input id="profileImageInput" type="file" accept="image/*" style="display:none;">

                        <div class="profile-text">
                            <div class="nickname-line">
                                <span class="nickname" id="nickname" th:text="${member.nickname}">ë‹‰ë„¤ì„</span>
                            </div>

                            <div class="intro" id="intro" th:text="${member.intro}">í•œ ì¤„ ì†Œê°œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>

                            <div class="profile-meta">
                                <span class="meta-pill">ID</span>
                                <span class="meta-value" th:text="${member.id}">1</span>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="stat">
                                <div class="num">0</div>
                                <div class="label">ê²Œì‹œê¸€</div>
                            </div>
                            <div class="stat">
                                <div class="num">0</div>
                                <div class="label">ëŒ“ê¸€</div>
                            </div>
                            <div class="stat">
                                <div class="num">0</div>
                                <div class="label">ì¢‹ì•„ìš”</div>
                            </div>
                        </div>
                    </section>

                    <!-- ë©”ë‰´ ì¹´ë“œ -->
                    <nav class="menu-card">
                        <a class="menu-item active" th:href="@{'/mypage/' + ${member.id} + '/'}">
                            <span class="menu-ico">ğŸ‘¤</span>
                            <span class="menu-txt">í”„ë¡œí•„ ì„¤ì •</span>
                        </a>

                        <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/posts'}">
                            <span class="menu-ico">ğŸ“</span>
                            <span class="menu-txt">ê²Œì‹œíŒ í™œë™</span>
                        </a>

                        <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/likes'}">
                            <span class="menu-ico">â¤ï¸</span>
                            <span class="menu-txt">ì¢‹ì•„ìš” í•œ ê¸€</span>
                        </a>

                        <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/bookmarks'}">
                            <span class="menu-ico">ğŸ“Œ</span>
                            <span class="menu-txt">ë¶ë§ˆí¬</span>
                        </a>

                        <a class="menu-item" th:href="@{'/mypage/' + ${member.id} + '/trade/mine'}">
                            <span class="menu-ico">ğŸ“¦</span>
                            <span class="menu-txt">ì¿ ì¿ ë§ˆì¼“ í™œë™</span>
                        </a>

                        <a class="menu-item" th:href="@{/mypage/{memberId}/stores(memberId=${member.id})}">
                            <span class="menu-ico">ğŸª</span>
                            <span class="menu-txt">ì°œí•œ ë§¤ì¥</span>
                        </a>

                        <a class="menu-item" th:href="@{/mypage/{memberId}/popups(memberId=${member.id})}">
                            <span class="menu-ico">ğŸª</span>
                            <span class="menu-txt">ì°œí•œ íŒì—…ìŠ¤í† ì–´</span>
                        </a>

                        <div class="menu-divider"></div>

                        <a class="menu-item" href="/mypage/service/setting">
                            <span class="menu-ico">âš™</span>
                            <span class="menu-txt">ì„¤ì • & ê³ ê°ì„¼í„°</span>
                        </a>

                        <a class="menu-item danger" href="/mypage/service/logout">
                            <span class="menu-ico">ğŸšª</span>
                            <span class="menu-txt">ë¡œê·¸ì•„ì›ƒ</span>
                        </a>
                    </nav>

                </aside>

                <!-- =========================
                     RIGHT : í”„ë¡œí•„ ì„¤ì •
                     ========================= -->
                <main class="right-col">

                    <section class="panel">
                        <div class="panel-head">
                            <div>
                                <h3 class="panel-title">í”„ë¡œí•„ ì„¤ì •</h3>
                                <p class="panel-sub">ìˆ˜ì • ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë°”ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”</p>
                            </div>

                            <button id="editOpenBtn" class="btn btn-dark" type="button">ìˆ˜ì •</button>
                        </div>

                        <div class="panel-body">

                            <!-- ë³´ê¸° ëª¨ë“œ -->
                            <div id="viewMode">
                                <div class="photo-row view-only">
                                    <div class="photo">
                                        <img
                                                id="profileImageRight"
                                                class="photo-img"
                                                th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                                src="/images/default_profile.png"
                                                alt="í”„ë¡œí•„">
                                    </div>
                                </div>

                                <div class="form-grid">
                                    <div class="form-field">
                                        <label class="label">ë‹‰ë„¤ì„</label>
                                        <div class="readonly" th:text="${member.nickname}">ë‹‰ë„¤ì„</div>
                                    </div>

                                    <div class="form-field">
                                        <label class="label">ì†Œê°œ</label>
                                        <div class="readonly" th:text="${member.intro}">ì†Œê°œ</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ìˆ˜ì • ëª¨ë“œ -->
                            <form id="editMode"
                                  th:action="@{'/mypage/' + ${member.id} + '/profile'}"
                                  method="post"
                                  class="edit-form"
                                  style="display:none;">

                                <div class="edit-photo-row">
                                    <div class="edit-photo-left">
                                        <div class="mini-photo">
                                            <img id="editPreview"
                                                 th:src="${#strings.isEmpty(member.profileImageUrl) ? '/images/default_profile.png' : member.profileImageUrl}"
                                                 src="/images/default_profile.png"
                                                 alt="í”„ë¡œí•„">
                                        </div>
                                        <div class="edit-photo-text">
                                            <div class="edit-photo-title">í”„ë¡œí•„ ì‚¬ì§„</div>
                                            <div class="edit-photo-sub">ì‚¬ì§„ ë³€ê²½ í›„ ì €ì¥í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤</div>
                                        </div>
                                    </div>

                                    <label for="profileImageInput" class="btn btn-ghost">ì‚¬ì§„ ë³€ê²½</label>
                                </div>

                                <div class="edit-grid">
                                    <div class="form-field">
                                        <label class="label">ìƒˆ ë‹‰ë„¤ì„</label>
                                        <input type="text"
                                               name="nickname"
                                               class="input"
                                               th:value="${member.nickname}"
                                               placeholder="ìƒˆ ë‹‰ë„¤ì„"
                                               required>
                                    </div>

                                    <div class="form-field">
                                        <label class="label">ì†Œê°œ</label>
                                        <textarea name="intro"
                                                  class="textarea"
                                                  placeholder="í•œ ì¤„ ì†Œê°œ"
                                                  required
                                                  th:text="${#strings.isEmpty(member.intro) ? 'ì•ˆë…•í•˜ì„¸ìš”, ' + member.nickname + 'ì…ë‹ˆë‹¤.' : member.intro}"></textarea>
                                    </div>
                                </div>

                                <input type="hidden"
                                       id="profileImageHidden"
                                       name="profileImage"
                                       th:value="${member.profileImageUrl}">

                                <div class="edit-actions">
                                    <button type="submit" class="btn btn-dark" id="saveBtn">ì €ì¥</button>
                                    <button type="button" id="editCancelBtn" class="btn btn-ghost">ì·¨ì†Œ</button>
                                </div>

                                <div class="edit-hint" id="uploadState" style="display:none;"></div>
                            </form>

                        </div>
                    </section>

                </main>

            </div>
        </div>
    </div>

    <!-- âœ… bottom-navëŠ” ì—†ì•´ì§€ë§Œ, ì—¬ë°±ì´ í•„ìš”í•˜ë©´ ìœ ì§€ -->
    <div class="bottom-nav-spacer"></div>

</div>

<th:block layout:fragment="script">
    <script>
        const viewMode = document.getElementById("viewMode");
        const editMode = document.getElementById("editMode");
        const editOpenBtn = document.getElementById("editOpenBtn");
        const editCancelBtn = document.getElementById("editCancelBtn");

        editOpenBtn.onclick = () => {
            viewMode.style.display = "none";
            editMode.style.display = "block";
        };

        editCancelBtn.onclick = () => {
            editMode.style.display = "none";
            viewMode.style.display = "block";
        };

        const fileInput = document.getElementById("profileImageInput");

        const leftImg = document.getElementById("profileImage");
        const rightImg = document.getElementById("profileImageRight");
        const editImg = document.getElementById("editPreview");

        const hidden = document.getElementById("profileImageHidden");
        const uploadState = document.getElementById("uploadState");

        const UPLOAD_ENDPOINT = "/api/upload/profile";

        function setState(msg, show = true) {
            uploadState.textContent = msg;
            uploadState.style.display = show ? "block" : "none";
        }

        fileInput?.addEventListener("change", async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            const localUrl = URL.createObjectURL(file);
            if (leftImg) leftImg.src = localUrl;
            if (rightImg) rightImg.src = localUrl;
            if (editImg) editImg.src = localUrl;

            setState("ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...");

            try {
                const fd = new FormData();
                fd.append("file", file);

                const res = await fetch(UPLOAD_ENDPOINT, { method: "POST", body: fd });
                if (!res.ok) throw new Error("upload failed: " + res.status);

                const data = await res.json();
                if (!data?.url) throw new Error("no url in response");

                hidden.value = data.url;
                setState("ì—…ë¡œë“œ ì™„ë£Œ! ì €ì¥ì„ ëˆ„ë¥´ë©´ ë°˜ì˜ë©ë‹ˆë‹¤ âœ…");
            } catch (err) {
                console.error(err);
                setState("ì—…ë¡œë“œ ì‹¤íŒ¨ ğŸ˜­ (ì—…ë¡œë“œ API/ê¶Œí•œ/ì‘ë‹µí˜•ì‹ í™•ì¸ í•„ìš”)");
            }
        });
    </script>
</th:block>

</body>
</html>