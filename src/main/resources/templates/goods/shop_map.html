<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>ë”ì¿ ì¿  | ë§¤ì¥ ì§€ë„</title>

    <!-- Naver Maps SDK (geocoder í¬í•¨) -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        window.navermap_authFailure = () =>
            alert('ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨: NCP ì½˜ì†” URL/Key í™•ì¸');
    </script>

    <!-- Bootstrap (ì§€ê¸ˆì€ ìŠ¤íƒ€ì¼ë§Œ ì“¸ ìˆ˜ ìˆê²Œ ê·¸ëŒ€ë¡œ ë‘ ) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            defer></script>

    <style>
        :root{--brand:#704538;--accent:#F79287;--ink:#222;--line:#e9e9e9}
        html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Malgun Gothic",sans-serif}
        #mapWrap{position:relative;width:100%;height:540px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fafafa}
        #map{width:100%;height:100%}
        /* ë¸Œë¼ìš°ì € ì „ì²´í™”ë©´ì¼ ë•Œ */
        #mapWrap.fs{position:fixed;inset:0;width:100vw;height:100vh;z-index:1040;border-radius:0}

        .vbar{display:flex;flex-direction:column;gap:8px}
        .ctrl{display:flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:10px;background:#fff;border:1px solid var(--line);box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer;user-select:none}
        .ctrl.on{outline:2px solid var(--accent)}

        .panel{position:absolute;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);
            border-radius:10px;padding:8px 10px;font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
        .toast{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);background:#222;color:#fff;
            padding:8px 12px;border-radius:8px;font-size:13px;display:none}

        /* ===== ì§€ë„ ì•ˆ ê²€ìƒ‰ë°” & ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ===== */
        .map-search-wrap{
            position:absolute;
            top:20px;
            left:50%;
            transform:translateX(-50%);
            width:70%;
            max-width:560px;
            z-index:20;
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        .map-search-row{
            display:flex;
            align-items:center;
            background:#fff;
            border-radius:999px;
            padding:4px 6px;
            box-shadow:0 4px 12px rgba(0,0,0,.12);
            border:1px solid var(--line);
        }
        .map-search-input{
            flex:1;
            border:none;
            outline:none;
            font-size:14px;
            padding:8px 12px;
            background:transparent;
        }
        .map-search-btn{
            border:none;
            outline:none;
            padding:8px 18px;
            border-radius:999px;
            background:var(--accent);
            color:#fff;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
        }

        .map-result-panel{
            display:none;
            background:#fff;
            border-radius:14px;
            box-shadow:0 10px 24px rgba(0,0,0,.18);
            border:1px solid var(--line);
            max-height:230px;
            overflow-y:auto;
            padding:6px 0;
        }
        .map-result-header{
            font-size:12px;
            font-weight:600;
            color:#666;
            padding:4px 14px 6px;
            border-bottom:1px solid #f2f2f2;
        }
        .map-result-item{
            width:100%;
            text-align:left;
            background:transparent;
            border:none;
            padding:8px 14px;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            gap:2px;
        }
        .map-result-item:hover{background:#fdf4f2}
        .map-result-title{
            font-size:13px;
            font-weight:600;
            color:var(--ink);
            display:flex;
            align-items:center;
            gap:6px;
        }
        .map-result-badge{
            font-size:10px;
            padding:2px 6px;
            border-radius:999px;
            border:1px solid var(--line);
            background:#fafafa;
        }
        .map-result-meta{
            font-size:12px;
            color:#777;
        }
    </style>
</head>
<body>
<section id="mapWrap">
    <div id="map"></div>

    <!-- ì˜¤ë¥¸ìª½ ë„êµ¬ëª¨ìŒ (ìë™ì°¨ ê²½ë¡œ/ê¸¸ì°¾ê¸° íŒ¨ë„ ê´€ë ¨ ë²„íŠ¼ ì œê±°ë¨) -->
    <div class="vbar" style="position:absolute;right:12px;top:50%;transform:translateY(-50%)">
        <div id="btnZoomIn"  class="ctrl" title="í™•ëŒ€">+</div>
        <div id="btnZoomOut" class="ctrl" title="ì¶•ì†Œ">âˆ’</div>
        <div id="btnMyLoc"   class="ctrl" title="ë‚´ ìœ„ì¹˜">â—</div>
        <div id="btnWp"      class="ctrl" title="ê²½ìœ ì§€ ëª¨ë“œ">W</div>
        <div id="btnWpClr"   class="ctrl" title="ê²½ìœ ì§€ ì´ˆê¸°í™”">C</div>
        <div id="btnFullscreen" class="ctrl" title="ì „ì²´í™”ë©´">â›¶</div>
    </div>

    <!-- ì§€ë„ ì•ˆ ê²€ìƒ‰ UI -->
    <div class="map-search-wrap">
        <div class="map-search-row">
            <input id="mapSearchInput" class="map-search-input"
                   placeholder="ë§¤ì¥ëª…, ì§€ì—­, ì‘í’ˆëª… ê²€ìƒ‰"/>
            <button id="mapSearchBtn" class="map-search-btn">ê²€ìƒ‰</button>
        </div>
        <div id="mapSearchResults" class="map-result-panel"></div>
    </div>

    <div id="summary" class="panel">ë„ì°©ì§€ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§€ë„ë¥¼ í´ë¦­í•´ ì§€ì •í•˜ì„¸ìš”.</div>
    <div id="toast" class="toast"></div>
</section>

<script>
    const $ = sel => document.querySelector(sel);
    const IS_MOBILE = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const llToParam = ll => `${ll.lng()},${ll.lat()}`;

    function toast(m){
        const t = $('#toast');
        t.textContent = m;
        t.style.display='block';
        clearTimeout(t._t);
        t._t = setTimeout(()=> t.style.display='none',1600);
    }

    let map, infoWin, startMarker, endMarker, userMarker, routeLine;
    let waypointMarkers = [], waypointMode = false;

    // ê²€ìƒ‰ ê´€ë ¨ ìƒíƒœ
    let searchMarkers = [];
    let lastPlaces = [];
    window.searchPlaces = [];

    function boot(){
        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665,126.9780),
            zoom: 14,
            zoomControl: false
        });

        infoWin = new naver.maps.InfoWindow({anchorSize:new naver.maps.Size(8,8)});

        naver.maps.Event.addListener(map,'click',e=>{
            waypointMode ? addWaypoint(e.coord) : setEndFromClick(e.coord);
        });

        $('#btnZoomIn').onclick = ()=> map.setZoom(map.getZoom()+1);
        $('#btnZoomOut').onclick = ()=> map.setZoom(map.getZoom()-1);
        $('#btnMyLoc').onclick = locateMeOnce;
        $('#btnWp').onclick = ()=>{
            waypointMode = !waypointMode;
            $('#btnWp').classList.toggle('on', waypointMode);
            toast(waypointMode ? 'ê²½ìœ ì§€ ëª¨ë“œ ON' : 'ê²½ìœ ì§€ ëª¨ë“œ OFF');
        };
        $('#btnWpClr').onclick = clearWaypoints;
        $('#btnFullscreen').onclick = toggleFullscreen;

        // ì§€ë„ ì•ˆ ê²€ìƒ‰ì°½
        const si = $('#mapSearchInput');
        const sb = $('#mapSearchBtn');
        if(si && sb){
            const run = () => {
                const q = si.value.trim();
                if(!q) return toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                // âœ… ê¸°ë³¸ì€ ì¥ì†Œ ê²€ìƒ‰
                searchPlacesOnMap(q);
            };
            sb.onclick = run;
            si.addEventListener('keydown',e=>{
                if(e.key === 'Enter') run();
            });
        }

        // í—¤ë” ê²€ìƒ‰ì°½ê³¼ ì—°ë™ (ìˆìœ¼ë©´)
        const hq = document.getElementById('q');
        const hb = document.getElementById('btnSearch');
        if(hq && hb){
            const runHeader = () => {
                const q = hq.value.trim();
                if(!q) return toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                if(si) si.value = q;
                searchPlacesOnMap(q);
            };
            hb.addEventListener('click', runHeader);
            hq.addEventListener('keydown', e => {
                if(e.key === 'Enter') runHeader();
            });
        }

        document.addEventListener('fullscreenchange', onFullscreenChange);

        toast('ì§€ë„ ì¤€ë¹„ ì™„ë£Œ');
    }

    // ===== ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ (ê¸¸ì°¾ê¸° íŒ¨ë„ ì—†ì´, ê·¸ëƒ¥ ì§€ë„ë§Œ í™•ëŒ€) =====
    function onFullscreenChange(){
        const wrap = $('#mapWrap');
        const fs = (document.fullscreenElement === wrap);
        wrap.classList.toggle('fs', fs);
        $('#btnFullscreen').classList.toggle('on', fs);

        syncResultPanelForFullscreen();

        if(map){
            try{
                naver.maps.Event.trigger(map, 'resize');
            }catch(e){
                console.warn('map resize ì‹¤íŒ¨', e);
            }
        }
    }

    // ===== ë§ˆì»¤/ì§€ì˜¤ì½”ë”© =====
    function setStart(ll,label='ì¶œë°œ'){
        if(!startMarker) startMarker = new naver.maps.Marker({map,position:ll,title:label});
        else startMarker.setPosition(ll);
        map.setCenter(ll);
    }

    function setEnd(ll,label='ë„ì°©'){
        if(!endMarker) endMarker = new naver.maps.Marker({map,position:ll,title:label});
        else endMarker.setPosition(ll);
        infoWin.setContent(`<div style="padding:6px 8px;font-size:13px">${label}</div>`);
        infoWin.open(map,endMarker);
        map.setCenter(ll);
        $('#summary').textContent = `ë„ì°©ì§€: ${label}`;
    }

    function setEndFromClick(ll){
        naver.maps.Service.reverseGeocode({
            coords:ll,
            orders:[naver.maps.Service.OrderType.ROAD_ADDR,
                naver.maps.Service.OrderType.ADDR].join(',')
        }, (st,resp)=>{
            let label='ëª©ì ì§€';
            if(st===naver.maps.Service.Status.OK && resp?.v2?.results?.length){
                const r = resp.v2.results[0];
                label = r.roadaddress?.address || r.land?.name || label;
            }
            setEnd(ll,label);
        });
    }

    // ===== ìœ„ì¹˜/ê²½ìœ ì§€ =====
    function locateMeOnce(){
        if(!('geolocation' in navigator)) return toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        navigator.geolocation.getCurrentPosition(p=>{
            const ll = new naver.maps.LatLng(p.coords.latitude,p.coords.longitude);
            if(!userMarker){
                userMarker = new naver.maps.Marker({
                    map, position:ll, title:'ë‚´ ìœ„ì¹˜',
                    icon:{content:'<div style="width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 0 0 2px rgba(30,136,229,.35)"></div>'}
                });
            }else userMarker.setPosition(ll);
            setStart(ll,'í˜„ì¬ ìœ„ì¹˜');
        },()=>toast('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'),{enableHighAccuracy:true,timeout:15000});
    }

    function addWaypoint(ll){
        if(waypointMarkers.length>=15) return toast('ê²½ìœ ì§€ëŠ” ìµœëŒ€ 15ê°œ');
        const idx = waypointMarkers.length+1;
        waypointMarkers.push(new naver.maps.Marker({
            map,position:ll,title:`ê²½ìœ ì§€ ${idx}`,
            icon:{content:`<div style="width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;font:600 12px/1 system-ui">${idx}</div>`}
        }));
    }
    function clearWaypoints(){
        waypointMarkers.forEach(m=>m.setMap(null));
        waypointMarkers = [];
    }

    // ===== ì „ì²´í™”ë©´ í† ê¸€ =====
    async function toggleFullscreen(){
        const wrap = $('#mapWrap');
        if(!document.fullscreenElement){
            try{
                await wrap.requestFullscreen();
            }catch(e){
                console.error(e);
                toast('ì „ì²´í™”ë©´ì„ ì§€ì›í•˜ì§€ ì•Šê±°ë‚˜, ì°¨ë‹¨ëœ ìƒíƒœì…ë‹ˆë‹¤.');
            }
        }else{
            document.exitFullscreen();
        }
    }

    // ===== ê²€ìƒ‰ (DB + ë„¤ì´ë²„ í†µí•©) =====
    function clearSearchMarkers(){
        searchMarkers.forEach(m=>m.setMap(null));
        searchMarkers = [];
    }

    function getField(obj, ...candidates) {
        for (const name of candidates) {
            if (obj[name] != null) return obj[name];
            const lower = name.toLowerCase();
            for (const k in obj) {
                if (k.toLowerCase() === lower && obj[k] != null) {
                    return obj[k];
                }
            }
        }
        return null;
    }

    function placeToLatLng(p){
        if (!p) return null;

        const toNum = (v) => {
            if (v === null || v === undefined || v === '') return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
        };

        let lat = toNum(getField(p, 'lat','latitude','y','mapy','mapY'));
        let lng = toNum(getField(p, 'lng','lon','longitude','x','mapx','mapX'));

        if (lat == null || lng == null) {
            console.warn('placeToLatLng: ì¢Œí‘œ ëª» ì°¾ìŒ', p);
            return null;
        }

        if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
            const tm = new naver.maps.Point(lng, lat);
            const ll = naver.maps.TransCoord.fromTM128ToLatLng(tm);
            return ll;
        }

        return new naver.maps.LatLng(lat, lng);
    }

    function focusPlace(p){
        const apply = (ll) => {
            if (!ll) {
                toast('ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            map.panTo(ll);
            if (endMarker) endMarker.setMap(null);
            endMarker = new naver.maps.Marker({
                map,
                position: ll,
                title: p.name
            });

            const goodsLine = (p.goodsName)
                ? `<div style="font-size:12px;color:#444;margin-top:4px">ğŸ“¦ ${p.goodsName}${(p.stockQty!=null?` (ì¬ê³  ${p.stockQty})`:``)}</div>`
                : '';

            infoWin.setContent(
                `<div style="padding:6px 8px;font-size:13px">
                   <div style="font-weight:600;margin-bottom:4px">${p.name || ''}</div>
                   <div style="font-size:12px;color:#666">${p.roadAddress || p.address || ''}</div>
                   ${goodsLine}
                 </div>`
            );
            infoWin.open(map, endMarker);
        };

        let ll = placeToLatLng(p);
        if (ll) {
            apply(ll);
            return;
        }

        const q = p.roadAddress || p.address || p.name;
        if (!q) {
            toast('ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        naver.maps.Service.geocode({ query: q }, (st, r) => {
            if (st !== naver.maps.Service.Status.OK || !r?.v2?.addresses?.length) {
                console.warn('geocode ì‹¤íŒ¨', q, r);
                toast('ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const a = r.v2.addresses[0];
            const ll2 = new naver.maps.LatLng(+a.y, +a.x);
            apply(ll2);
        });
    }

    // âœ… ê¸°ì¡´: ì¥ì†Œ ê²€ìƒ‰ (ë§¤ì¥/ë„¤ì´ë²„)
    async function searchPlacesOnMap(query){
        try{
            const res = await fetch(`/api/map/places?query=${encodeURIComponent(query)}&limit=20`);
            if(!res.ok) return toast('ê²€ìƒ‰ ì‹¤íŒ¨');
            const list = await res.json();
            const places = Array.isArray(list)?list:[];
            renderPlaceResults(places);
            try{
                window.searchPlaces = places;
                if(window.parent && window.parent !== window){
                    window.parent.postMessage(
                        { type: 'MAP_SEARCH_RESULTS', places },
                        window.location.origin
                    );
                }
            }catch(e){
                console.warn('postMessage ì‹¤íŒ¨', e);
            }
        }catch(e){
            console.error(e);
            toast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜');
        }
    }

    // âœ…âœ… ì¶”ê°€: ì¬ê³  ê²€ìƒ‰ (store_goods ê¸°ë°˜)
    async function searchGoodsOnMap(place, goods){
        const kw = (goods || '').trim();
        if(!kw) return [];

        const res = await fetch(`/goods/search-map?kw=${encodeURIComponent(kw)}&page=0&size=50`);
        if(!res.ok) throw new Error('ì¬ê³ ê²€ìƒ‰ ì‹¤íŒ¨');

        const page = await res.json();
        const rows = Array.isArray(page?.content) ? page.content : [];

        // place(ì§€ì—­) ê°™ì´ ë“¤ì–´ì˜¤ë©´ í”„ë¡ íŠ¸ì—ì„œ 1ì°¨ í•„í„° (ì£¼ì†Œ/ë§¤ì¥ëª…ì— í¬í•¨)
        const pkw = (place || '').trim();
        const filtered = pkw
            ? rows.filter(r => {
                const addr = (r.storeAddress || '').toLowerCase();
                const name = (r.storeName || '').toLowerCase();
                const pk = pkw.toLowerCase();
                return addr.includes(pk) || name.includes(pk);
            })
            : rows;

        // renderPlaceResultsê°€ ê¸°ëŒ€í•˜ëŠ” í˜•íƒœë¡œ ë³€í™˜
        // source: GOODS ë¡œ ë„£ì–´ì„œ ë±ƒì§€ í‘œì‹œ
        const places = filtered.map(r => ({
            source: 'GOODS',
            name: r.storeName,
            roadAddress: r.storeAddress,
            address: r.storeAddress,
            lat: r.latitude,
            lng: r.longitude,
            storeId: r.storeId,

            goodsName: r.goodsName,
            stockQty: r.stockQty,
            price: r.price,
            thumbnailUrl: r.thumbnailUrl
        }));

        return places;
    }

    function renderPlaceResults(places){
        lastPlaces = places;
        window.searchPlaces = places;

        const panel = $('#mapSearchResults');
        panel.innerHTML = '';

        clearSearchMarkers();

        if(!places.length){
            panel.style.display='none';
            toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
            return;
        }

        const header = document.createElement('div');
        header.className='map-result-header';
        header.textContent='ê²€ìƒ‰ ê²°ê³¼';
        panel.appendChild(header);

        let bounds = null;

        places.forEach((p)=>{
            const ll = placeToLatLng(p);
            if(ll){
                const marker = new naver.maps.Marker({
                    map,
                    position:ll,
                    title:p.name || p.title || '',
                    icon:{
                        content:`<div style="width:22px;height:22px;border-radius:50%;background:#F79287;border:2px solid #fff;box-shadow:0 0 0 2px rgba(247,146,135,.5)"></div>`
                    }
                });
                searchMarkers.push(marker);
                naver.maps.Event.addListener(marker,'click',()=>focusPlace(p));

                if(!bounds) bounds = new naver.maps.LatLngBounds(ll, ll);
                else bounds.extend(ll);
            }

            const badgeText = (p.source === 'STORE') ? 'êµ¿ì¦ˆìƒµ(ë”ì¿ ì¿ )'
                : (p.source === 'GOODS') ? 'ì¬ê³ '
                    : 'ë„¤ì´ë²„';

            const goodsMeta = (p.goodsName)
                ? ` Â· ğŸ“¦ ${p.goodsName}${(p.stockQty!=null?` (ì¬ê³  ${p.stockQty})`:``)}`
                : '';

            const btn = document.createElement('button');
            btn.type='button';
            btn.className='map-result-item';
            btn.innerHTML = `
              <div class="map-result-title">
                <span>${p.name || 'ì´ë¦„ ì—†ìŒ'}</span>
                <span class="map-result-badge">${badgeText}</span>
              </div>
              <div class="map-result-meta">${(p.roadAddress || p.address || '')}${goodsMeta}</div>
            `;
            btn.addEventListener('click',()=>focusPlace(p));
            panel.appendChild(btn);
        });

        if(bounds){
            map.fitBounds(bounds);
        }

        syncResultPanelForFullscreen();
    }

    function syncResultPanelForFullscreen(){
        const panel = $('#mapSearchResults');
        if(!panel) return;
        const isFs = (document.fullscreenElement === $('#mapWrap'));
        if(isFs && lastPlaces && lastPlaces.length){
            panel.style.display = 'block';
        }else{
            panel.style.display = 'none';
        }
    }

    function resetAll(){
        if(routeLine){routeLine.setMap(null);routeLine=null}
        [startMarker,endMarker,userMarker].forEach(m=>m && m.setMap(null));
        startMarker=endMarker=userMarker=null;
        clearWaypoints();
        clearSearchMarkers();
        $('#summary').textContent='ë„ì°©ì§€ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§€ë„ë¥¼ í´ë¦­í•´ ì§€ì •í•˜ì„¸ìš”.';
        lastPlaces = [];
        syncResultPanelForFullscreen();
        toast('ì´ˆê¸°í™” ì™„ë£Œ');
    }

    // ë¶€ëª¨(index.html)ì—ì„œ "ì´ idxë¡œ í¬ì»¤ìŠ¤í•´!" ë©”ì‹œì§€
    window.addEventListener('message', (event)=>{
        if(event.origin !== window.location.origin) return;
        const data = event.data;
        if(!data || data.type !== 'MAP_FOCUS_PLACE') return;
        const idx = data.idx;
        if(typeof idx !== 'number') return;
        if(!window.searchPlaces || !window.searchPlaces[idx]) return;
        const place = window.searchPlaces[idx];
        focusPlace(place);
    });

    // âœ…âœ… í•µì‹¬: ë¶€ëª¨(index.html)ì—ì„œ ê²€ìƒ‰/í˜„ì¬ìœ„ì¹˜ ëª…ë ¹ ë°›ê¸°
    window.addEventListener('message', async (event) => {
        if (event.origin !== window.location.origin) return;
        const data = event.data;
        if (!data || !data.type) return;

        // index.html ê²€ìƒ‰ì°½ â†’ ì§€ë„ ê²€ìƒ‰
        if (data.type === 'MAP_SEARCH') {
            const place = (data.place || '').trim();
            const goods = (data.goods || '').trim();

            // âœ… goodsê°€ ìˆìœ¼ë©´ ì¬ê³ ê²€ìƒ‰ APIë¥¼ ë¨¼ì € íƒ„ë‹¤
            if (goods) {
                try {
                    const goodsPlaces = await searchGoodsOnMap(place, goods);
                    renderPlaceResults(goodsPlaces);

                    // ë¶€ëª¨ì—ê²Œë„ ë™ì¼ í¬ë§·ìœ¼ë¡œ ì „ë‹¬
                    try{
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage(
                                { type: 'MAP_SEARCH_RESULTS', places: goodsPlaces },
                                window.location.origin
                            );
                        }
                    }catch(e){}
                } catch (e) {
                    console.error(e);
                    toast('ì¬ê³  ê²€ìƒ‰ ì‹¤íŒ¨');
                }
                return;
            }

            // âœ… goods ì—†ìœ¼ë©´ ê¸°ì¡´ ì¥ì†Œê²€ìƒ‰
            const query = (place).trim();
            if (!query) {
                window.searchPlaces = [];
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(
                            { type: 'MAP_SEARCH_RESULTS', places: [] },
                            window.location.origin
                        );
                    }
                } catch (e) {}
                return;
            }
            await searchPlacesOnMap(query);
            return;
        }

        // "í˜„ì¬ ìœ„ì¹˜" ë²„íŠ¼
        if (data.type === 'MAP_MY_POSITION') {
            locateMeOnce();
            return;
        }
    });

    (function wait(){
        if(window.naver?.maps?.Map) boot();
        else setTimeout(wait,60);
    })();
</script>

</body>
</html>