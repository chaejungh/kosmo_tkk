<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ë”ì¿ ì¿  | ë§¤ì¥ ì§€ë„</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Naver Maps SDK -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        window.navermap_authFailure = function () {
            alert('ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨: Web ì„œë¹„ìŠ¤ URL / Client IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };
    </script>

    <style>
        :root{ --brand:#704538; --accent:#F79287; --line:#e9e9e9; }
        html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Malgun Gothic",sans-serif}
        #mapWrap{position:relative;width:100%;height:560px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fafafa}
        #map{width:100%;height:100%}

        /* fullscreen fallback */
        #mapWrap.fs{ position:fixed; inset:0; width:100vw; height:100vh; z-index:1050; border-radius:0 }
        body.no-scroll{ overflow:hidden }

        /* right rail controls */
        .vbar{display:flex;flex-direction:column;gap:8px}
        .ctrl{
            display:flex;align-items:center;justify-content:center; width:38px;height:38px;
            border-radius:10px;background:#fff;border:1px solid var(--line);
            box-shadow:0 2px 8px rgba(0,0,0,.08); cursor:pointer; user-select:none;
        }
        .ctrl.on{ outline:2px solid var(--accent) }
        .ctrl span{ font-size:12px }

        .panel{position:absolute;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);
            border-radius:10px;padding:8px 10px;font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
        .toastz{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);
            background:#222;color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;display:none}

        /* offcanvas width */
        .offcanvas-start{ width:360px }
        .nav-mode .nav-link{border-radius:10px}
        .nav-mode .nav-link.active{ background:var(--brand) }
    </style>
</head>
<body>

<section id="mapWrap">
    <div id="map"></div>

    <!-- ì˜¤ë¥¸ìª½ ì„¸ë¡œ íˆ´ë°” -->
    <div class="vbar" style="position:absolute; right:12px; top:50%; transform:translateY(-50%);">
        <div id="btnZoomIn"  class="ctrl" title="í™•ëŒ€">+</div>
        <div id="btnZoomOut" class="ctrl" title="ì¶•ì†Œ">âˆ’</div>

        <!-- ì „ì²´ë³´ê¸° / ëŒ€ì¤‘êµí†µ / ë„ë³´ (ìš”ì²­ëŒ€ë¡œ ìœ ì§€) -->
        <div id="btnFit"     class="ctrl" title="ì „ì²´í™”ë©´ í† ê¸€"><span>â–¡</span></div>
        <div id="btnTransit" class="ctrl" title="ëŒ€ì¤‘êµí†µ ê¸¸ì°¾ê¸°">ğŸš‡</div>
        <div id="btnWalk"    class="ctrl" title="ë„ë³´ ê¸¸ì°¾ê¸°">ğŸš¶</div>

        <!-- ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ ìœ ì§€ -->
        <div id="btnMyLoc"   class="ctrl" title="ë‚´ ìœ„ì¹˜">â—</div>
        <div id="btnWp"      class="ctrl" title="ê²½ìœ ì§€ ëª¨ë“œ">W</div>
        <div id="btnWpClr"   class="ctrl" title="ê²½ìœ ì§€ ì´ˆê¸°í™”">C</div>

        <!-- ê¸¸ì°¾ê¸° íŒ¨ë„ ì—´ê¸° -->
        <div id="btnRoutePanel" class="ctrl" title="ê¸¸ì°¾ê¸° íŒ¨ë„">â†’</div>
    </div>

    <!-- í•˜ë‹¨ ìš”ì•½/í† ìŠ¤íŠ¸ -->
    <div id="summary" class="panel">ê²½ë¡œ ë¯¸ì„¤ì •</div>
    <div id="toast" class="toastz"></div>
</section>

<!-- ===== ê¸¸ì°¾ê¸° Offcanvas (ë„¤ì´ë²„ ëŠë‚Œ) ===== -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="dirPanel" aria-labelledby="dirPanelLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="dirPanelLabel">ê¸¸ì°¾ê¸°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="ë‹«ê¸°"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column gap-3">

        <!-- ëª¨ë“œ íƒ­ -->
        <ul class="nav nav-pills nav-mode gap-2">
            <li class="nav-item"><button class="nav-link active" data-mode="car"   id="tabCar">ìë™ì°¨</button></li>
            <li class="nav-item"><button class="nav-link"        data-mode="transit" id="tabTransit">ëŒ€ì¤‘êµí†µ</button></li>
            <li class="nav-item"><button class="nav-link"        data-mode="walk"  id="tabWalk">ë„ë³´</button></li>
            <li class="nav-item"><button class="nav-link"        data-mode="bike"  id="tabBike">ìì „ê±°</button></li>
        </ul>

        <!-- ì…ë ¥ í¼ -->
        <div class="d-grid gap-2">
            <div class="input-group">
                <span class="input-group-text">ì¶œë°œ</span>
                <input id="inpStart" type="text" class="form-control" placeholder="ì¶œë°œì§€(ë¯¸ì…ë ¥ì‹œ í˜„ì¬ ìœ„ì¹˜/ì§€ë„ì¤‘ì‹¬)">
                <button id="btnUseMyLoc" class="btn btn-outline-secondary" type="button">í˜„ìœ„ì¹˜</button>
            </div>
            <div class="input-group">
                <span class="input-group-text">ë„ì°©</span>
                <input id="inpEnd" type="text" class="form-control" placeholder="ë„ì°©ì§€(ì£¼ì†Œ/ì¥ì†Œ)">
                <button id="btnUsePinnedEnd" class="btn btn-outline-secondary" type="button">í•€</button>
            </div>
            <div class="d-flex gap-2">
                <button id="btnDirReset" class="btn btn-outline-secondary flex-grow-1" type="button">ë‹¤ì‹œì…ë ¥</button>
                <button id="btnDirGo"    class="btn btn-primary flex-grow-1" style="background:#704538;border-color:#704538" type="button">ê¸¸ì°¾ê¸°</button>
            </div>
        </div>

        <!-- ì•ˆë‚´ -->
        <div class="small text-muted">
            â€» <b>ìë™ì°¨</b>ëŠ” ë‚´ë¶€ ê²½ë¡œì„ ì´ ì§€ë„ì— ì§ì ‘ ê·¸ë ¤ì§‘ë‹ˆë‹¤.<br>
            â€» <b>ëŒ€ì¤‘êµí†µ/ë„ë³´/ìì „ê±°</b>ëŠ” ë„¤ì´ë²„ ê¸¸ì°¾ê¸° í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤(ì¢Œí‘œ ìë™ ì „ë‹¬).
        </div>

        <!-- (ìë™ì°¨ ëª¨ë“œì¼ ë•Œ) ìš”ì•½ ë°•ìŠ¤ -->
        <div id="carSummaryBox" class="alert alert-light border d-none mb-0">
            <div class="fw-semibold mb-1">ìë™ì°¨ ê²½ë¡œ ìš”ì•½</div>
            <div id="carSummaryText">-</div>
        </div>
    </div>
</div>

<script>
    // ------------- ê³µí†µ ìœ í‹¸ -------------
    const $=(s,root=document)=>root.querySelector(s);
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',1600); }
    const llToParam = ll => `${ll.lng()},${ll.lat()}`;

    // ------------- ì§€ë„ ìƒíƒœ -------------
    let map, infoWin, startMarker, endMarker, userMarker, routeLine;
    let waypointMarkers=[], waypointMode=false;

    // ------------- ì§€ë„ ë¶€íŒ… -------------
    function boot(){
        map = new naver.maps.Map('map', {
            center:new naver.maps.LatLng(37.5665,126.9780),
            zoom:14, zoomControl:false, mapTypeControl:false
        });
        infoWin = new naver.maps.InfoWindow({anchorSize:new naver.maps.Size(8,8)});

        naver.maps.Event.addListener(map,'click',e=>{
            if(waypointMode) addWaypoint(e.coord); else setEndFromClick(e.coord);
        });

        // controls
        $('#btnZoomIn').onclick  = ()=>map.setZoom(map.getZoom()+1);
        $('#btnZoomOut').onclick = ()=>map.setZoom(map.getZoom()-1);

        // ì „ì²´í™”ë©´ í† ê¸€
        const wrap=document.getElementById('mapWrap');
        function isFs(){ return !!(document.fullscreenElement || document.webkitFullscreenElement) || wrap.classList.contains('fs'); }
        async function enterFs(){ try{ if(wrap.requestFullscreen) await wrap.requestFullscreen(); else if(wrap.webkitRequestFullscreen) wrap.webkitRequestFullscreen(); else { wrap.classList.add('fs'); document.body.classList.add('no-scroll'); } } finally { setTimeout(()=>naver.maps.Event.trigger(map,'resize'),100); } }
        function exitFs(){ try{ if(document.exitFullscreen) document.exitFullscreen(); else if(document.webkitExitFullscreen) document.webkitExitFullscreen(); wrap.classList.remove('fs'); document.body.classList.remove('no-scroll'); } finally { setTimeout(()=>naver.maps.Event.trigger(map,'resize'),100); } }
        $('#btnFit').onclick = ()=> isFs()? exitFs() : enterFs();
        document.addEventListener('fullscreenchange', ()=>setTimeout(()=>naver.maps.Event.trigger(map,'resize'),60));

        // ì™¸ë¶€(ë°”ë¡œ ì—´ê¸°) ë²„íŠ¼
        $('#btnTransit').onclick = ()=> openNaverDirections('transit');
        $('#btnWalk').onclick    = ()=> openNaverDirections('walk');

        // ë‚˜ë¨¸ì§€ ìœ ì§€
        $('#btnMyLoc').onclick = locateMeOnce;
        $('#btnWp').onclick = ()=>{ waypointMode=!waypointMode; $('#btnWp').classList.toggle('on',waypointMode); toast(waypointMode?'ê²½ìœ ì§€ ëª¨ë“œ ON (ì§€ë„ í´ë¦­)':'ê²½ìœ ì§€ ëª¨ë“œ OFF'); };
        $('#btnWpClr').onclick = clearWaypoints;

        // ê¸¸ì°¾ê¸° íŒ¨ë„ ì—´ê¸°
        const off = new bootstrap.Offcanvas('#dirPanel');
        $('#btnRoutePanel').onclick = ()=> off.show();

        // íŒ¨ë„ ë‚´ë¶€ ì´ë²¤íŠ¸
        setupDirectionsUI(off);
    }

    // ------------- Geocoding -------------
    function geocode(text, cb){
        if(!text) return cb(null,null);
        naver.maps.Service.geocode({query:text},(st,resp)=>{
            if(st!==naver.maps.Service.Status.OK || !resp?.v2?.addresses?.length) return cb(null,null);
            const a=resp.v2.addresses[0];
            cb(new naver.maps.LatLng(parseFloat(a.y),parseFloat(a.x)), a.roadAddress||a.jibunAddress||text);
        });
    }
    function setEndFromClick(latlng){
        naver.maps.Service.reverseGeocode({
            coords:latlng, orders:[naver.maps.Service.OrderType.ROAD_ADDR,naver.maps.Service.OrderType.ADDR].join(',')
        },(st,resp)=>{
            let label='ëª©ì ì§€';
            if(st===naver.maps.Service.Status.OK && resp?.v2?.results?.length){
                const r=resp.v2.results[0]; label=r.roadaddress?.address || r.land?.name || label;
            }
            setEnd(latlng,label);
        });
    }

    // ------------- ë§ˆì»¤ -------------
    function setStart(latlng,label='ì¶œë°œ'){
        if(!startMarker) startMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else startMarker.setPosition(latlng);
        map.setCenter(latlng);
    }
    function setEnd(latlng,label='ë„ì°©'){
        if(!endMarker) endMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else endMarker.setPosition(latlng);
        infoWin.setContent(`<div style="padding:6px 8px;font-size:13px">${label}</div>`);
        infoWin.open(map,endMarker); map.setCenter(latlng);
    }

    // ------------- í˜„ì¬ ìœ„ì¹˜ -------------
    function locateMeOnce(){
        if(!('geolocation' in navigator)) return toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        navigator.geolocation.getCurrentPosition(pos=>{
            const ll=new naver.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
            if(!userMarker){
                userMarker=new naver.maps.Marker({
                    map,position:ll,title:'ë‚´ ìœ„ì¹˜',
                    icon:{content:'<div style="width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 0 0 2px rgba(30,136,229,.35)"></div>'}
                });
            }else userMarker.setPosition(ll);
            setStart(ll,'í˜„ì¬ ìœ„ì¹˜');
        },()=>toast('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'),{enableHighAccuracy:true,timeout:15000});
    }

    // ------------- ê²½ìœ ì§€ -------------
    function addWaypoint(latlng){
        if(waypointMarkers.length>=15) return toast('ê²½ìœ ì§€ëŠ” ìµœëŒ€ 15ê°œ');
        const idx=waypointMarkers.length+1;
        waypointMarkers.push(
            new naver.maps.Marker({
                map, position:latlng, title:`ê²½ìœ ì§€ ${idx}`,
                icon:{content:`<div style="width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;font:600 12px/1 system-ui">${idx}</div>`}
            })
        );
        toast(`ê²½ìœ ì§€ ${idx} ì¶”ê°€`);
    }
    function clearWaypoints(){ waypointMarkers.forEach(m=>m.setMap(null)); waypointMarkers=[]; toast('ê²½ìœ ì§€ ì´ˆê¸°í™”'); }
    const waypointsParam = () => waypointMarkers.length ? waypointMarkers.map(m=>`${m.getPosition().lng()},${m.getPosition().lat()}`).join('|') : '';

    // ------------- ìë™ì°¨ ê²½ë¡œ (ë‚´ë¶€ API) -------------
    async function drawRouteCarWithLL(sLL, gLL){
        const start=encodeURIComponent(`${sLL.lng()},${sLL.lat()}`);
        const goal =encodeURIComponent(`${gLL.lng()},${gLL.lat()}`);
        const wp   =waypointsParam();

        const url=`/api/directions?start=${start}&goal=${goal}&option=traoptimal${wp?`&waypoints=${encodeURIComponent(wp)}`:''}`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data=await res.json();
        const route=data?.route?.traoptimal?.[0];
        if(!route?.path?.length) throw new Error('ê²½ë¡œ ì—†ìŒ');

        const path=route.path.map(([x,y])=>new naver.maps.LatLng(y,x));
        if(routeLine) routeLine.setMap(null);
        routeLine=new naver.maps.Polyline({map,path,strokeWeight:6,strokeOpacity:.9,strokeColor:'#F79287'});

        const b=new naver.maps.LatLngBounds(path[0],path[0]); path.forEach(p=>b.extend(p)); map.fitBounds(b);
        const km=(route.summary.distance/1000).toFixed(1), min=Math.round(route.summary.duration/60000);
        $('#summary').textContent=`ìë™ì°¨ ê²½ë¡œ Â· ì•½ ${km}km Â· ${min}ë¶„`;
        $('#carSummaryText').textContent=`ê±°ë¦¬ ${km} km Â· ì˜ˆìƒ ${min}ë¶„`;
        $('#carSummaryBox').classList.remove('d-none');
    }

    // ------------- ì™¸ë¶€ ê¸¸ì°¾ê¸° -------------
    function openNaverDirections(mode){ // transit | walk | bicycle
        const sLL = startMarker?.getPosition() || userMarker?.getPosition() || map.getCenter();
        if(!endMarker){ toast('ë„ì°©ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”. (ì§€ë„ í´ë¦­ ë˜ëŠ” íŒ¨ë„ ì…ë ¥)'); return; }
        const gLL = endMarker.getPosition();
        const s = `${sLL.lng()},${sLL.lat()},ì¶œë°œ`;
        const g = `${gLL.lng()},${gLL.lat()},ë„ì°©`;
        window.open(`https://map.naver.com/v5/directions/${encodeURIComponent(s)}/${encodeURIComponent(g)}/${mode}`,'_blank','noopener');
    }

    // ------------- ê¸¸ì°¾ê¸° íŒ¨ë„ UI -------------
    function setupDirectionsUI(offcanvasInstance){
        let currentMode='car';
        $('#tabCar').onclick     = ()=>{ currentMode='car';     selectMode('tabCar'); };
        $('#tabTransit').onclick = ()=>{ currentMode='transit'; selectMode('tabTransit'); };
        $('#tabWalk').onclick    = ()=>{ currentMode='walk';    selectMode('tabWalk'); };
        $('#tabBike').onclick    = ()=>{ currentMode='bicycle'; selectMode('tabBike'); };

        function selectMode(id){
            ['tabCar','tabTransit','tabWalk','tabBike'].forEach(k=>$('#'+k).classList.toggle('active', k===id));
            $('#carSummaryBox').classList.toggle('d-none', id!=='tabCar');
        }

        $('#btnUseMyLoc').onclick = locateMeOnce;
        $('#btnUsePinnedEnd').onclick = ()=>{
            if(!endMarker) return toast('ì§€ë„ì—ì„œ ëª©ì ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”.');
            $('#inpEnd').value = 'ì§€ë„ í•€';
        };
        $('#btnDirReset').onclick = ()=>{
            $('#inpStart').value=''; $('#inpEnd').value=''; $('#carSummaryBox').classList.add('d-none');
        };

        $('#btnDirGo').onclick = async ()=>{
            const sText = $('#inpStart').value.trim();
            const eText = $('#inpEnd').value.trim();

            // ì¶œë°œì§€ ê²°ì •: ì…ë ¥ > startMarker > userMarker > ì§€ë„ì¤‘ì‹¬
            let sLL = null;
            if(sText){ sLL = await new Promise(r=>geocode(sText,(ll)=>r(ll))); if(!sLL) return toast('ì¶œë°œì§€ ê²€ìƒ‰ ì‹¤íŒ¨'); }
            else sLL = startMarker?.getPosition() || userMarker?.getPosition() || map.getCenter();

            // ë„ì°©ì§€ ê²°ì •: ì…ë ¥ > endMarker (í•€)
            let gLL = null;
            if(eText && eText!=='ì§€ë„ í•€'){ gLL = await new Promise(r=>geocode(eText,(ll)=>r(ll))); if(!gLL) return toast('ë„ì°©ì§€ ê²€ìƒ‰ ì‹¤íŒ¨'); }
            else if(endMarker) gLL = endMarker.getPosition();
            else return toast('ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ í´ë¦­í•´ ì£¼ì„¸ìš”.');

            if(currentMode==='car'){
                try{ await drawRouteCarWithLL(sLL,gLL); }
                catch(e){ console.error(e); toast('ìë™ì°¨ ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨'); }
            }else{
                openNaverDirections(currentMode);
            }
        };
    }

    // ------------- ë¶€íŒ… -------------
    (function wait(){ if(window.naver?.maps?.Map) boot(); else setTimeout(wait,60); })();
</script>
</body>
</html>
