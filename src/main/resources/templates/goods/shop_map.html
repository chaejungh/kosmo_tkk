<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ë”ì¿ ì¿  | ë§¤ì¥ ì§€ë„</title>

    <!-- ë„¤ì´ë²„ ì§€ë„ SDK: ì§€ì˜¤ì½”ë” í¬í•¨, ì½œë°± ì—†ì´ defer ë¡œë“œ -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ì•Œë¦¼
        window.navermap_authFailure = function () {
            alert('ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨: ì½˜ì†”ì˜ Web ì„œë¹„ìŠ¤ URL / Client IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };
    </script>

    <style>
        :root{
            --brand:#704538; --accent:#F79287; --ink:#222; --bg:#fff; --line:#e9e9e9;
        }
        html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Malgun Gothic",sans-serif}
        /* í˜ì´ì§€ ì•ˆì˜ ì§€ë„ ë°•ìŠ¤(ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì ˆ) */
        #mapWrap{position:relative;width:100%;height:540px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fafafa}
        #map{width:100%;height:100%}

        /* ì§€ë„ ë‚´ë¶€ ì»¨íŠ¸ë¡¤(ë„¤ì´ë²„ ì§€ë„ ë ˆì´ì•„ì›ƒ ëŠë‚Œ) */
        .vbar{
            display:flex;flex-direction:column;gap:8px;
            background:transparent; padding:0; margin:0;
        }
        .ctrl{
            display:flex; align-items:center; justify-content:center;
            width:38px; height:38px; border-radius:10px; background:#fff;
            border:1px solid var(--line); box-shadow:0 2px 8px rgba(0,0,0,.08);
            cursor:pointer; user-select:none;
        }
        .ctrl.on{ outline:2px solid var(--accent); }
        .ctrl span{font-size:12px}
        .chipbar{
            display:flex; gap:8px; background:#ffffffea; border:1px solid var(--line);
            padding:6px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06)
        }
        .chip{
            padding:6px 10px; border-radius:999px; border:1px solid var(--line);
            background:#fff; font-size:12px; cursor:pointer;
        }
        .chip.on{ background:var(--brand); color:#fff; border-color:var(--brand); }

        /* ì§€ë„ ìƒë‹¨ ì¤‘ì•™ ë³´ì¡° ê²€ìƒ‰ì°½(ì „ì—­ ê²€ìƒ‰ì°½ì´ ì—†ì„ ë•Œë§Œ ë³´ì„) */
        .inline-search{
            display:flex; gap:8px; align-items:center;
            background:#fff; border:1px solid var(--line); border-radius:999px;
            padding:6px 10px; width:360px; box-shadow:0 2px 10px rgba(0,0,0,.07)
        }
        .inline-search input{flex:1;border:0;outline:0;font-size:14px}
        .btn{
            padding:6px 10px; border-radius:10px; border:0; background:var(--brand); color:#fff; cursor:pointer;
        }
        .toast{position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
            background:#222; color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; display:none;}
        .panel{
            position:absolute; left:12px; bottom:12px; background:#fff; border:1px solid var(--line);
            border-radius:10px; padding:8px 10px; font-size:13px; box-shadow:0 2px 10px rgba(0,0,0,.06);
        }
    </style>
</head>
<body>

<!-- ì›í•˜ëŠ” ìœ„ì¹˜ì— ì´ ë°•ìŠ¤ë¥¼ ë„£ì–´ë‘ë©´ ë¨(ì§€ê¸ˆì€ ë‹¨ë… í˜ì´ì§€ ê¸°ì¤€) -->
<section id="mapWrap">
    <div id="map"></div>

    <!-- ìš°ì¸¡ ì„¸ë¡œ ì»¨íŠ¸ë¡¤(ë„¤ì´ë²„ ì§€ë„ ìš°ì¸¡ ë„êµ¬ëª¨ìŒ ëŠë‚Œ) -->
    <div id="rightRail" class="vbar"
         style="position:absolute; right:12px; top:50%; transform:translateY(-50%);">
        <div id="btnZoomIn"  class="ctrl" title="í™•ëŒ€">+</div>
        <div id="btnZoomOut" class="ctrl" title="ì¶•ì†Œ">âˆ’</div>
        <div id="btnLayer"   class="ctrl" title="ì¼ë°˜/ìœ„ì„± ì „í™˜"><span>ìœ„ì„±</span></div>
        <div id="btnTraffic" class="ctrl" title="êµí†µì •ë³´"><span>êµí†µ</span></div>
        <div id="btnMyLoc"   class="ctrl" title="ë‚´ ìœ„ì¹˜">â—</div>
        <div id="btnWp"      class="ctrl" title="ê²½ìœ ì§€ ëª¨ë“œ">W</div>
        <div id="btnWpClr"   class="ctrl" title="ê²½ìœ ì§€ ì´ˆê¸°í™”">C</div>
        <div id="btnRoute"   class="ctrl" title="ìë™ì°¨ ê¸¸ì°¾ê¸°">â†’</div>
        <div id="btnStatic"  class="ctrl" title="ì •ì  ì§€ë„ ì €ì¥">ğŸ–¼</div>
    </div>

    <!-- ì¢Œìƒë‹¨: ê¸°ëŠ¥ ì¹©(ì˜µì…˜ í† ê¸€ìš©) -->
    <div style="position:absolute; left:12px; top:12px;">
        <div class="chipbar">
            <button class="chip" id="chipFit">ì „ì²´ë³´ê¸°</button>
            <button class="chip" id="chipReset">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ìƒë‹¨ ì¤‘ì•™: ì „ì—­ ê²€ìƒ‰ì°½ì´ ì—†ì„ ë•Œë§Œ ë³´ì¡° ê²€ìƒ‰ì°½ ì‚¬ìš© -->
    <div id="inlineSearchWrap" style="position:absolute; left:50%; top:12px; transform:translateX(-50%); display:none;">
        <div class="inline-search">
            <input id="qMap" type="search" placeholder="ì¥ì†Œ/ì£¼ì†Œ ì…ë ¥" />
            <button id="btnMapSearch" class="btn">ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- í•˜ë‹¨: ê²½ë¡œ ìš”ì•½ -->
    <div id="summary" class="panel">ê²½ë¡œ ë¯¸ì„¤ì •</div>
    <div id="toast" class="toast"></div>
</section>

<script>
    // ====== ìœ í‹¸ ======
    const $  = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>[...root.querySelectorAll(s)];
    function toast(msg){
        const el = $('#toast'); el.textContent = msg; el.style.display='block';
        clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',1600);
    }
    const llToParam = ll => `${ll.lng()},${ll.lat()}`;

    // ====== ì „ì—­ ìƒíƒœ ======
    let map, infoWin;
    let startMarker, endMarker, userMarker, routeLine;
    let waypointMarkers = [];        // ê²½ìœ ì§€
    let waypointMode    = false;
    let trafficOn       = false;
    let isHybrid        = false;     // ì¼ë°˜/ìœ„ì„±(HYBRID) í† ê¸€

    // ë ˆì´ì–´
    let trafficLayer;

    // ====== ì§€ë„ ë¶€íŒ… ======
    function boot(){
        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665,126.9780),
            zoom: 14,
            zoomControl: false,   // ì»¤ìŠ¤í…€ ì¤Œ ì‚¬ìš©(ì˜¤ë¥¸ìª½ +/âˆ’)
            mapTypeControl: false
        });

        infoWin = new naver.maps.InfoWindow({ anchorSize: new naver.maps.Size(8,8) });
        trafficLayer = new naver.maps.TrafficLayer();

        // ì§€ë„ í´ë¦­: ê²½ìœ ì§€ ëª¨ë“œë©´ ê²½ìœ ì§€ ì¶”ê°€, ì•„ë‹ˆë©´ ë„ì°©ì§€ ì„¤ì •
        naver.maps.Event.addListener(map, 'click', e => {
            if (waypointMode) addWaypoint(e.coord);
            else setEndFromClick(e.coord);
        });

        // ìš°ì¸¡ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
        $('#btnZoomIn').onclick  = ()=> map.setZoom(map.getZoom()+1);
        $('#btnZoomOut').onclick = ()=> map.setZoom(map.getZoom()-1);

        $('#btnLayer').onclick = ()=>{
            isHybrid = !isHybrid;
            map.setMapTypeId(isHybrid ? naver.maps.MapTypeId.HYBRID : naver.maps.MapTypeId.NORMAL);
            $('#btnLayer').classList.toggle('on', isHybrid);
        };

        $('#btnTraffic').onclick = ()=>{
            trafficOn = !trafficOn;
            trafficLayer.setMap(trafficOn ? map : null);
            $('#btnTraffic').classList.toggle('on', trafficOn);
        };

        $('#btnMyLoc').onclick = locateMeOnce;

        $('#btnWp').onclick = ()=>{
            waypointMode = !waypointMode;
            $('#btnWp').classList.toggle('on', waypointMode);
            toast(waypointMode ? 'ê²½ìœ ì§€ ëª¨ë“œ ON (ì§€ë„ í´ë¦­)' : 'ê²½ìœ ì§€ ëª¨ë“œ OFF');
        };
        $('#btnWpClr').onclick = clearWaypoints;

        $('#btnRoute').onclick = drawRouteCar;
        $('#btnStatic').onclick = downloadStaticMap;

        // ì¹©
        $('#chipFit').onclick   = fitAll;
        $('#chipReset').onclick = resetAll;

        // ìƒë‹¨ ì „ì—­ ê²€ìƒ‰ì°½ ì—°ê²°(ì—†ìœ¼ë©´ ì¸ë¼ì¸ ê²€ìƒ‰ì°½ í‘œì‹œ)
        hookGlobalSearchOrInline();

        toast('ì§€ë„ ì¤€ë¹„ ì™„ë£Œ');
    }

    // ====== ì „ì—­ ê²€ìƒ‰ì°½(#q / #btnSearch) ì—°ê²° or ë³´ì¡° ê²€ìƒ‰ì°½ ======
    function hookGlobalSearchOrInline(){
        const q    = document.getElementById('q');
        const btnS = document.getElementById('btnSearch');

        const run = ()=>{
            const text = q.value.trim();
            if(!text){ toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            geocode(text, (ll,label)=>{
                if(!ll){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
                setEnd(ll, label||text);
                map.setZoom(15);
            });
        };

        if(q && btnS){
            btnS.addEventListener('click', run);
            q.addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });
        }else{
            // ì „ì—­ ê²€ìƒ‰ì°½ì´ ì—†ìœ¼ë©´ ì§€ë„ ì•ˆì— ë³´ì¡° ê²€ìƒ‰ì°½ ë…¸ì¶œ
            $('#inlineSearchWrap').style.display = 'block';
            const qi  = $('#qMap');
            const bms = $('#btnMapSearch');
            const run2 = ()=>{
                const text = qi.value.trim();
                if(!text){ toast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                geocode(text, (ll,label)=>{
                    if(!ll){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
                    setEnd(ll, label||text);
                    map.setZoom(15);
                });
            };
            bms.onclick = run2;
            qi.addEventListener('keydown', e=>{ if(e.key==='Enter') run2(); });
        }
    }

    // ====== Geocoding & Reverse ======
    function geocode(text, cb){
        naver.maps.Service.geocode({query:text}, (st,resp)=>{
            if(st!==naver.maps.Service.Status.OK || !resp?.v2?.addresses?.length) return cb(null,null);
            const a=resp.v2.addresses[0];
            const ll=new naver.maps.LatLng(parseFloat(a.y), parseFloat(a.x));
            const label=a.roadAddress || a.jibunAddress || text;
            cb(ll,label);
        });
    }
    function setEndFromClick(latlng){
        naver.maps.Service.reverseGeocode({
            coords: latlng,
            orders: [naver.maps.Service.OrderType.ROAD_ADDR, naver.maps.Service.OrderType.ADDR].join(',')
        }, (st,resp)=>{
            let label='ëª©ì ì§€';
            if(st===naver.maps.Service.Status.OK && resp?.v2?.results?.length){
                const r=resp.v2.results[0];
                label = r.roadaddress?.address || r.land?.name || label;
            }
            setEnd(latlng,label);
        });
    }

    // ====== ë§ˆì»¤ ì„¸íŒ… ======
    function setStart(latlng,label='ì¶œë°œ'){
        if(!startMarker) startMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else startMarker.setPosition(latlng);
        map.setCenter(latlng);
    }
    function setEnd(latlng,label='ë„ì°©'){
        if(!endMarker) endMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else endMarker.setPosition(latlng);
        infoWin.setContent(`<div style="padding:6px 8px;font-size:13px">${label}</div>`);
        infoWin.open(map,endMarker);
        map.setCenter(latlng);
    }

    // ====== í˜„ì¬ ìœ„ì¹˜ ======
    function locateMeOnce(){
        if(!('geolocation' in navigator)){ toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
            const ll=new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if(!userMarker){
                userMarker=new naver.maps.Marker({
                    map, position: ll, title:'ë‚´ ìœ„ì¹˜',
                    icon:{ content:'<div style="width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 0 0 2px rgba(30,136,229,.35)"></div>' }
                });
            }else userMarker.setPosition(ll);
            setStart(ll,'í˜„ì¬ ìœ„ì¹˜');
            toast('í˜„ì¬ ìœ„ì¹˜ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.');
        }, ()=>toast('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'), {enableHighAccuracy:true, timeout:15000});
    }

    // ====== ê²½ìœ ì§€ ======
    function addWaypoint(latlng){
        if(waypointMarkers.length>=15){ toast('ê²½ìœ ì§€ëŠ” ìµœëŒ€ 15ê°œ'); return; }
        const idx=waypointMarkers.length+1;
        const marker=new naver.maps.Marker({
            map, position:latlng, title:`ê²½ìœ ì§€ ${idx}`,
            icon:{ content:`<div style="width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid ${'var(--brand)'};display:flex;align-items:center;justify-content:center;font:600 12px/1 system-ui">${idx}</div>` }
        });
        waypointMarkers.push(marker);
        toast(`ê²½ìœ ì§€ ${idx} ì¶”ê°€`);
    }
    function clearWaypoints(){
        waypointMarkers.forEach(m=>m.setMap(null));
        waypointMarkers=[];
        toast('ê²½ìœ ì§€ ì´ˆê¸°í™”');
    }
    function waypointsParam(){
        return waypointMarkers.length ? waypointMarkers.map(m=>llToParam(m.getPosition())).join('|') : '';
    }

    // ====== ê²½ë¡œ(ìë™ì°¨) ======
    async function drawRouteCar(){
        // ì¶œë°œ: ì…ë ¥ > startMarker > userMarker > ì§€ë„ì¤‘ì‹¬
        let sLL = startMarker?.getPosition() || userMarker?.getPosition() || map.getCenter();
        if(!startMarker) setStart(sLL, startMarker?'ì¶œë°œ':'ì§€ë„ ì¤‘ì‹¬');

        if(!endMarker){ toast('ë„ì°©ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”. (ê²€ìƒ‰ ë˜ëŠ” ì§€ë„ í´ë¦­)'); return; }
        const gLL = endMarker.getPosition();

        const start = encodeURIComponent(llToParam(sLL));
        const goal  = encodeURIComponent(llToParam(gLL));
        const wp    = waypointsParam();

        const url = `/api/directions?start=${start}&goal=${goal}&option=traoptimal${wp?`&waypoints=${encodeURIComponent(wp)}`:''}`;

        try{
            const res = await fetch(url);
            if(!res.ok){ toast('ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨(ë°±ì—”ë“œ í™•ì¸)'); return; }
            const data = await res.json();
            const route = data?.route?.traoptimal?.[0];
            if(!route?.path?.length){ toast('ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const path = route.path.map(([x,y])=> new naver.maps.LatLng(y,x));
            if(routeLine) routeLine.setMap(null);
            routeLine = new naver.maps.Polyline({map, path, strokeWeight:6, strokeOpacity:.9, strokeColor:'#F79287'});

            const b=new naver.maps.LatLngBounds(path[0], path[0]); path.forEach(p=>b.extend(p)); map.fitBounds(b);

            const km  = (route.summary.distance/1000).toFixed(1);
            const min = Math.round(route.summary.duration/60000);
            $('#summary').textContent = `ìë™ì°¨ ê²½ë¡œ Â· ì•½ ${km}km Â· ${min}ë¶„` + (wp?` Â· ê²½ìœ ì§€ ${waypointMarkers.length}ê°œ`:``);
        }catch(e){
            console.error(e); toast('ê²½ë¡œ ìš”ì²­ ì˜¤ë¥˜');
        }
    }

    // ====== ì •ì  ì§€ë„ ì €ì¥ ======
    async function downloadStaticMap(){
        const center = llToParam(map.getCenter());
        const level  = Math.max(5, Math.min(17, map.getZoom()));
        const qp = new URLSearchParams({center, level:String(level), w:'800', h:'500'});
        try{
            const res = await fetch(`/api/staticmap?${qp.toString()}`);
            if(!res.ok){ toast('ì •ì  ì§€ë„ ìƒì„± ì‹¤íŒ¨'); return; }
            const blob = await res.blob();
            const url  = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='map.png'; a.click();
            URL.revokeObjectURL(url);
        }catch(e){ console.error(e); toast('ì •ì  ì§€ë„ ì €ì¥ ì‹¤íŒ¨'); }
    }

    // ====== ë³´ì¡° ê¸°ëŠ¥ ======
    function fitAll(){
        const items = [startMarker, endMarker, ...waypointMarkers].filter(Boolean);
        if(items.length===0){ toast('ë§ì¶œ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const b=new naver.maps.LatLngBounds(items[0].getPosition(), items[0].getPosition());
        items.forEach(m=>b.extend(m.getPosition()));
        map.fitBounds(b);
    }
    function resetAll(){
        if(routeLine){ routeLine.setMap(null); routeLine=null; }
        [startMarker, endMarker, userMarker].forEach(m=>{ if(m){ m.setMap(null);} });
        startMarker=endMarker=userMarker=null;
        clearWaypoints();
        $('#summary').textContent='ê²½ë¡œ ë¯¸ì„¤ì •';
        toast('ì´ˆê¸°í™” ì™„ë£Œ');
    }

    // ====== SDK ë¡œë“œ ëŒ€ê¸° í›„ ì‹¤í–‰ ======
    (function waitReady(){
        if(window.naver?.maps?.Map) boot();
        else setTimeout(waitReady, 60);
    })();
</script>
</body>
</html>
G