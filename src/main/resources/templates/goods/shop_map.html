<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ë”ì¿ ì¿  | ë§¤ì¥ ì§€ë„</title>

    <!-- ë„¤ì´ë²„ ì§€ë„ SDK (ì§€ì˜¤ì½”ë” í¬í•¨) -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        window.navermap_authFailure = function () {
            alert('ë„¤ì´ë²„ ì§€ë„ ì¸ì¦ ì‹¤íŒ¨: Web ì„œë¹„ìŠ¤ URL / Client IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };
    </script>

    <style>
        :root{ --brand:#704538; --accent:#F79287; --line:#e9e9e9; }
        html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Malgun Gothic",sans-serif}
        #mapWrap{position:relative;width:100%;height:540px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fafafa}
        #map{width:100%;height:100%}

        /* Fullscreen fallback (iOS ë“±) */
        #mapWrap.fs{ position:fixed; inset:0; width:100vw; height:100vh; z-index:9999; border-radius:0 }
        body.no-scroll{ overflow:hidden }

        .vbar{display:flex;flex-direction:column;gap:8px}
        .ctrl{
            display:flex;align-items:center;justify-content:center; width:38px;height:38px;
            border-radius:10px;background:#fff;border:1px solid var(--line);
            box-shadow:0 2px 8px rgba(0,0,0,.08); cursor:pointer; user-select:none;
        }
        .ctrl.on{ outline:2px solid var(--accent) }
        .ctrl span{ font-size:12px }

        .toast{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);
            background:#222;color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;display:none}
        .panel{position:absolute;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);
            border-radius:10px;padding:8px 10px;font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    </style>
</head>
<body>
<section id="mapWrap">
    <div id="map"></div>

    <!-- ì˜¤ë¥¸ìª½ ì„¸ë¡œ íˆ´ë°” -->
    <div class="vbar" style="position:absolute; right:12px; top:50%; transform:translateY(-50%);">
        <div id="btnZoomIn"  class="ctrl" title="í™•ëŒ€">+</div>
        <div id="btnZoomOut" class="ctrl" title="ì¶•ì†Œ">âˆ’</div>

        <!-- êµì²´ëœ 3ê°œ: ì „ì²´ë³´ê¸° / ëŒ€ì¤‘êµí†µ / ë„ë³´ -->
        <div id="btnFit"     class="ctrl" title="ì „ì²´ë³´ê¸°(ì „ì²´í™”ë©´ í† ê¸€)"><span>â–¡</span></div>
        <div id="btnTransit" class="ctrl" title="ëŒ€ì¤‘êµí†µ ê¸¸ì°¾ê¸°">ğŸš‡</div>
        <div id="btnWalk"    class="ctrl" title="ë„ë³´ ê¸¸ì°¾ê¸°">ğŸš¶</div>

        <!-- ê¸°ì¡´ ìœ ì§€ -->
        <div id="btnMyLoc"   class="ctrl" title="ë‚´ ìœ„ì¹˜">â—</div>
        <div id="btnWp"      class="ctrl" title="ê²½ìœ ì§€ ëª¨ë“œ">W</div>
        <div id="btnWpClr"   class="ctrl" title="ê²½ìœ ì§€ ì´ˆê¸°í™”">C</div>
        <div id="btnRoute"   class="ctrl" title="ìë™ì°¨ ê¸¸ì°¾ê¸°">â†’</div>
    </div>

    <div id="summary" class="panel">ê²½ë¡œ ë¯¸ì„¤ì •</div>
    <div id="toast" class="toast"></div>
</section>

<script>
    // ===== ìœ í‹¸ =====
    const $=(s,root=document)=>root.querySelector(s);
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',1600); }
    const llToParam = ll => `${ll.lng()},${ll.lat()}`;

    // ===== ìƒíƒœ =====
    let map, infoWin, startMarker, endMarker, userMarker, routeLine;
    let waypointMarkers=[], waypointMode=false;

    // ===== ì§€ë„ ì´ˆê¸°í™” =====
    function boot(){
        map = new naver.maps.Map('map', {
            center:new naver.maps.LatLng(37.5665,126.9780),
            zoom:14, zoomControl:false, mapTypeControl:false
        });
        infoWin = new naver.maps.InfoWindow({anchorSize:new naver.maps.Size(8,8)});

        naver.maps.Event.addListener(map,'click',e=>{
            if(waypointMode) addWaypoint(e.coord); else setEndFromClick(e.coord);
        });

        // í™•ëŒ€/ì¶•ì†Œ
        $('#btnZoomIn').onclick  = ()=>map.setZoom(map.getZoom()+1);
        $('#btnZoomOut').onclick = ()=>map.setZoom(map.getZoom()-1);

        // â¬‡ï¸ ì „ì²´ë³´ê¸° = Fullscreen í† ê¸€
        $('#btnFit').onclick = toggleFullscreen;
        document.addEventListener('fullscreenchange', syncFsButtonAndResize);
        document.addEventListener('webkitfullscreenchange', syncFsButtonAndResize); // Safari

        // ëŒ€ì¤‘êµí†µ/ë„ë³´ ì™¸ë¶€ ê¸¸ì°¾ê¸°
        $('#btnTransit').onclick = ()=>openNaverDirections('transit');
        $('#btnWalk').onclick    = ()=>openNaverDirections('walk');

        // ë‚˜ë¨¸ì§€ ìœ ì§€
        $('#btnMyLoc').onclick = locateMeOnce;
        $('#btnWp').onclick = ()=>{
            waypointMode=!waypointMode; $('#btnWp').classList.toggle('on', waypointMode);
            toast(waypointMode?'ê²½ìœ ì§€ ëª¨ë“œ ON (ì§€ë„ í´ë¦­)':'ê²½ìœ ì§€ ëª¨ë“œ OFF');
        };
        $('#btnWpClr').onclick = clearWaypoints;
        $('#btnRoute').onclick = drawRouteCar;

        toast('ì§€ë„ ì¤€ë¹„ ì™„ë£Œ');
    }

    // ===== Fullscreen êµ¬í˜„ =====
    const wrap = document.getElementById('mapWrap');

    function isFs(){
        return !!(document.fullscreenElement || document.webkitFullscreenElement) || wrap.classList.contains('fs');
    }
    async function enterFs(){
        try{
            if(wrap.requestFullscreen) await wrap.requestFullscreen();
            else if(wrap.webkitRequestFullscreen) wrap.webkitRequestFullscreen(); // Safari
            else{ wrap.classList.add('fs'); document.body.classList.add('no-scroll'); }
        }finally{
            setTimeout(()=>naver.maps.Event.trigger(map,'resize'), 100);
        }
    }
    function exitFs(){
        try{
            if(document.exitFullscreen) document.exitFullscreen();
            else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
            wrap.classList.remove('fs'); document.body.classList.remove('no-scroll');
        }finally{
            setTimeout(()=>naver.maps.Event.trigger(map,'resize'), 100);
        }
    }
    function toggleFullscreen(){ isFs()? exitFs() : enterFs(); }
    function syncFsButtonAndResize(){
        $('#btnFit').classList.toggle('on', isFs());
        setTimeout(()=>naver.maps.Event.trigger(map,'resize'), 50);
    }

    // ===== Geocoding / Reverse =====
    function geocode(text,cb){
        naver.maps.Service.geocode({query:text},(st,resp)=>{
            if(st!==naver.maps.Service.Status.OK||!resp?.v2?.addresses?.length) return cb(null,null);
            const a=resp.v2.addresses[0];
            cb(new naver.maps.LatLng(parseFloat(a.y),parseFloat(a.x)), a.roadAddress||a.jibunAddress||text);
        });
    }
    function setEndFromClick(latlng){
        naver.maps.Service.reverseGeocode({
            coords:latlng, orders:[naver.maps.Service.OrderType.ROAD_ADDR, naver.maps.Service.OrderType.ADDR].join(',')
        },(st,resp)=>{
            let label='ëª©ì ì§€';
            if(st===naver.maps.Service.Status.OK&&resp?.v2?.results?.length){
                const r=resp.v2.results[0]; label=r.roadaddress?.address||r.land?.name||label;
            }
            setEnd(latlng,label);
        });
    }

    // ===== ë§ˆì»¤ =====
    function setStart(latlng,label='ì¶œë°œ'){
        if(!startMarker) startMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else startMarker.setPosition(latlng);
        map.setCenter(latlng);
    }
    function setEnd(latlng,label='ë„ì°©'){
        if(!endMarker) endMarker=new naver.maps.Marker({map,position:latlng,title:label});
        else endMarker.setPosition(latlng);
        infoWin.setContent(`<div style="padding:6px 8px;font-size:13px">${label}</div>`);
        infoWin.open(map,endMarker); map.setCenter(latlng);
    }

    // ===== í˜„ì¬ ìœ„ì¹˜ =====
    function locateMeOnce(){
        if(!('geolocation' in navigator)) return toast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        navigator.geolocation.getCurrentPosition(pos=>{
            const ll=new naver.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
            if(!userMarker){
                userMarker=new naver.maps.Marker({
                    map,position:ll,title:'ë‚´ ìœ„ì¹˜',
                    icon:{content:'<div style="width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 0 0 2px rgba(30,136,229,.35)"></div>'}
                });
            }else userMarker.setPosition(ll);
            setStart(ll,'í˜„ì¬ ìœ„ì¹˜');
        },()=>toast('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'),{enableHighAccuracy:true,timeout:15000});
    }

    // ===== ê²½ìœ ì§€ =====
    function addWaypoint(latlng){
        if(waypointMarkers.length>=15) return toast('ê²½ìœ ì§€ëŠ” ìµœëŒ€ 15ê°œ');
        const idx=waypointMarkers.length+1;
        waypointMarkers.push(
            new naver.maps.Marker({
                map, position:latlng, title:`ê²½ìœ ì§€ ${idx}`,
                icon:{content:`<div style="width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;font:600 12px/1 system-ui">${idx}</div>`}
            })
        );
        toast(`ê²½ìœ ì§€ ${idx} ì¶”ê°€`);
    }
    function clearWaypoints(){ waypointMarkers.forEach(m=>m.setMap(null)); waypointMarkers=[]; toast('ê²½ìœ ì§€ ì´ˆê¸°í™”'); }
    const waypointsParam = () => waypointMarkers.length ? waypointMarkers.map(m=>llToParam(m.getPosition())).join('|') : '';

    // ===== ìë™ì°¨ ê²½ë¡œ(ë‚´ë¶€) =====
    async function drawRouteCar(){
        let sLL = startMarker?.getPosition() || userMarker?.getPosition() || map.getCenter();
        if(!startMarker) setStart(sLL,'ì§€ë„ ì¤‘ì‹¬');
        if(!endMarker) return toast('ë„ì°©ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”.');

        const start=encodeURIComponent(llToParam(sLL));
        const goal =encodeURIComponent(llToParam(endMarker.getPosition()));
        const wp   =waypointsParam();

        const url=`/api/directions?start=${start}&goal=${goal}&option=traoptimal${wp?`&waypoints=${encodeURIComponent(wp)}`:''}`;
        try{
            const res=await fetch(url); if(!res.ok) return toast('ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨');
            const data=await res.json(); const route=data?.route?.traoptimal?.[0];
            if(!route?.path?.length) return toast('ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');
            const path=route.path.map(([x,y])=>new naver.maps.LatLng(y,x));
            if(routeLine) routeLine.setMap(null);
            routeLine=new naver.maps.Polyline({map,path,strokeWeight:6,strokeOpacity:.9,strokeColor:'#F79287'});
            const b=new naver.maps.LatLngBounds(path[0],path[0]); path.forEach(p=>b.extend(p)); map.fitBounds(b);
            const km=(route.summary.distance/1000).toFixed(1), min=Math.round(route.summary.duration/60000);
            $('#summary').textContent=`ìë™ì°¨ ê²½ë¡œ Â· ì•½ ${km}km Â· ${min}ë¶„`+(wp?` Â· ê²½ìœ ì§€ ${waypointMarkers.length}ê°œ`:``);
        }catch(e){ console.error(e); toast('ê²½ë¡œ ìš”ì²­ ì˜¤ë¥˜'); }
    }

    // ===== ì™¸ë¶€ ê¸¸ì°¾ê¸°(ëŒ€ì¤‘êµí†µ/ë„ë³´) =====
    function openNaverDirections(mode){ // 'transit' | 'walk'
        let sLL = startMarker?.getPosition() || userMarker?.getPosition() || map.getCenter();
        if(!endMarker) return toast('ë„ì°©ì§€ë¥¼ ë¨¼ì € ì§€ì •í•˜ì„¸ìš”.');
        const gLL = endMarker.getPosition();

        const s = `${sLL.lng()},${sLL.lat()},ì¶œë°œ`;
        const g = `${gLL.lng()},${gLL.lat()},ë„ì°©`;
        window.open(`https://map.naver.com/v5/directions/${encodeURIComponent(s)}/${encodeURIComponent(g)}/${mode}`,'_blank','noopener');
    }

    (function wait(){ if(window.naver?.maps?.Map) boot(); else setTimeout(wait,60); })();
</script>
</body>
</html>
