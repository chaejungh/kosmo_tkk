<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>더쿠쿠 | 매장 지도</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="referrer" content="unsafe-url" />

    <style>
        html, body { margin:0; height:100%; font-family:system-ui, -apple-system, "Malgun Gothic", sans-serif; }
        .map-wrap { position:relative; }
        #map { width:100%; height:420px; }
        .ctrl-stack {
            position:absolute; right:12px; top:12px; display:flex; flex-direction:column; gap:8px; z-index:10;
        }
        .ctrl-stack .btn {
            padding:8px 10px; border:0; border-radius:10px;
            background:#704538; color:#fff; cursor:pointer; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,.08);
            white-space:nowrap;
        }
        .ctrl-stack .btn.ghost { background:#eee; color:#333; }
        .panel {
            position:fixed; left:12px; bottom:12px; background:#fff; border:1px solid #eee;
            border-radius:10px; padding:8px 10px; font-size:13px; box-shadow:0 2px 10px rgba(0,0,0,.06); z-index:10;
        }
        .toast {
            position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
            background:#222; color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; display:none; z-index:9999;
        }
    </style>

    <!-- 네이버 지도 SDK (지오코더 포함). 반드시 ncpKeyId 사용 -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8ehod4l0bq&submodules=geocoder" defer></script>
    <script>
        // 인증 실패시 알림(선택)
        window.navermap_authFailure = function () {
            alert('네이버 지도 인증 실패: NCP 콘솔의 Web 서비스 URL/Key/경로를 확인하세요.');
        };
    </script>
</head>
<body>

<!-- 지도 + 지도 내부 컨트롤(오버레이) -->
<div class="map-wrap">
    <div id="map"></div>

    <!-- 네이버 지도처럼 지도 내부에 쌓이는 버튼들 -->
    <div class="ctrl-stack">
        <button id="cMyLoc"   class="btn ghost">현재 위치</button>
        <button id="cWpMode"  class="btn ghost">경유지 모드 Off</button>
        <button id="cWpClear" class="btn ghost">경유지 초기화</button>
        <button id="cRoute"   class="btn">자동차 길찾기</button>
        <button id="cStatic"  class="btn ghost">정적 지도 저장</button>
    </div>
</div>

<div id="summary" class="panel">경로 미설정</div>
<div id="toast" class="toast"></div>

<script>
    /* ===== 유틸 ===== */
    const $ = s => document.querySelector(s);
    function toast(msg){
        const el = $('#toast');
        el.textContent = msg; el.style.display = 'block';
        clearTimeout(el._t); el._t = setTimeout(()=> el.style.display='none', 1600);
    }
    function llToParam(ll){ return `${ll.lng()},${ll.lat()}`; }

    /* ===== 전역 상태 ===== */
    let map, infoWin;
    let startMarker, endMarker, userMarker, routeLine;
    let waypointMarkers = [];
    let waypointMode = false;
    const WAYPOINT_LIMIT = 15;

    /* ===== 지도/이벤트 초기화 ===== */
    function boot(){
        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665,126.9780),
            zoom: 14,
            zoomControl: true,
            zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT }
        });
        infoWin = new naver.maps.InfoWindow({ anchorSize: new naver.maps.Size(8,8) });

        // 지도 클릭: 경유지 모드면 경유지 추가, 아니면 리버스 지오코딩으로 도착지
        naver.maps.Event.addListener(map, 'click', (e)=>{
            if (waypointMode) addWaypoint(e.coord);
            else setEndFromClick(e.coord);
        });

        /* 상단 전역 검색창 연동 (#q / #btnSearch) */
        const topQ = document.querySelector('#q');
        const topBtn = document.querySelector('#btnSearch');
        function useTopSearch(){
            const text = topQ.value.trim();
            if (!text){ toast('검색어를 입력하세요.'); return; }
            geocode(text, (ll,label)=>{
                if (!ll){ toast('검색 결과가 없습니다.'); return; }
                setEnd(ll, label || text);
            });
        }
        if (topQ){
            topBtn?.addEventListener('click', useTopSearch);
            topQ.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter') useTopSearch(); });
        }

        /* 지도 내부 버튼들 */
        $('#cMyLoc').addEventListener('click', locateMeOnce);
        $('#cWpMode').addEventListener('click', ()=>{
            waypointMode = !waypointMode;
            $('#cWpMode').textContent = `경유지 모드 ${waypointMode ? 'On' : 'Off'}`;
            toast(waypointMode ? '지도 클릭 시 경유지 추가' : '경유지 모드 해제');
        });
        $('#cWpClear').addEventListener('click', clearWaypoints);
        $('#cRoute').addEventListener('click', drawRouteCar);
        $('#cStatic').addEventListener('click', downloadStaticMap);
    }

    /* ===== 지오코딩/리버스 ===== */
    function geocode(text, cb){
        if (!text) return cb(null,null);
        naver.maps.Service.geocode({ query:text }, (status, resp)=>{
            if (status!==naver.maps.Service.Status.OK || !resp?.v2?.addresses?.length) return cb(null,null);
            const a = resp.v2.addresses[0];
            const label = a.roadAddress || a.jibunAddress || text;
            cb(new naver.maps.LatLng(parseFloat(a.y), parseFloat(a.x)), label);
        });
    }
    function setEndFromClick(latlng){
        naver.maps.Service.reverseGeocode({
            coords: latlng,
            orders: [naver.maps.Service.OrderType.ROAD_ADDR, naver.maps.Service.OrderType.ADDR].join(',')
        }, (status, resp)=>{
            let label = '목적지';
            if (status===naver.maps.Service.Status.OK && resp?.v2?.results?.length){
                const r = resp.v2.results[0];
                label = r.roadaddress?.address || r.land?.name || label;
            }
            setEnd(latlng, label);
        });
    }

    /* ===== 마커 세팅 ===== */
    function setStart(latlng, label='출발'){
        if(!startMarker) startMarker = new naver.maps.Marker({ map, position: latlng, title: label });
        else startMarker.setPosition(latlng);
        map.setCenter(latlng);
    }
    function setEnd(latlng, label='도착'){
        if(!endMarker) endMarker = new naver.maps.Marker({ map, position: latlng, title: label });
        else endMarker.setPosition(latlng);
        infoWin.setContent(`<div style="padding:6px 8px;font-size:13px;max-width:240px">${label}</div>`);
        infoWin.open(map, endMarker);
        map.setCenter(latlng);
    }

    /* ===== 현재 위치 ===== */
    function locateMeOnce(){
        if (!('geolocation' in navigator)){ toast('이 브라우저는 위치를 지원하지 않습니다.'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
            const ll = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if (!userMarker){
                userMarker = new naver.maps.Marker({
                    map, position: ll, title:'내 위치',
                    icon:{ content:'<div style="width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 0 0 2px rgba(30,136,229,.35)"></div>' }
                });
            } else userMarker.setPosition(ll);
            setStart(ll, '현재 위치');
            toast('현재 위치를 표시했습니다.');
        }, ()=>toast('위치 권한이 필요합니다.'), { enableHighAccuracy:true, timeout:15000 });
    }

    /* ===== 경유지 ===== */
    function addWaypoint(latlng){
        if (waypointMarkers.length >= WAYPOINT_LIMIT){ toast(`경유지는 최대 ${WAYPOINT_LIMIT}개`); return; }
        const idx = waypointMarkers.length + 1;
        const marker = new naver.maps.Marker({
            map, position: latlng, title:`경유지 ${idx}`,
            icon:{ content:`<div style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#704538;color:#fff;font-size:11px">${idx}</div>` }
        });
        waypointMarkers.push(marker);
    }
    function clearWaypoints(){
        waypointMarkers.forEach(m=>m.setMap(null));
        waypointMarkers = [];
        toast('경유지 초기화');
    }
    function waypointsParam(){
        return waypointMarkers.length ? waypointMarkers.map(m=>llToParam(m.getPosition())).join('|') : '';
    }

    /* ===== 자동차 길찾기 (프록시 사용) ===== */
    async function drawRouteCar(){
        const topQ = document.querySelector('#q');
        const qStartText = topQ ? topQ.value.trim() : '';

        // 출발지: (입력) > startMarker > userMarker > 지도중심
        let sLL = null;
        if (qStartText){
            sLL = await new Promise(res=> geocode(qStartText, ll=>res(ll)));
            if (!sLL){ toast('출발지 검색 결과가 없습니다.'); return; }
            setStart(sLL, qStartText);
        } else if (startMarker) sLL = startMarker.getPosition();
        else if (userMarker)  sLL = userMarker.getPosition();
        else { sLL = map.getCenter(); setStart(sLL, '지도 중심'); }

        if (!endMarker){ toast('도착지를 먼저 지정하세요. (전역 검색창으로 검색 또는 지도 클릭)'); return; }

        const start = encodeURIComponent(llToParam(sLL));
        const goal  = encodeURIComponent(llToParam(endMarker.getPosition()));
        const wp    = waypointsParam();
        const url   = `/api/directions?start=${start}&goal=${goal}&option=traoptimal${wp?`&waypoints=${encodeURIComponent(wp)}`:''}`;

        try{
            const res = await fetch(url);
            if (!res.ok){ toast('경로 요청 실패(백엔드 확인)'); return; }
            const data  = await res.json();
            const route = data?.route?.traoptimal?.[0];
            if (!route?.path?.length){ toast('경로가 없습니다.'); return; }

            const path = route.path.map(([x,y]) => new naver.maps.LatLng(y, x));
            if (routeLine) routeLine.setMap(null);
            routeLine = new naver.maps.Polyline({ map, path, strokeWeight:6, strokeOpacity:.9, strokeColor:'#F79287' });

            const bounds = new naver.maps.LatLngBounds(path[0], path[0]);
            path.forEach(p => bounds.extend(p)); map.fitBounds(bounds);

            const km  = (route.summary.distance/1000).toFixed(1);
            const min = Math.round(route.summary.duration/60000);
            $('#summary').textContent = `자동차 경로 · 약 ${km}km · ${min}분${wp?` · 경유지 ${waypointMarkers.length}개`:''}`;
        }catch(e){
            console.error(e); toast('경로 요청 중 오류');
        }
    }

    /* ===== 정적 지도 저장 (프록시 사용) ===== */
    async function downloadStaticMap(){
        const center = llToParam(map.getCenter());
        const level  = Math.max(5, Math.min(17, map.getZoom()));
        const qp = new URLSearchParams({ center, level:String(level), w:'800', h:'500' });

        // 마커(출발/도착 + 경유지 일부)
        const markers = [];
        if (startMarker){ const p=startMarker.getPosition(); markers.push(`type:d|size:mid|pos:${p.lng()}%20${p.lat()}`); }
        if (endMarker){   const p=endMarker.getPosition();   markers.push(`type:d|size:mid|color:red|pos:${p.lng()}%20${p.lat()}`); }
        waypointMarkers.slice(0,5).forEach(m=>{ const p=m.getPosition(); markers.push(`type:d|size:small|color:green|pos:${p.lng()}%20${p.lat()}`); });
        markers.forEach(m => qp.append('markers', m));

        try{
            const res  = await fetch(`/api/staticmap?${qp.toString()}`);
            if (!res.ok){ toast('정적 지도 생성 실패'); return; }
            const blob = await res.blob();
            const url  = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'map.png'; a.click();
            URL.revokeObjectURL(url);
        }catch(e){
            console.error(e); toast('정적 지도 저장 실패');
        }
    }

    // SDK 로드 완료 대기 후 초기화
    (function wait(){ if (window.naver?.maps?.Map) boot(); else setTimeout(wait, 60); })();
</script>

</body>
</html>
